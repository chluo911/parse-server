{"version":3,"sources":["../../src/Controllers/SchemaController.js"],"names":["Parse","require","defaultColumns","Object","freeze","_Default","objectId","type","createdAt","updatedAt","ACL","_User","username","password","email","emailVerified","authData","_Installation","installationId","deviceToken","channels","deviceType","pushType","GCMSenderId","timeZone","localeIdentifier","badge","appVersion","appName","appIdentifier","parseVersion","_Role","name","users","targetClass","roles","_Session","user","sessionToken","expiresAt","createdWith","_Product","productIdentifier","download","downloadName","icon","order","title","subtitle","_PushStatus","pushTime","source","query","payload","expiry","expiration_interval","status","numSent","numFailed","pushHash","errorMessage","sentPerType","failedPerType","sentPerUTCOffset","failedPerUTCOffset","count","_JobStatus","jobName","message","params","finishedAt","_JobSchedule","description","startAfter","daysOfWeek","timeOfDay","lastRun","repeatMinutes","_Hooks","functionName","className","triggerName","url","_GlobalConfig","masterKeyOnly","_GraphQLConfig","config","_Audience","lastUsed","timesUsed","_Idempotency","reqId","expire","requiredColumns","invalidColumns","systemClasses","volatileClasses","roleRegex","protectedFieldsPointerRegex","publicRegex","authenticatedRegex","requiresAuthenticationRegex","clpPointerRegex","protectedFieldsRegex","clpFieldsRegex","validatePermissionKey","key","userIdRegExp","matchesSome","regEx","match","valid","Error","INVALID_JSON","validateProtectedFieldsKey","CLPValidKeys","validateCLP","perms","fields","operationKey","indexOf","operation","validateCLPjson","fieldName","validatePointerPermission","entity","protectedFields","Array","isArray","field","prototype","hasOwnProperty","call","pointerFields","pointerField","permit","joinClassRegex","classAndFieldRegex","classNameIsValid","test","fieldNameIsValid","includes","fieldNameIsValidForClass","invalidClassNameMessage","invalidJsonError","validNonRelationOrPointerTypes","fieldTypeIsInvalid","INVALID_CLASS_NAME","undefined","INCORRECT_TYPE","convertSchemaToAdapterSchema","schema","injectDefaultSchema","_rperm","_wperm","_hashed_password","convertAdapterSchemaToParseSchema","indexes","keys","length","SchemaData","constructor","allSchemas","__data","__protectedFields","forEach","defineProperty","get","data","classLevelPermissions","classProtectedFields","unq","Set","from","defaultSchema","_HooksSchema","_GlobalConfigSchema","_GraphQLConfigSchema","_PushStatusSchema","_JobStatusSchema","_JobScheduleSchema","_AudienceSchema","_IdempotencySchema","VolatileClassesSchemas","dbTypeMatchesObjectType","dbType","objectType","typeToString","SchemaController","databaseAdapter","_dbAdapter","schemaData","SchemaCache","all","Config","applicationId","customIds","allowCustomObjectId","customIdRegEx","autoIdRegEx","userIdRegEx","watch","reloadData","clearCache","options","reloadDataPromise","getAllClasses","then","err","setAllClasses","cached","Promise","resolve","map","put","getOneSchema","allowVolatileClasses","clear","oneSchema","find","reject","addClassIfNotExists","validationError","validateNewClass","code","error","adapterSchema","createClass","parseSchema","DUPLICATE_VALUE","updateClass","submittedFields","database","existingFields","__op","newSchema","buildMergedSchemaObject","defaultFields","fullNewSchema","assign","validateSchemaData","deletedFields","insertedFields","push","deletePromise","deleteFields","enforceFields","promises","enforceFieldExists","results","filter","result","setPermissions","setIndexesWithSchemaFormat","ensureFields","reloadedSchema","catch","enforceClassExists","existingFieldNames","INVALID_KEY_NAME","fieldType","defaultValue","defaultValueType","getType","required","geoPoints","setClassLevelPermissions","isValidation","split","expectedType","getExpectedType","JSON","stringify","updateFieldOptions","addFieldIfNotExists","i","deleteField","fieldNames","schemaFields","adapter","deleteClass","validateObject","object","geocount","expected","promise","thenValidateRequiredColumns","validateRequiredColumns","columns","missingColumns","column","testPermissionsForClassName","aclGroup","testPermissions","getClassLevelPermissions","classPermissions","some","acl","validatePermission","action","OBJECT_NOT_FOUND","permissionField","OPERATION_FORBIDDEN","hasClass","load","dbAdapter","putRequest","sysSchemaField","_id","oldField","fieldIsDeleted","newField","schemaPromise","obj","getObjectType","__type","iso","latitude","longitude","base64","coordinates","objects","ops"],"mappings":"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","sourcesContent":["// @flow\n// This class handles schema validation, persistence, and modification.\n//\n// Each individual Schema object should be immutable. The helpers to\n// do things with the Schema just return a new schema when the schema\n// is changed.\n//\n// The canonical place to store this Schema is in the database itself,\n// in a _SCHEMA collection. This is not the right way to do it for an\n// open source framework, but it's backward compatible, so we're\n// keeping it this way for now.\n//\n// In API-handling code, you should only use the Schema class via the\n// DatabaseController. This will let us replace the schema logic for\n// different databases.\n// TODO: hide all schema logic inside the database adapter.\n// @flow-disable-next\nconst Parse = require('parse/node').Parse;\nimport { StorageAdapter } from '../Adapters/Storage/StorageAdapter';\nimport SchemaCache from '../Adapters/Cache/SchemaCache';\nimport DatabaseController from './DatabaseController';\nimport Config from '../Config';\n// @flow-disable-next\nimport deepcopy from 'deepcopy';\nimport type {\n  Schema,\n  SchemaFields,\n  ClassLevelPermissions,\n  SchemaField,\n  LoadSchemaOptions,\n} from './types';\n\nconst defaultColumns: { [string]: SchemaFields } = Object.freeze({\n  // Contain the default columns for every parse object type (except _Join collection)\n  _Default: {\n    objectId: { type: 'String' },\n    createdAt: { type: 'Date' },\n    updatedAt: { type: 'Date' },\n    ACL: { type: 'ACL' },\n  },\n  // The additional default columns for the _User collection (in addition to DefaultCols)\n  _User: {\n    username: { type: 'String' },\n    password: { type: 'String' },\n    email: { type: 'String' },\n    emailVerified: { type: 'Boolean' },\n    authData: { type: 'Object' },\n  },\n  // The additional default columns for the _Installation collection (in addition to DefaultCols)\n  _Installation: {\n    installationId: { type: 'String' },\n    deviceToken: { type: 'String' },\n    channels: { type: 'Array' },\n    deviceType: { type: 'String' },\n    pushType: { type: 'String' },\n    GCMSenderId: { type: 'String' },\n    timeZone: { type: 'String' },\n    localeIdentifier: { type: 'String' },\n    badge: { type: 'Number' },\n    appVersion: { type: 'String' },\n    appName: { type: 'String' },\n    appIdentifier: { type: 'String' },\n    parseVersion: { type: 'String' },\n  },\n  // The additional default columns for the _Role collection (in addition to DefaultCols)\n  _Role: {\n    name: { type: 'String' },\n    users: { type: 'Relation', targetClass: '_User' },\n    roles: { type: 'Relation', targetClass: '_Role' },\n  },\n  // The additional default columns for the _Session collection (in addition to DefaultCols)\n  _Session: {\n    user: { type: 'Pointer', targetClass: '_User' },\n    installationId: { type: 'String' },\n    sessionToken: { type: 'String' },\n    expiresAt: { type: 'Date' },\n    createdWith: { type: 'Object' },\n  },\n  _Product: {\n    productIdentifier: { type: 'String' },\n    download: { type: 'File' },\n    downloadName: { type: 'String' },\n    icon: { type: 'File' },\n    order: { type: 'Number' },\n    title: { type: 'String' },\n    subtitle: { type: 'String' },\n  },\n  _PushStatus: {\n    pushTime: { type: 'String' },\n    source: { type: 'String' }, // rest or webui\n    query: { type: 'String' }, // the stringified JSON query\n    payload: { type: 'String' }, // the stringified JSON payload,\n    title: { type: 'String' },\n    expiry: { type: 'Number' },\n    expiration_interval: { type: 'Number' },\n    status: { type: 'String' },\n    numSent: { type: 'Number' },\n    numFailed: { type: 'Number' },\n    pushHash: { type: 'String' },\n    errorMessage: { type: 'Object' },\n    sentPerType: { type: 'Object' },\n    failedPerType: { type: 'Object' },\n    sentPerUTCOffset: { type: 'Object' },\n    failedPerUTCOffset: { type: 'Object' },\n    count: { type: 'Number' }, // tracks # of batches queued and pending\n  },\n  _JobStatus: {\n    jobName: { type: 'String' },\n    source: { type: 'String' },\n    status: { type: 'String' },\n    message: { type: 'String' },\n    params: { type: 'Object' }, // params received when calling the job\n    finishedAt: { type: 'Date' },\n  },\n  _JobSchedule: {\n    jobName: { type: 'String' },\n    description: { type: 'String' },\n    params: { type: 'String' },\n    startAfter: { type: 'String' },\n    daysOfWeek: { type: 'Array' },\n    timeOfDay: { type: 'String' },\n    lastRun: { type: 'Number' },\n    repeatMinutes: { type: 'Number' },\n  },\n  _Hooks: {\n    functionName: { type: 'String' },\n    className: { type: 'String' },\n    triggerName: { type: 'String' },\n    url: { type: 'String' },\n  },\n  _GlobalConfig: {\n    objectId: { type: 'String' },\n    params: { type: 'Object' },\n    masterKeyOnly: { type: 'Object' },\n  },\n  _GraphQLConfig: {\n    objectId: { type: 'String' },\n    config: { type: 'Object' },\n  },\n  _Audience: {\n    objectId: { type: 'String' },\n    name: { type: 'String' },\n    query: { type: 'String' }, //storing query as JSON string to prevent \"Nested keys should not contain the '$' or '.' characters\" error\n    lastUsed: { type: 'Date' },\n    timesUsed: { type: 'Number' },\n  },\n  _Idempotency: {\n    reqId: { type: 'String' },\n    expire: { type: 'Date' },\n  },\n});\n\nconst requiredColumns = Object.freeze({\n  _Product: ['productIdentifier', 'icon', 'order', 'title', 'subtitle'],\n  _Role: ['name', 'ACL'],\n});\n\nconst invalidColumns = ['length'];\n\nconst systemClasses = Object.freeze([\n  '_User',\n  '_Installation',\n  '_Role',\n  '_Session',\n  '_Product',\n  '_PushStatus',\n  '_JobStatus',\n  '_JobSchedule',\n  '_Audience',\n  '_Idempotency',\n]);\n\nconst volatileClasses = Object.freeze([\n  '_JobStatus',\n  '_PushStatus',\n  '_Hooks',\n  '_GlobalConfig',\n  '_GraphQLConfig',\n  '_JobSchedule',\n  '_Audience',\n  '_Idempotency',\n]);\n\n// Anything that start with role\nconst roleRegex = /^role:.*/;\n// Anything that starts with userField (allowed for protected fields only)\nconst protectedFieldsPointerRegex = /^userField:.*/;\n// * permission\nconst publicRegex = /^\\*$/;\n\nconst authenticatedRegex = /^authenticated$/;\n\nconst requiresAuthenticationRegex = /^requiresAuthentication$/;\n\nconst clpPointerRegex = /^pointerFields$/;\n\n// regex for validating entities in protectedFields object\nconst protectedFieldsRegex = Object.freeze([\n  protectedFieldsPointerRegex,\n  publicRegex,\n  authenticatedRegex,\n  roleRegex,\n]);\n\n// clp regex\nconst clpFieldsRegex = Object.freeze([\n  clpPointerRegex,\n  publicRegex,\n  requiresAuthenticationRegex,\n  roleRegex,\n]);\n\nfunction validatePermissionKey(key, userIdRegExp) {\n  let matchesSome = false;\n  for (const regEx of clpFieldsRegex) {\n    if (key.match(regEx) !== null) {\n      matchesSome = true;\n      break;\n    }\n  }\n\n  // userId depends on startup options so it's dynamic\n  const valid = matchesSome || key.match(userIdRegExp) !== null;\n  if (!valid) {\n    throw new Parse.Error(\n      Parse.Error.INVALID_JSON,\n      `'${key}' is not a valid key for class level permissions`\n    );\n  }\n}\n\nfunction validateProtectedFieldsKey(key, userIdRegExp) {\n  let matchesSome = false;\n  for (const regEx of protectedFieldsRegex) {\n    if (key.match(regEx) !== null) {\n      matchesSome = true;\n      break;\n    }\n  }\n\n  // userId regex depends on launch options so it's dynamic\n  const valid = matchesSome || key.match(userIdRegExp) !== null;\n  if (!valid) {\n    throw new Parse.Error(\n      Parse.Error.INVALID_JSON,\n      `'${key}' is not a valid key for class level permissions`\n    );\n  }\n}\n\nconst CLPValidKeys = Object.freeze([\n  'find',\n  'count',\n  'get',\n  'create',\n  'update',\n  'delete',\n  'addField',\n  'readUserFields',\n  'writeUserFields',\n  'protectedFields',\n]);\n\n// validation before setting class-level permissions on collection\nfunction validateCLP(perms: ClassLevelPermissions, fields: SchemaFields, userIdRegExp: RegExp) {\n  if (!perms) {\n    return;\n  }\n  for (const operationKey in perms) {\n    if (CLPValidKeys.indexOf(operationKey) == -1) {\n      throw new Parse.Error(\n        Parse.Error.INVALID_JSON,\n        `${operationKey} is not a valid operation for class level permissions`\n      );\n    }\n\n    const operation = perms[operationKey];\n    // proceed with next operationKey\n\n    // throws when root fields are of wrong type\n    validateCLPjson(operation, operationKey);\n\n    if (operationKey === 'readUserFields' || operationKey === 'writeUserFields') {\n      // validate grouped pointer permissions\n      // must be an array with field names\n      for (const fieldName of operation) {\n        validatePointerPermission(fieldName, fields, operationKey);\n      }\n      // readUserFields and writerUserFields do not have nesdted fields\n      // proceed with next operationKey\n      continue;\n    }\n\n    // validate protected fields\n    if (operationKey === 'protectedFields') {\n      for (const entity in operation) {\n        // throws on unexpected key\n        validateProtectedFieldsKey(entity, userIdRegExp);\n\n        const protectedFields = operation[entity];\n\n        if (!Array.isArray(protectedFields)) {\n          throw new Parse.Error(\n            Parse.Error.INVALID_JSON,\n            `'${protectedFields}' is not a valid value for protectedFields[${entity}] - expected an array.`\n          );\n        }\n\n        // if the field is in form of array\n        for (const field of protectedFields) {\n          // do not alloow to protect default fields\n          if (defaultColumns._Default[field]) {\n            throw new Parse.Error(\n              Parse.Error.INVALID_JSON,\n              `Default field '${field}' can not be protected`\n            );\n          }\n          // field should exist on collection\n          if (!Object.prototype.hasOwnProperty.call(fields, field)) {\n            throw new Parse.Error(\n              Parse.Error.INVALID_JSON,\n              `Field '${field}' in protectedFields:${entity} does not exist`\n            );\n          }\n        }\n      }\n      // proceed with next operationKey\n      continue;\n    }\n\n    // validate other fields\n    // Entity can be:\n    // \"*\" - Public,\n    // \"requiresAuthentication\" - authenticated users,\n    // \"objectId\" - _User id,\n    // \"role:rolename\",\n    // \"pointerFields\" - array of field names containing pointers to users\n    for (const entity in operation) {\n      // throws on unexpected key\n      validatePermissionKey(entity, userIdRegExp);\n\n      // entity can be either:\n      // \"pointerFields\": string[]\n      if (entity === 'pointerFields') {\n        const pointerFields = operation[entity];\n\n        if (Array.isArray(pointerFields)) {\n          for (const pointerField of pointerFields) {\n            validatePointerPermission(pointerField, fields, operation);\n          }\n        } else {\n          throw new Parse.Error(\n            Parse.Error.INVALID_JSON,\n            `'${pointerFields}' is not a valid value for ${operationKey}[${entity}] - expected an array.`\n          );\n        }\n        // proceed with next entity key\n        continue;\n      }\n\n      // or [entity]: boolean\n      const permit = operation[entity];\n\n      if (permit !== true) {\n        throw new Parse.Error(\n          Parse.Error.INVALID_JSON,\n          `'${permit}' is not a valid value for class level permissions ${operationKey}:${entity}:${permit}`\n        );\n      }\n    }\n  }\n}\n\nfunction validateCLPjson(operation: any, operationKey: string) {\n  if (operationKey === 'readUserFields' || operationKey === 'writeUserFields') {\n    if (!Array.isArray(operation)) {\n      throw new Parse.Error(\n        Parse.Error.INVALID_JSON,\n        `'${operation}' is not a valid value for class level permissions ${operationKey} - must be an array`\n      );\n    }\n  } else {\n    if (typeof operation === 'object' && operation !== null) {\n      // ok to proceed\n      return;\n    } else {\n      throw new Parse.Error(\n        Parse.Error.INVALID_JSON,\n        `'${operation}' is not a valid value for class level permissions ${operationKey} - must be an object`\n      );\n    }\n  }\n}\n\nfunction validatePointerPermission(fieldName: string, fields: Object, operation: string) {\n  // Uses collection schema to ensure the field is of type:\n  // - Pointer<_User> (pointers)\n  // - Array\n  //\n  //    It's not possible to enforce type on Array's items in schema\n  //  so we accept any Array field, and later when applying permissions\n  //  only items that are pointers to _User are considered.\n  if (\n    !(\n      fields[fieldName] &&\n      ((fields[fieldName].type == 'Pointer' && fields[fieldName].targetClass == '_User') ||\n        fields[fieldName].type == 'Array')\n    )\n  ) {\n    throw new Parse.Error(\n      Parse.Error.INVALID_JSON,\n      `'${fieldName}' is not a valid column for class level pointer permissions ${operation}`\n    );\n  }\n}\n\nconst joinClassRegex = /^_Join:[A-Za-z0-9_]+:[A-Za-z0-9_]+/;\nconst classAndFieldRegex = /^[A-Za-z][A-Za-z0-9_]*$/;\nfunction classNameIsValid(className: string): boolean {\n  // Valid classes must:\n  return (\n    // Be one of _User, _Installation, _Role, _Session OR\n    systemClasses.indexOf(className) > -1 ||\n    // Be a join table OR\n    joinClassRegex.test(className) ||\n    // Include only alpha-numeric and underscores, and not start with an underscore or number\n    fieldNameIsValid(className, className)\n  );\n}\n\n// Valid fields must be alpha-numeric, and not start with an underscore or number\n// must not be a reserved key\nfunction fieldNameIsValid(fieldName: string, className: string): boolean {\n  if (className && className !== '_Hooks') {\n    if (fieldName === 'className') {\n      return false;\n    }\n  }\n  return classAndFieldRegex.test(fieldName) && !invalidColumns.includes(fieldName);\n}\n\n// Checks that it's not trying to clobber one of the default fields of the class.\nfunction fieldNameIsValidForClass(fieldName: string, className: string): boolean {\n  if (!fieldNameIsValid(fieldName, className)) {\n    return false;\n  }\n  if (defaultColumns._Default[fieldName]) {\n    return false;\n  }\n  if (defaultColumns[className] && defaultColumns[className][fieldName]) {\n    return false;\n  }\n  return true;\n}\n\nfunction invalidClassNameMessage(className: string): string {\n  return (\n    'Invalid classname: ' +\n    className +\n    ', classnames can only have alphanumeric characters and _, and must start with an alpha character '\n  );\n}\n\nconst invalidJsonError = new Parse.Error(Parse.Error.INVALID_JSON, 'invalid JSON');\nconst validNonRelationOrPointerTypes = [\n  'Number',\n  'String',\n  'Boolean',\n  'Date',\n  'Object',\n  'Array',\n  'GeoPoint',\n  'File',\n  'Bytes',\n  'Polygon',\n];\n// Returns an error suitable for throwing if the type is invalid\nconst fieldTypeIsInvalid = ({ type, targetClass }) => {\n  if (['Pointer', 'Relation'].indexOf(type) >= 0) {\n    if (!targetClass) {\n      return new Parse.Error(135, `type ${type} needs a class name`);\n    } else if (typeof targetClass !== 'string') {\n      return invalidJsonError;\n    } else if (!classNameIsValid(targetClass)) {\n      return new Parse.Error(Parse.Error.INVALID_CLASS_NAME, invalidClassNameMessage(targetClass));\n    } else {\n      return undefined;\n    }\n  }\n  if (typeof type !== 'string') {\n    return invalidJsonError;\n  }\n  if (validNonRelationOrPointerTypes.indexOf(type) < 0) {\n    return new Parse.Error(Parse.Error.INCORRECT_TYPE, `invalid field type: ${type}`);\n  }\n  return undefined;\n};\n\nconst convertSchemaToAdapterSchema = (schema: any) => {\n  schema = injectDefaultSchema(schema);\n  delete schema.fields.ACL;\n  schema.fields._rperm = { type: 'Array' };\n  schema.fields._wperm = { type: 'Array' };\n\n  if (schema.className === '_User') {\n    delete schema.fields.password;\n    schema.fields._hashed_password = { type: 'String' };\n  }\n\n  return schema;\n};\n\nconst convertAdapterSchemaToParseSchema = ({ ...schema }) => {\n  delete schema.fields._rperm;\n  delete schema.fields._wperm;\n\n  schema.fields.ACL = { type: 'ACL' };\n\n  if (schema.className === '_User') {\n    delete schema.fields.authData; //Auth data is implicit\n    delete schema.fields._hashed_password;\n    schema.fields.password = { type: 'String' };\n  }\n\n  if (schema.indexes && Object.keys(schema.indexes).length === 0) {\n    delete schema.indexes;\n  }\n\n  return schema;\n};\n\nclass SchemaData {\n  __data: any;\n  __protectedFields: any;\n  constructor(allSchemas = [], protectedFields = {}) {\n    this.__data = {};\n    this.__protectedFields = protectedFields;\n    allSchemas.forEach(schema => {\n      if (volatileClasses.includes(schema.className)) {\n        return;\n      }\n      Object.defineProperty(this, schema.className, {\n        get: () => {\n          if (!this.__data[schema.className]) {\n            const data = {};\n            data.fields = injectDefaultSchema(schema).fields;\n            data.classLevelPermissions = deepcopy(schema.classLevelPermissions);\n            data.indexes = schema.indexes;\n\n            const classProtectedFields = this.__protectedFields[schema.className];\n            if (classProtectedFields) {\n              for (const key in classProtectedFields) {\n                const unq = new Set([\n                  ...(data.classLevelPermissions.protectedFields[key] || []),\n                  ...classProtectedFields[key],\n                ]);\n                data.classLevelPermissions.protectedFields[key] = Array.from(unq);\n              }\n            }\n\n            this.__data[schema.className] = data;\n          }\n          return this.__data[schema.className];\n        },\n      });\n    });\n\n    // Inject the in-memory classes\n    volatileClasses.forEach(className => {\n      Object.defineProperty(this, className, {\n        get: () => {\n          if (!this.__data[className]) {\n            const schema = injectDefaultSchema({\n              className,\n              fields: {},\n              classLevelPermissions: {},\n            });\n            const data = {};\n            data.fields = schema.fields;\n            data.classLevelPermissions = schema.classLevelPermissions;\n            data.indexes = schema.indexes;\n            this.__data[className] = data;\n          }\n          return this.__data[className];\n        },\n      });\n    });\n  }\n}\n\nconst injectDefaultSchema = ({ className, fields, classLevelPermissions, indexes }: Schema) => {\n  const defaultSchema: Schema = {\n    className,\n    fields: {\n      ...defaultColumns._Default,\n      ...(defaultColumns[className] || {}),\n      ...fields,\n    },\n    classLevelPermissions,\n  };\n  if (indexes && Object.keys(indexes).length !== 0) {\n    defaultSchema.indexes = indexes;\n  }\n  return defaultSchema;\n};\n\nconst _HooksSchema = { className: '_Hooks', fields: defaultColumns._Hooks };\nconst _GlobalConfigSchema = {\n  className: '_GlobalConfig',\n  fields: defaultColumns._GlobalConfig,\n};\nconst _GraphQLConfigSchema = {\n  className: '_GraphQLConfig',\n  fields: defaultColumns._GraphQLConfig,\n};\nconst _PushStatusSchema = convertSchemaToAdapterSchema(\n  injectDefaultSchema({\n    className: '_PushStatus',\n    fields: {},\n    classLevelPermissions: {},\n  })\n);\nconst _JobStatusSchema = convertSchemaToAdapterSchema(\n  injectDefaultSchema({\n    className: '_JobStatus',\n    fields: {},\n    classLevelPermissions: {},\n  })\n);\nconst _JobScheduleSchema = convertSchemaToAdapterSchema(\n  injectDefaultSchema({\n    className: '_JobSchedule',\n    fields: {},\n    classLevelPermissions: {},\n  })\n);\nconst _AudienceSchema = convertSchemaToAdapterSchema(\n  injectDefaultSchema({\n    className: '_Audience',\n    fields: defaultColumns._Audience,\n    classLevelPermissions: {},\n  })\n);\nconst _IdempotencySchema = convertSchemaToAdapterSchema(\n  injectDefaultSchema({\n    className: '_Idempotency',\n    fields: defaultColumns._Idempotency,\n    classLevelPermissions: {},\n  })\n);\nconst VolatileClassesSchemas = [\n  _HooksSchema,\n  _JobStatusSchema,\n  _JobScheduleSchema,\n  _PushStatusSchema,\n  _GlobalConfigSchema,\n  _GraphQLConfigSchema,\n  _AudienceSchema,\n  _IdempotencySchema,\n];\n\nconst dbTypeMatchesObjectType = (dbType: SchemaField | string, objectType: SchemaField) => {\n  if (dbType.type !== objectType.type) return false;\n  if (dbType.targetClass !== objectType.targetClass) return false;\n  if (dbType === objectType.type) return true;\n  if (dbType.type === objectType.type) return true;\n  return false;\n};\n\nconst typeToString = (type: SchemaField | string): string => {\n  if (typeof type === 'string') {\n    return type;\n  }\n  if (type.targetClass) {\n    return `${type.type}<${type.targetClass}>`;\n  }\n  return `${type.type}`;\n};\n\n// Stores the entire schema of the app in a weird hybrid format somewhere between\n// the mongo format and the Parse format. Soon, this will all be Parse format.\nexport default class SchemaController {\n  _dbAdapter: StorageAdapter;\n  schemaData: { [string]: Schema };\n  reloadDataPromise: ?Promise<any>;\n  protectedFields: any;\n  userIdRegEx: RegExp;\n\n  constructor(databaseAdapter: StorageAdapter) {\n    this._dbAdapter = databaseAdapter;\n    this.schemaData = new SchemaData(SchemaCache.all(), this.protectedFields);\n    this.protectedFields = Config.get(Parse.applicationId).protectedFields;\n\n    const customIds = Config.get(Parse.applicationId).allowCustomObjectId;\n\n    const customIdRegEx = /^.{1,}$/u; // 1+ chars\n    const autoIdRegEx = /^[a-zA-Z0-9]{1,}$/;\n\n    this.userIdRegEx = customIds ? customIdRegEx : autoIdRegEx;\n\n    this._dbAdapter.watch(() => {\n      this.reloadData({ clearCache: true });\n    });\n  }\n\n  reloadData(options: LoadSchemaOptions = { clearCache: false }): Promise<any> {\n    if (this.reloadDataPromise && !options.clearCache) {\n      return this.reloadDataPromise;\n    }\n    this.reloadDataPromise = this.getAllClasses(options)\n      .then(\n        allSchemas => {\n          this.schemaData = new SchemaData(allSchemas, this.protectedFields);\n          delete this.reloadDataPromise;\n        },\n        err => {\n          this.schemaData = new SchemaData();\n          delete this.reloadDataPromise;\n          throw err;\n        }\n      )\n      .then(() => {});\n    return this.reloadDataPromise;\n  }\n\n  getAllClasses(options: LoadSchemaOptions = { clearCache: false }): Promise<Array<Schema>> {\n    if (options.clearCache) {\n      return this.setAllClasses();\n    }\n    const cached = SchemaCache.all();\n    if (cached && cached.length) {\n      return Promise.resolve(cached);\n    }\n    return this.setAllClasses();\n  }\n\n  setAllClasses(): Promise<Array<Schema>> {\n    return this._dbAdapter\n      .getAllClasses()\n      .then(allSchemas => allSchemas.map(injectDefaultSchema))\n      .then(allSchemas => {\n        SchemaCache.put(allSchemas);\n        return allSchemas;\n      });\n  }\n\n  getOneSchema(\n    className: string,\n    allowVolatileClasses: boolean = false,\n    options: LoadSchemaOptions = { clearCache: false }\n  ): Promise<Schema> {\n    if (options.clearCache) {\n      SchemaCache.clear();\n    }\n    if (allowVolatileClasses && volatileClasses.indexOf(className) > -1) {\n      const data = this.schemaData[className];\n      return Promise.resolve({\n        className,\n        fields: data.fields,\n        classLevelPermissions: data.classLevelPermissions,\n        indexes: data.indexes,\n      });\n    }\n    const cached = SchemaCache.get(className);\n    if (cached && !options.clearCache) {\n      return Promise.resolve(cached);\n    }\n    return this.setAllClasses().then(allSchemas => {\n      const oneSchema = allSchemas.find(schema => schema.className === className);\n      if (!oneSchema) {\n        return Promise.reject(undefined);\n      }\n      return oneSchema;\n    });\n  }\n\n  // Create a new class that includes the three default fields.\n  // ACL is an implicit column that does not get an entry in the\n  // _SCHEMAS database. Returns a promise that resolves with the\n  // created schema, in mongo format.\n  // on success, and rejects with an error on fail. Ensure you\n  // have authorization (master key, or client class creation\n  // enabled) before calling this function.\n  async addClassIfNotExists(\n    className: string,\n    fields: SchemaFields = {},\n    classLevelPermissions: any,\n    indexes: any = {}\n  ): Promise<void | Schema> {\n    var validationError = this.validateNewClass(className, fields, classLevelPermissions);\n    if (validationError) {\n      if (validationError instanceof Parse.Error) {\n        return Promise.reject(validationError);\n      } else if (validationError.code && validationError.error) {\n        return Promise.reject(new Parse.Error(validationError.code, validationError.error));\n      }\n      return Promise.reject(validationError);\n    }\n    try {\n      const adapterSchema = await this._dbAdapter.createClass(\n        className,\n        convertSchemaToAdapterSchema({\n          fields,\n          classLevelPermissions,\n          indexes,\n          className,\n        })\n      );\n      // TODO: Remove by updating schema cache directly\n      await this.reloadData({ clearCache: true });\n      const parseSchema = convertAdapterSchemaToParseSchema(adapterSchema);\n      return parseSchema;\n    } catch (error) {\n      if (error && error.code === Parse.Error.DUPLICATE_VALUE) {\n        throw new Parse.Error(Parse.Error.INVALID_CLASS_NAME, `Class ${className} already exists.`);\n      } else {\n        throw error;\n      }\n    }\n  }\n\n  updateClass(\n    className: string,\n    submittedFields: SchemaFields,\n    classLevelPermissions: any,\n    indexes: any,\n    database: DatabaseController\n  ) {\n    return this.getOneSchema(className)\n      .then(schema => {\n        const existingFields = schema.fields;\n        Object.keys(submittedFields).forEach(name => {\n          const field = submittedFields[name];\n          if (\n            existingFields[name] &&\n            existingFields[name].type !== field.type &&\n            field.__op !== 'Delete'\n          ) {\n            throw new Parse.Error(255, `Field ${name} exists, cannot update.`);\n          }\n          if (!existingFields[name] && field.__op === 'Delete') {\n            throw new Parse.Error(255, `Field ${name} does not exist, cannot delete.`);\n          }\n        });\n\n        delete existingFields._rperm;\n        delete existingFields._wperm;\n        const newSchema = buildMergedSchemaObject(existingFields, submittedFields);\n        const defaultFields = defaultColumns[className] || defaultColumns._Default;\n        const fullNewSchema = Object.assign({}, newSchema, defaultFields);\n        const validationError = this.validateSchemaData(\n          className,\n          newSchema,\n          classLevelPermissions,\n          Object.keys(existingFields)\n        );\n        if (validationError) {\n          throw new Parse.Error(validationError.code, validationError.error);\n        }\n\n        // Finally we have checked to make sure the request is valid and we can start deleting fields.\n        // Do all deletions first, then a single save to _SCHEMA collection to handle all additions.\n        const deletedFields: string[] = [];\n        const insertedFields = [];\n        Object.keys(submittedFields).forEach(fieldName => {\n          if (submittedFields[fieldName].__op === 'Delete') {\n            deletedFields.push(fieldName);\n          } else {\n            insertedFields.push(fieldName);\n          }\n        });\n\n        let deletePromise = Promise.resolve();\n        if (deletedFields.length > 0) {\n          deletePromise = this.deleteFields(deletedFields, className, database);\n        }\n        let enforceFields = [];\n        return (\n          deletePromise // Delete Everything\n            .then(() => this.reloadData({ clearCache: true })) // Reload our Schema, so we have all the new values\n            .then(() => {\n              const promises = insertedFields.map(fieldName => {\n                const type = submittedFields[fieldName];\n                return this.enforceFieldExists(className, fieldName, type);\n              });\n              return Promise.all(promises);\n            })\n            .then(results => {\n              enforceFields = results.filter(result => !!result);\n              return this.setPermissions(className, classLevelPermissions, newSchema);\n            })\n            .then(() =>\n              this._dbAdapter.setIndexesWithSchemaFormat(\n                className,\n                indexes,\n                schema.indexes,\n                fullNewSchema\n              )\n            )\n            .then(() => this.reloadData({ clearCache: true }))\n            //TODO: Move this logic into the database adapter\n            .then(() => {\n              this.ensureFields(enforceFields);\n              const schema = this.schemaData[className];\n              const reloadedSchema: Schema = {\n                className: className,\n                fields: schema.fields,\n                classLevelPermissions: schema.classLevelPermissions,\n              };\n              if (schema.indexes && Object.keys(schema.indexes).length !== 0) {\n                reloadedSchema.indexes = schema.indexes;\n              }\n              return reloadedSchema;\n            })\n        );\n      })\n      .catch(error => {\n        if (error === undefined) {\n          throw new Parse.Error(\n            Parse.Error.INVALID_CLASS_NAME,\n            `Class ${className} does not exist.`\n          );\n        } else {\n          throw error;\n        }\n      });\n  }\n\n  // Returns a promise that resolves successfully to the new schema\n  // object or fails with a reason.\n  enforceClassExists(className: string): Promise<SchemaController> {\n    if (this.schemaData[className]) {\n      return Promise.resolve(this);\n    }\n    // We don't have this class. Update the schema\n    return (\n      // The schema update succeeded. Reload the schema\n      this.addClassIfNotExists(className)\n        .catch(() => {\n          // The schema update failed. This can be okay - it might\n          // have failed because there's a race condition and a different\n          // client is making the exact same schema update that we want.\n          // So just reload the schema.\n          return this.reloadData({ clearCache: true });\n        })\n        .then(() => {\n          // Ensure that the schema now validates\n          if (this.schemaData[className]) {\n            return this;\n          } else {\n            throw new Parse.Error(Parse.Error.INVALID_JSON, `Failed to add ${className}`);\n          }\n        })\n        .catch(() => {\n          // The schema still doesn't validate. Give up\n          throw new Parse.Error(Parse.Error.INVALID_JSON, 'schema class name does not revalidate');\n        })\n    );\n  }\n\n  validateNewClass(className: string, fields: SchemaFields = {}, classLevelPermissions: any): any {\n    if (this.schemaData[className]) {\n      throw new Parse.Error(Parse.Error.INVALID_CLASS_NAME, `Class ${className} already exists.`);\n    }\n    if (!classNameIsValid(className)) {\n      return {\n        code: Parse.Error.INVALID_CLASS_NAME,\n        error: invalidClassNameMessage(className),\n      };\n    }\n    return this.validateSchemaData(className, fields, classLevelPermissions, []);\n  }\n\n  validateSchemaData(\n    className: string,\n    fields: SchemaFields,\n    classLevelPermissions: ClassLevelPermissions,\n    existingFieldNames: Array<string>\n  ) {\n    for (const fieldName in fields) {\n      if (existingFieldNames.indexOf(fieldName) < 0) {\n        if (!fieldNameIsValid(fieldName, className)) {\n          return {\n            code: Parse.Error.INVALID_KEY_NAME,\n            error: 'invalid field name: ' + fieldName,\n          };\n        }\n        if (!fieldNameIsValidForClass(fieldName, className)) {\n          return {\n            code: 136,\n            error: 'field ' + fieldName + ' cannot be added',\n          };\n        }\n        const fieldType = fields[fieldName];\n        const error = fieldTypeIsInvalid(fieldType);\n        if (error) return { code: error.code, error: error.message };\n        if (fieldType.defaultValue !== undefined) {\n          let defaultValueType = getType(fieldType.defaultValue);\n          if (typeof defaultValueType === 'string') {\n            defaultValueType = { type: defaultValueType };\n          } else if (typeof defaultValueType === 'object' && fieldType.type === 'Relation') {\n            return {\n              code: Parse.Error.INCORRECT_TYPE,\n              error: `The 'default value' option is not applicable for ${typeToString(fieldType)}`,\n            };\n          }\n          if (!dbTypeMatchesObjectType(fieldType, defaultValueType)) {\n            return {\n              code: Parse.Error.INCORRECT_TYPE,\n              error: `schema mismatch for ${className}.${fieldName} default value; expected ${typeToString(\n                fieldType\n              )} but got ${typeToString(defaultValueType)}`,\n            };\n          }\n        } else if (fieldType.required) {\n          if (typeof fieldType === 'object' && fieldType.type === 'Relation') {\n            return {\n              code: Parse.Error.INCORRECT_TYPE,\n              error: `The 'required' option is not applicable for ${typeToString(fieldType)}`,\n            };\n          }\n        }\n      }\n    }\n\n    for (const fieldName in defaultColumns[className]) {\n      fields[fieldName] = defaultColumns[className][fieldName];\n    }\n\n    const geoPoints = Object.keys(fields).filter(\n      key => fields[key] && fields[key].type === 'GeoPoint'\n    );\n    if (geoPoints.length > 1) {\n      return {\n        code: Parse.Error.INCORRECT_TYPE,\n        error:\n          'currently, only one GeoPoint field may exist in an object. Adding ' +\n          geoPoints[1] +\n          ' when ' +\n          geoPoints[0] +\n          ' already exists.',\n      };\n    }\n    validateCLP(classLevelPermissions, fields, this.userIdRegEx);\n  }\n\n  // Sets the Class-level permissions for a given className, which must exist.\n  async setPermissions(className: string, perms: any, newSchema: SchemaFields) {\n    if (typeof perms === 'undefined') {\n      return Promise.resolve();\n    }\n    validateCLP(perms, newSchema, this.userIdRegEx);\n    await this._dbAdapter.setClassLevelPermissions(className, perms);\n    const cached = SchemaCache.get(className);\n    if (cached) {\n      cached.classLevelPermissions = perms;\n    }\n  }\n\n  // Returns a promise that resolves successfully to the new schema\n  // object if the provided className-fieldName-type tuple is valid.\n  // The className must already be validated.\n  // If 'freeze' is true, refuse to update the schema for this field.\n  enforceFieldExists(\n    className: string,\n    fieldName: string,\n    type: string | SchemaField,\n    isValidation?: boolean\n  ) {\n    if (fieldName.indexOf('.') > 0) {\n      // subdocument key (x.y) => ok if x is of type 'object'\n      fieldName = fieldName.split('.')[0];\n      type = 'Object';\n    }\n    if (!fieldNameIsValid(fieldName, className)) {\n      throw new Parse.Error(Parse.Error.INVALID_KEY_NAME, `Invalid field name: ${fieldName}.`);\n    }\n\n    // If someone tries to create a new field with null/undefined as the value, return;\n    if (!type) {\n      return undefined;\n    }\n\n    const expectedType = this.getExpectedType(className, fieldName);\n    if (typeof type === 'string') {\n      type = ({ type }: SchemaField);\n    }\n\n    if (type.defaultValue !== undefined) {\n      let defaultValueType = getType(type.defaultValue);\n      if (typeof defaultValueType === 'string') {\n        defaultValueType = { type: defaultValueType };\n      }\n      if (!dbTypeMatchesObjectType(type, defaultValueType)) {\n        throw new Parse.Error(\n          Parse.Error.INCORRECT_TYPE,\n          `schema mismatch for ${className}.${fieldName} default value; expected ${typeToString(\n            type\n          )} but got ${typeToString(defaultValueType)}`\n        );\n      }\n    }\n\n    if (expectedType) {\n      if (!dbTypeMatchesObjectType(expectedType, type)) {\n        throw new Parse.Error(\n          Parse.Error.INCORRECT_TYPE,\n          `schema mismatch for ${className}.${fieldName}; expected ${typeToString(\n            expectedType\n          )} but got ${typeToString(type)}`\n        );\n      }\n      // If type options do not change\n      // we can safely return\n      if (isValidation || JSON.stringify(expectedType) === JSON.stringify(type)) {\n        return undefined;\n      }\n      // Field options are may be changed\n      // ensure to have an update to date schema field\n      return this._dbAdapter.updateFieldOptions(className, fieldName, type);\n    }\n\n    return this._dbAdapter\n      .addFieldIfNotExists(className, fieldName, type)\n      .catch(error => {\n        if (error.code == Parse.Error.INCORRECT_TYPE) {\n          // Make sure that we throw errors when it is appropriate to do so.\n          throw error;\n        }\n        // The update failed. This can be okay - it might have been a race\n        // condition where another client updated the schema in the same\n        // way that we wanted to. So, just reload the schema\n        return Promise.resolve();\n      })\n      .then(() => {\n        return {\n          className,\n          fieldName,\n          type,\n        };\n      });\n  }\n\n  ensureFields(fields: any) {\n    for (let i = 0; i < fields.length; i += 1) {\n      const { className, fieldName } = fields[i];\n      let { type } = fields[i];\n      const expectedType = this.getExpectedType(className, fieldName);\n      if (typeof type === 'string') {\n        type = { type: type };\n      }\n      if (!expectedType || !dbTypeMatchesObjectType(expectedType, type)) {\n        throw new Parse.Error(Parse.Error.INVALID_JSON, `Could not add field ${fieldName}`);\n      }\n    }\n  }\n\n  // maintain compatibility\n  deleteField(fieldName: string, className: string, database: DatabaseController) {\n    return this.deleteFields([fieldName], className, database);\n  }\n\n  // Delete fields, and remove that data from all objects. This is intended\n  // to remove unused fields, if other writers are writing objects that include\n  // this field, the field may reappear. Returns a Promise that resolves with\n  // no object on success, or rejects with { code, error } on failure.\n  // Passing the database and prefix is necessary in order to drop relation collections\n  // and remove fields from objects. Ideally the database would belong to\n  // a database adapter and this function would close over it or access it via member.\n  deleteFields(fieldNames: Array<string>, className: string, database: DatabaseController) {\n    if (!classNameIsValid(className)) {\n      throw new Parse.Error(Parse.Error.INVALID_CLASS_NAME, invalidClassNameMessage(className));\n    }\n\n    fieldNames.forEach(fieldName => {\n      if (!fieldNameIsValid(fieldName, className)) {\n        throw new Parse.Error(Parse.Error.INVALID_KEY_NAME, `invalid field name: ${fieldName}`);\n      }\n      //Don't allow deleting the default fields.\n      if (!fieldNameIsValidForClass(fieldName, className)) {\n        throw new Parse.Error(136, `field ${fieldName} cannot be changed`);\n      }\n    });\n\n    return this.getOneSchema(className, false, { clearCache: true })\n      .catch(error => {\n        if (error === undefined) {\n          throw new Parse.Error(\n            Parse.Error.INVALID_CLASS_NAME,\n            `Class ${className} does not exist.`\n          );\n        } else {\n          throw error;\n        }\n      })\n      .then(schema => {\n        fieldNames.forEach(fieldName => {\n          if (!schema.fields[fieldName]) {\n            throw new Parse.Error(255, `Field ${fieldName} does not exist, cannot delete.`);\n          }\n        });\n\n        const schemaFields = { ...schema.fields };\n        return database.adapter.deleteFields(className, schema, fieldNames).then(() => {\n          return Promise.all(\n            fieldNames.map(fieldName => {\n              const field = schemaFields[fieldName];\n              if (field && field.type === 'Relation') {\n                //For relations, drop the _Join table\n                return database.adapter.deleteClass(`_Join:${fieldName}:${className}`);\n              }\n              return Promise.resolve();\n            })\n          );\n        });\n      })\n      .then(() => {\n        SchemaCache.clear();\n      });\n  }\n\n  // Validates an object provided in REST format.\n  // Returns a promise that resolves to the new schema if this object is\n  // valid.\n  async validateObject(className: string, object: any, query: any) {\n    let geocount = 0;\n    const schema = await this.enforceClassExists(className);\n    const promises = [];\n\n    for (const fieldName in object) {\n      if (object[fieldName] && getType(object[fieldName]) === 'GeoPoint') {\n        geocount++;\n      }\n      if (geocount > 1) {\n        return Promise.reject(\n          new Parse.Error(\n            Parse.Error.INCORRECT_TYPE,\n            'there can only be one geopoint field in a class'\n          )\n        );\n      }\n    }\n    for (const fieldName in object) {\n      if (object[fieldName] === undefined) {\n        continue;\n      }\n      const expected = getType(object[fieldName]);\n      if (!expected) {\n        continue;\n      }\n      if (fieldName === 'ACL') {\n        // Every object has ACL implicitly.\n        continue;\n      }\n      promises.push(schema.enforceFieldExists(className, fieldName, expected, true));\n    }\n    const results = await Promise.all(promises);\n    const enforceFields = results.filter(result => !!result);\n\n    if (enforceFields.length !== 0) {\n      // TODO: Remove by updating schema cache directly\n      await this.reloadData({ clearCache: true });\n    }\n    this.ensureFields(enforceFields);\n\n    const promise = Promise.resolve(schema);\n    return thenValidateRequiredColumns(promise, className, object, query);\n  }\n\n  // Validates that all the properties are set for the object\n  validateRequiredColumns(className: string, object: any, query: any) {\n    const columns = requiredColumns[className];\n    if (!columns || columns.length == 0) {\n      return Promise.resolve(this);\n    }\n\n    const missingColumns = columns.filter(function (column) {\n      if (query && query.objectId) {\n        if (object[column] && typeof object[column] === 'object') {\n          // Trying to delete a required column\n          return object[column].__op == 'Delete';\n        }\n        // Not trying to do anything there\n        return false;\n      }\n      return !object[column];\n    });\n\n    if (missingColumns.length > 0) {\n      throw new Parse.Error(Parse.Error.INCORRECT_TYPE, missingColumns[0] + ' is required.');\n    }\n    return Promise.resolve(this);\n  }\n\n  testPermissionsForClassName(className: string, aclGroup: string[], operation: string) {\n    return SchemaController.testPermissions(\n      this.getClassLevelPermissions(className),\n      aclGroup,\n      operation\n    );\n  }\n\n  // Tests that the class level permission let pass the operation for a given aclGroup\n  static testPermissions(classPermissions: ?any, aclGroup: string[], operation: string): boolean {\n    if (!classPermissions || !classPermissions[operation]) {\n      return true;\n    }\n    const perms = classPermissions[operation];\n    if (perms['*']) {\n      return true;\n    }\n    // Check permissions against the aclGroup provided (array of userId/roles)\n    if (\n      aclGroup.some(acl => {\n        return perms[acl] === true;\n      })\n    ) {\n      return true;\n    }\n    return false;\n  }\n\n  // Validates an operation passes class-level-permissions set in the schema\n  static validatePermission(\n    classPermissions: ?any,\n    className: string,\n    aclGroup: string[],\n    operation: string,\n    action?: string\n  ) {\n    if (SchemaController.testPermissions(classPermissions, aclGroup, operation)) {\n      return Promise.resolve();\n    }\n\n    if (!classPermissions || !classPermissions[operation]) {\n      return true;\n    }\n    const perms = classPermissions[operation];\n    // If only for authenticated users\n    // make sure we have an aclGroup\n    if (perms['requiresAuthentication']) {\n      // If aclGroup has * (public)\n      if (!aclGroup || aclGroup.length == 0) {\n        throw new Parse.Error(\n          Parse.Error.OBJECT_NOT_FOUND,\n          'Permission denied, user needs to be authenticated.'\n        );\n      } else if (aclGroup.indexOf('*') > -1 && aclGroup.length == 1) {\n        throw new Parse.Error(\n          Parse.Error.OBJECT_NOT_FOUND,\n          'Permission denied, user needs to be authenticated.'\n        );\n      }\n      // requiresAuthentication passed, just move forward\n      // probably would be wise at some point to rename to 'authenticatedUser'\n      return Promise.resolve();\n    }\n\n    // No matching CLP, let's check the Pointer permissions\n    // And handle those later\n    const permissionField =\n      ['get', 'find', 'count'].indexOf(operation) > -1 ? 'readUserFields' : 'writeUserFields';\n\n    // Reject create when write lockdown\n    if (permissionField == 'writeUserFields' && operation == 'create') {\n      throw new Parse.Error(\n        Parse.Error.OPERATION_FORBIDDEN,\n        `Permission denied for action ${operation} on class ${className}.`\n      );\n    }\n\n    // Process the readUserFields later\n    if (\n      Array.isArray(classPermissions[permissionField]) &&\n      classPermissions[permissionField].length > 0\n    ) {\n      return Promise.resolve();\n    }\n\n    const pointerFields = classPermissions[operation].pointerFields;\n    if (Array.isArray(pointerFields) && pointerFields.length > 0) {\n      // any op except 'addField as part of create' is ok.\n      if (operation !== 'addField' || action === 'update') {\n        // We can allow adding field on update flow only.\n        return Promise.resolve();\n      }\n    }\n\n    throw new Parse.Error(\n      Parse.Error.OPERATION_FORBIDDEN,\n      `Permission denied for action ${operation} on class ${className}.`\n    );\n  }\n\n  // Validates an operation passes class-level-permissions set in the schema\n  validatePermission(className: string, aclGroup: string[], operation: string, action?: string) {\n    return SchemaController.validatePermission(\n      this.getClassLevelPermissions(className),\n      className,\n      aclGroup,\n      operation,\n      action\n    );\n  }\n\n  getClassLevelPermissions(className: string): any {\n    return this.schemaData[className] && this.schemaData[className].classLevelPermissions;\n  }\n\n  // Returns the expected type for a className+key combination\n  // or undefined if the schema is not set\n  getExpectedType(className: string, fieldName: string): ?(SchemaField | string) {\n    if (this.schemaData[className]) {\n      const expectedType = this.schemaData[className].fields[fieldName];\n      return expectedType === 'map' ? 'Object' : expectedType;\n    }\n    return undefined;\n  }\n\n  // Checks if a given class is in the schema.\n  hasClass(className: string) {\n    if (this.schemaData[className]) {\n      return Promise.resolve(true);\n    }\n    return this.reloadData().then(() => !!this.schemaData[className]);\n  }\n}\n\n// Returns a promise for a new Schema.\nconst load = (dbAdapter: StorageAdapter, options: any): Promise<SchemaController> => {\n  const schema = new SchemaController(dbAdapter);\n  return schema.reloadData(options).then(() => schema);\n};\n\n// Builds a new schema (in schema API response format) out of an\n// existing mongo schema + a schemas API put request. This response\n// does not include the default fields, as it is intended to be passed\n// to mongoSchemaFromFieldsAndClassName. No validation is done here, it\n// is done in mongoSchemaFromFieldsAndClassName.\nfunction buildMergedSchemaObject(existingFields: SchemaFields, putRequest: any): SchemaFields {\n  const newSchema = {};\n  // @flow-disable-next\n  const sysSchemaField =\n    Object.keys(defaultColumns).indexOf(existingFields._id) === -1\n      ? []\n      : Object.keys(defaultColumns[existingFields._id]);\n  for (const oldField in existingFields) {\n    if (\n      oldField !== '_id' &&\n      oldField !== 'ACL' &&\n      oldField !== 'updatedAt' &&\n      oldField !== 'createdAt' &&\n      oldField !== 'objectId'\n    ) {\n      if (sysSchemaField.length > 0 && sysSchemaField.indexOf(oldField) !== -1) {\n        continue;\n      }\n      const fieldIsDeleted = putRequest[oldField] && putRequest[oldField].__op === 'Delete';\n      if (!fieldIsDeleted) {\n        newSchema[oldField] = existingFields[oldField];\n      }\n    }\n  }\n  for (const newField in putRequest) {\n    if (newField !== 'objectId' && putRequest[newField].__op !== 'Delete') {\n      if (sysSchemaField.length > 0 && sysSchemaField.indexOf(newField) !== -1) {\n        continue;\n      }\n      newSchema[newField] = putRequest[newField];\n    }\n  }\n  return newSchema;\n}\n\n// Given a schema promise, construct another schema promise that\n// validates this field once the schema loads.\nfunction thenValidateRequiredColumns(schemaPromise, className, object, query) {\n  return schemaPromise.then(schema => {\n    return schema.validateRequiredColumns(className, object, query);\n  });\n}\n\n// Gets the type from a REST API formatted object, where 'type' is\n// extended past javascript types to include the rest of the Parse\n// type system.\n// The output should be a valid schema value.\n// TODO: ensure that this is compatible with the format used in Open DB\nfunction getType(obj: any): ?(SchemaField | string) {\n  const type = typeof obj;\n  switch (type) {\n    case 'boolean':\n      return 'Boolean';\n    case 'string':\n      return 'String';\n    case 'number':\n      return 'Number';\n    case 'map':\n    case 'object':\n      if (!obj) {\n        return undefined;\n      }\n      return getObjectType(obj);\n    case 'function':\n    case 'symbol':\n    case 'undefined':\n    default:\n      throw 'bad obj: ' + obj;\n  }\n}\n\n// This gets the type for non-JSON types like pointers and files, but\n// also gets the appropriate type for $ operators.\n// Returns null if the type is unknown.\nfunction getObjectType(obj): ?(SchemaField | string) {\n  if (obj instanceof Array) {\n    return 'Array';\n  }\n  if (obj.__type) {\n    switch (obj.__type) {\n      case 'Pointer':\n        if (obj.className) {\n          return {\n            type: 'Pointer',\n            targetClass: obj.className,\n          };\n        }\n        break;\n      case 'Relation':\n        if (obj.className) {\n          return {\n            type: 'Relation',\n            targetClass: obj.className,\n          };\n        }\n        break;\n      case 'File':\n        if (obj.name) {\n          return 'File';\n        }\n        break;\n      case 'Date':\n        if (obj.iso) {\n          return 'Date';\n        }\n        break;\n      case 'GeoPoint':\n        if (obj.latitude != null && obj.longitude != null) {\n          return 'GeoPoint';\n        }\n        break;\n      case 'Bytes':\n        if (obj.base64) {\n          return 'Bytes';\n        }\n        break;\n      case 'Polygon':\n        if (obj.coordinates) {\n          return 'Polygon';\n        }\n        break;\n    }\n    throw new Parse.Error(Parse.Error.INCORRECT_TYPE, 'This is not a valid ' + obj.__type);\n  }\n  if (obj['$ne']) {\n    return getObjectType(obj['$ne']);\n  }\n  if (obj.__op) {\n    switch (obj.__op) {\n      case 'Increment':\n        return 'Number';\n      case 'Delete':\n        return null;\n      case 'Add':\n      case 'AddUnique':\n      case 'Remove':\n        return 'Array';\n      case 'AddRelation':\n      case 'RemoveRelation':\n        return {\n          type: 'Relation',\n          targetClass: obj.objects[0].className,\n        };\n      case 'Batch':\n        return getObjectType(obj.ops[0]);\n      default:\n        throw 'unexpected op: ' + obj.__op;\n    }\n  }\n  return 'Object';\n}\n\nexport {\n  load,\n  classNameIsValid,\n  fieldNameIsValid,\n  invalidClassNameMessage,\n  buildMergedSchemaObject,\n  systemClasses,\n  defaultColumns,\n  convertSchemaToAdapterSchema,\n  VolatileClassesSchemas,\n  SchemaController,\n};\n"]}