{"version":3,"sources":["../../src/Routers/UsersRouter.js"],"names":["UsersRouter","ClassesRouter","className","removeHiddenProperties","obj","key","Object","prototype","hasOwnProperty","call","test","_sanitizeAuthData","user","password","authData","keys","forEach","provider","length","_authenticateUserFromRequest","req","Promise","resolve","reject","payload","body","username","query","email","Parse","Error","USERNAME_MISSING","PASSWORD_MISSING","OBJECT_NOT_FOUND","isValidPassword","$or","config","database","find","then","results","loggerController","warn","filter","passwordCrypto","compare","correct","accountLockoutPolicy","AccountLockout","handleLoginAttempt","auth","isMaster","ACL","verifyUserEmails","preventLoginWithUnverifiedEmail","emailVerified","EMAIL_NOT_FOUND","catch","error","handleMe","info","sessionToken","INVALID_SESSION_TOKEN","rest","Auth","master","include","clientSDK","context","response","handleLogIn","passwordPolicy","maxPasswordAge","changedAt","_password_changed_at","Date","update","_encode","__type","iso","expiresAt","getTime","filesController","expandFilesInObject","TriggerTypes","beforeLogin","User","fromJSON","assign","sessionData","createSession","RestWrite","userId","objectId","createdWith","action","authProvider","installationId","afterLoginUser","afterLogin","handleLogInAs","OPERATION_FORBIDDEN","INVALID_VALUE","queryResults","handleVerifyPassword","handleLogOut","success","undefined","records","del","_runAfterLogoutTrigger","session","afterLogout","Session","_throwOnBadEmailConfig","Config","validateEmailConfiguration","emailAdapter","userController","adapter","appName","publicServerURL","emailVerifyTokenValidityDuration","emailVerifyTokenReuseIfValid","e","INTERNAL_SERVER_ERROR","handleResetRequest","EMAIL_MISSING","INVALID_EMAIL_ADDRESS","sendPasswordResetEmail","err","code","handleVerificationEmailRequest","OTHER_CAUSE","regenerateEmailVerifyToken","sendVerificationEmail","mountRoutes","route","handleFind","promiseEnsureIdempotency","handleCreate","handleGet","handleUpdate","handleDelete"],"mappings":"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","sourcesContent":["// These methods handle the User-related routes.\n\nimport Parse from 'parse/node';\nimport Config from '../Config';\nimport AccountLockout from '../AccountLockout';\nimport ClassesRouter from './ClassesRouter';\nimport rest from '../rest';\nimport Auth from '../Auth';\nimport passwordCrypto from '../password';\nimport { maybeRunTrigger, Types as TriggerTypes } from '../triggers';\nimport { promiseEnsureIdempotency } from '../middlewares';\nimport RestWrite from '../RestWrite';\n\nexport class UsersRouter extends ClassesRouter {\n  className() {\n    return '_User';\n  }\n\n  /**\n   * Removes all \"_\" prefixed properties from an object, except \"__type\"\n   * @param {Object} obj An object.\n   */\n  static removeHiddenProperties(obj) {\n    for (var key in obj) {\n      if (Object.prototype.hasOwnProperty.call(obj, key)) {\n        // Regexp comes from Parse.Object.prototype.validate\n        if (key !== '__type' && !/^[A-Za-z][0-9A-Za-z_]*$/.test(key)) {\n          delete obj[key];\n        }\n      }\n    }\n  }\n\n  /**\n   * After retrieving a user directly from the database, we need to remove the\n   * password from the object (for security), and fix an issue some SDKs have\n   * with null values\n   */\n  _sanitizeAuthData(user) {\n    delete user.password;\n\n    // Sometimes the authData still has null on that keys\n    // https://github.com/parse-community/parse-server/issues/935\n    if (user.authData) {\n      Object.keys(user.authData).forEach(provider => {\n        if (user.authData[provider] === null) {\n          delete user.authData[provider];\n        }\n      });\n      if (Object.keys(user.authData).length == 0) {\n        delete user.authData;\n      }\n    }\n  }\n\n  /**\n   * Validates a password request in login and verifyPassword\n   * @param {Object} req The request\n   * @returns {Object} User object\n   * @private\n   */\n  _authenticateUserFromRequest(req) {\n    return new Promise((resolve, reject) => {\n      // Use query parameters instead if provided in url\n      let payload = req.body;\n      if (\n        (!payload.username && req.query && req.query.username) ||\n        (!payload.email && req.query && req.query.email)\n      ) {\n        payload = req.query;\n      }\n      const { username, email, password } = payload;\n\n      // TODO: use the right error codes / descriptions.\n      if (!username && !email) {\n        throw new Parse.Error(Parse.Error.USERNAME_MISSING, 'username/email is required.');\n      }\n      if (!password) {\n        throw new Parse.Error(Parse.Error.PASSWORD_MISSING, 'password is required.');\n      }\n      if (\n        typeof password !== 'string' ||\n        (email && typeof email !== 'string') ||\n        (username && typeof username !== 'string')\n      ) {\n        throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Invalid username/password.');\n      }\n\n      let user;\n      let isValidPassword = false;\n      let query;\n      if (email && username) {\n        query = { email, username };\n      } else if (email) {\n        query = { email };\n      } else {\n        query = { $or: [{ username }, { email: username }] };\n      }\n      return req.config.database\n        .find('_User', query)\n        .then(results => {\n          if (!results.length) {\n            throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Invalid username/password.');\n          }\n\n          if (results.length > 1) {\n            // corner case where user1 has username == user2 email\n            req.config.loggerController.warn(\n              \"There is a user which email is the same as another user's username, logging in based on username\"\n            );\n            user = results.filter(user => user.username === username)[0];\n          } else {\n            user = results[0];\n          }\n\n          return passwordCrypto.compare(password, user.password);\n        })\n        .then(correct => {\n          isValidPassword = correct;\n          const accountLockoutPolicy = new AccountLockout(user, req.config);\n          return accountLockoutPolicy.handleLoginAttempt(isValidPassword);\n        })\n        .then(() => {\n          if (!isValidPassword) {\n            throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Invalid username/password.');\n          }\n          // Ensure the user isn't locked out\n          // A locked out user won't be able to login\n          // To lock a user out, just set the ACL to `masterKey` only  ({}).\n          // Empty ACL is OK\n          if (!req.auth.isMaster && user.ACL && Object.keys(user.ACL).length == 0) {\n            throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Invalid username/password.');\n          }\n          if (\n            req.config.verifyUserEmails &&\n            req.config.preventLoginWithUnverifiedEmail &&\n            !user.emailVerified\n          ) {\n            throw new Parse.Error(Parse.Error.EMAIL_NOT_FOUND, 'User email is not verified.');\n          }\n\n          this._sanitizeAuthData(user);\n\n          return resolve(user);\n        })\n        .catch(error => {\n          return reject(error);\n        });\n    });\n  }\n\n  handleMe(req) {\n    if (!req.info || !req.info.sessionToken) {\n      throw new Parse.Error(Parse.Error.INVALID_SESSION_TOKEN, 'Invalid session token');\n    }\n    const sessionToken = req.info.sessionToken;\n    return rest\n      .find(\n        req.config,\n        Auth.master(req.config),\n        '_Session',\n        { sessionToken },\n        { include: 'user' },\n        req.info.clientSDK,\n        req.info.context\n      )\n      .then(response => {\n        if (!response.results || response.results.length == 0 || !response.results[0].user) {\n          throw new Parse.Error(Parse.Error.INVALID_SESSION_TOKEN, 'Invalid session token');\n        } else {\n          const user = response.results[0].user;\n          // Send token back on the login, because SDKs expect that.\n          user.sessionToken = sessionToken;\n\n          // Remove hidden properties.\n          UsersRouter.removeHiddenProperties(user);\n\n          return { response: user };\n        }\n      });\n  }\n\n  async handleLogIn(req) {\n    const user = await this._authenticateUserFromRequest(req);\n\n    // handle password expiry policy\n    if (req.config.passwordPolicy && req.config.passwordPolicy.maxPasswordAge) {\n      let changedAt = user._password_changed_at;\n\n      if (!changedAt) {\n        // password was created before expiry policy was enabled.\n        // simply update _User object so that it will start enforcing from now\n        changedAt = new Date();\n        req.config.database.update(\n          '_User',\n          { username: user.username },\n          { _password_changed_at: Parse._encode(changedAt) }\n        );\n      } else {\n        // check whether the password has expired\n        if (changedAt.__type == 'Date') {\n          changedAt = new Date(changedAt.iso);\n        }\n        // Calculate the expiry time.\n        const expiresAt = new Date(\n          changedAt.getTime() + 86400000 * req.config.passwordPolicy.maxPasswordAge\n        );\n        if (expiresAt < new Date())\n          // fail of current time is past password expiry time\n          throw new Parse.Error(\n            Parse.Error.OBJECT_NOT_FOUND,\n            'Your password has expired. Please reset your password.'\n          );\n      }\n    }\n\n    // Remove hidden properties.\n    UsersRouter.removeHiddenProperties(user);\n\n    req.config.filesController.expandFilesInObject(req.config, user);\n\n    // Before login trigger; throws if failure\n    await maybeRunTrigger(\n      TriggerTypes.beforeLogin,\n      req.auth,\n      Parse.User.fromJSON(Object.assign({ className: '_User' }, user)),\n      null,\n      req.config\n    );\n\n    const { sessionData, createSession } = RestWrite.createSession(req.config, {\n      userId: user.objectId,\n      createdWith: {\n        action: 'login',\n        authProvider: 'password',\n      },\n      installationId: req.info.installationId,\n    });\n\n    user.sessionToken = sessionData.sessionToken;\n\n    await createSession();\n\n    const afterLoginUser = Parse.User.fromJSON(Object.assign({ className: '_User' }, user));\n    maybeRunTrigger(\n      TriggerTypes.afterLogin,\n      { ...req.auth, user: afterLoginUser },\n      afterLoginUser,\n      null,\n      req.config\n    );\n\n    return { response: user };\n  }\n\n  /**\n   * This allows master-key clients to create user sessions without access to\n   * user credentials. This enables systems that can authenticate access another\n   * way (API key, app administrators) to act on a user's behalf.\n   *\n   * We create a new session rather than looking for an existing session; we\n   * want this to work in situations where the user is logged out on all\n   * devices, since this can be used by automated systems acting on the user's\n   * behalf.\n   *\n   * For the moment, we're omitting event hooks and lockout checks, since\n   * immediate use cases suggest /loginAs could be used for semantically\n   * different reasons from /login\n   */\n  async handleLogInAs(req) {\n    if (!req.auth.isMaster) {\n      throw new Parse.Error(Parse.Error.OPERATION_FORBIDDEN, 'master key is required');\n    }\n\n    const userId = req.body.userId || req.query.userId;\n    if (!userId) {\n      throw new Parse.Error(\n        Parse.Error.INVALID_VALUE,\n        'userId must not be empty, null, or undefined'\n      );\n    }\n\n    const queryResults = await req.config.database.find('_User', { objectId: userId });\n    const user = queryResults[0];\n    if (!user) {\n      throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'user not found');\n    }\n\n    this._sanitizeAuthData(user);\n\n    const { sessionData, createSession } = RestWrite.createSession(req.config, {\n      userId,\n      createdWith: {\n        action: 'login',\n        authProvider: 'masterkey',\n      },\n      installationId: req.info.installationId,\n    });\n\n    user.sessionToken = sessionData.sessionToken;\n\n    await createSession();\n\n    return { response: user };\n  }\n\n  handleVerifyPassword(req) {\n    return this._authenticateUserFromRequest(req)\n      .then(user => {\n        // Remove hidden properties.\n        UsersRouter.removeHiddenProperties(user);\n\n        return { response: user };\n      })\n      .catch(error => {\n        throw error;\n      });\n  }\n\n  handleLogOut(req) {\n    const success = { response: {} };\n    if (req.info && req.info.sessionToken) {\n      return rest\n        .find(\n          req.config,\n          Auth.master(req.config),\n          '_Session',\n          { sessionToken: req.info.sessionToken },\n          undefined,\n          req.info.clientSDK,\n          req.info.context\n        )\n        .then(records => {\n          if (records.results && records.results.length) {\n            return rest\n              .del(\n                req.config,\n                Auth.master(req.config),\n                '_Session',\n                records.results[0].objectId,\n                req.info.context\n              )\n              .then(() => {\n                this._runAfterLogoutTrigger(req, records.results[0]);\n                return Promise.resolve(success);\n              });\n          }\n          return Promise.resolve(success);\n        });\n    }\n    return Promise.resolve(success);\n  }\n\n  _runAfterLogoutTrigger(req, session) {\n    // After logout trigger\n    maybeRunTrigger(\n      TriggerTypes.afterLogout,\n      req.auth,\n      Parse.Session.fromJSON(Object.assign({ className: '_Session' }, session)),\n      null,\n      req.config\n    );\n  }\n\n  _throwOnBadEmailConfig(req) {\n    try {\n      Config.validateEmailConfiguration({\n        emailAdapter: req.config.userController.adapter,\n        appName: req.config.appName,\n        publicServerURL: req.config.publicServerURL,\n        emailVerifyTokenValidityDuration: req.config.emailVerifyTokenValidityDuration,\n        emailVerifyTokenReuseIfValid: req.config.emailVerifyTokenReuseIfValid,\n      });\n    } catch (e) {\n      if (typeof e === 'string') {\n        // Maybe we need a Bad Configuration error, but the SDKs won't understand it. For now, Internal Server Error.\n        throw new Parse.Error(\n          Parse.Error.INTERNAL_SERVER_ERROR,\n          'An appName, publicServerURL, and emailAdapter are required for password reset and email verification functionality.'\n        );\n      } else {\n        throw e;\n      }\n    }\n  }\n\n  handleResetRequest(req) {\n    this._throwOnBadEmailConfig(req);\n\n    const { email } = req.body;\n    if (!email) {\n      throw new Parse.Error(Parse.Error.EMAIL_MISSING, 'you must provide an email');\n    }\n    if (typeof email !== 'string') {\n      throw new Parse.Error(\n        Parse.Error.INVALID_EMAIL_ADDRESS,\n        'you must provide a valid email string'\n      );\n    }\n    const userController = req.config.userController;\n    return userController.sendPasswordResetEmail(email).then(\n      () => {\n        return Promise.resolve({\n          response: {},\n        });\n      },\n      err => {\n        if (err.code === Parse.Error.OBJECT_NOT_FOUND) {\n          // Return success so that this endpoint can't\n          // be used to enumerate valid emails\n          return Promise.resolve({\n            response: {},\n          });\n        } else {\n          throw err;\n        }\n      }\n    );\n  }\n\n  handleVerificationEmailRequest(req) {\n    this._throwOnBadEmailConfig(req);\n\n    const { email } = req.body;\n    if (!email) {\n      throw new Parse.Error(Parse.Error.EMAIL_MISSING, 'you must provide an email');\n    }\n    if (typeof email !== 'string') {\n      throw new Parse.Error(\n        Parse.Error.INVALID_EMAIL_ADDRESS,\n        'you must provide a valid email string'\n      );\n    }\n\n    return req.config.database.find('_User', { email: email }).then(results => {\n      if (!results.length || results.length < 1) {\n        throw new Parse.Error(Parse.Error.EMAIL_NOT_FOUND, `No user found with email ${email}`);\n      }\n      const user = results[0];\n\n      // remove password field, messes with saving on postgres\n      delete user.password;\n\n      if (user.emailVerified) {\n        throw new Parse.Error(Parse.Error.OTHER_CAUSE, `Email ${email} is already verified.`);\n      }\n\n      const userController = req.config.userController;\n      return userController.regenerateEmailVerifyToken(user).then(() => {\n        userController.sendVerificationEmail(user);\n        return { response: {} };\n      });\n    });\n  }\n\n  mountRoutes() {\n    this.route('GET', '/users', req => {\n      return this.handleFind(req);\n    });\n    this.route('POST', '/users', promiseEnsureIdempotency, req => {\n      return this.handleCreate(req);\n    });\n    this.route('GET', '/users/me', req => {\n      return this.handleMe(req);\n    });\n    this.route('GET', '/users/:objectId', req => {\n      return this.handleGet(req);\n    });\n    this.route('PUT', '/users/:objectId', promiseEnsureIdempotency, req => {\n      return this.handleUpdate(req);\n    });\n    this.route('DELETE', '/users/:objectId', req => {\n      return this.handleDelete(req);\n    });\n    this.route('GET', '/login', req => {\n      return this.handleLogIn(req);\n    });\n    this.route('POST', '/login', req => {\n      return this.handleLogIn(req);\n    });\n    this.route('POST', '/loginAs', req => {\n      return this.handleLogInAs(req);\n    });\n    this.route('POST', '/logout', req => {\n      return this.handleLogOut(req);\n    });\n    this.route('POST', '/requestPasswordReset', req => {\n      return this.handleResetRequest(req);\n    });\n    this.route('POST', '/verificationEmailRequest', req => {\n      return this.handleVerificationEmailRequest(req);\n    });\n    this.route('GET', '/verifyPassword', req => {\n      return this.handleVerifyPassword(req);\n    });\n  }\n}\n\nexport default UsersRouter;\n"]}