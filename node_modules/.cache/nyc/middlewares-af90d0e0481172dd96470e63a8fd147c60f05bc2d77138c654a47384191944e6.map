{"version":3,"sources":["../src/middlewares.js"],"names":["DEFAULT_ALLOWED_HEADERS","getMountForRequest","req","mountPathLength","originalUrl","length","url","mountPath","slice","protocol","get","handleParseHeaders","res","next","mount","context","JSON","parse","Object","prototype","toString","call","e","malformedContext","info","appId","sessionToken","masterKey","installationId","clientKey","javascriptKey","dotNetKey","restAPIKey","clientVersion","basicAuth","httpAuth","basicAuthAppId","AppCache","body","_noBody","fileViaJSON","Buffer","invalidRequest","_RevocableSession","_ApplicationId","_JavaScriptKey","_ClientVersion","_InstallationId","_SessionToken","_MasterKey","_context","_ContentType","headers","clientSDK","ClientSDK","fromString","fileData","base64","from","clientIp","getClientIp","app","config","Config","ip","masterKeyIps","indexOf","isMaster","auth","Auth","isReadOnlyMaster","readOnlyMasterKey","isReadOnly","keys","oneKeyConfigured","some","key","undefined","oneKeyMatches","userFromJWT","user","Promise","resolve","then","getAuthForLegacySessionToken","getAuthForSessionToken","catch","error","Parse","Error","loggerController","UNKNOWN_ERROR","split","connection","remoteAddress","socket","authorization","header","authPrefix","match","toLowerCase","encodedAuth","substring","credentials","decodeBase64","jsKeyPrefix","matchKey","str","allowCrossDomain","allowHeaders","join","allowOrigin","method","sendStatus","allowMethodOverride","_method","originalMethod","handleParseErrors","err","log","defaultLogger","enableExpressErrorHandler","httpStatus","code","INTERNAL_SERVER_ERROR","OBJECT_NOT_FOUND","status","json","message","process","env","TESTING","stack","enforceMasterKeyAccess","end","promiseEnforceMasterKeyAccess","request","promiseEnsureIdempotency","database","adapter","MongoStorageAdapter","requestId","paths","ttl","idempotencyOptions","reqPath","path","replace","regex","RegExp","charAt","expiryDate","Date","setSeconds","getSeconds","rest","create","master","reqId","expire","_encode","DUPLICATE_VALUE","DUPLICATE_REQUEST","INVALID_JSON"],"mappings":"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","sourcesContent":["import AppCache from './cache';\nimport Parse from 'parse/node';\nimport auth from './Auth';\nimport Config from './Config';\nimport ClientSDK from './ClientSDK';\nimport defaultLogger from './logger';\nimport rest from './rest';\nimport MongoStorageAdapter from './Adapters/Storage/Mongo/MongoStorageAdapter';\n\nexport const DEFAULT_ALLOWED_HEADERS =\n  'X-Parse-Master-Key, X-Parse-REST-API-Key, X-Parse-Javascript-Key, X-Parse-Application-Id, X-Parse-Client-Version, X-Parse-Session-Token, X-Requested-With, X-Parse-Revocable-Session, X-Parse-Request-Id, Content-Type, Pragma, Cache-Control';\n\nconst getMountForRequest = function (req) {\n  const mountPathLength = req.originalUrl.length - req.url.length;\n  const mountPath = req.originalUrl.slice(0, mountPathLength);\n  return req.protocol + '://' + req.get('host') + mountPath;\n};\n\n// Checks that the request is authorized for this app and checks user\n// auth too.\n// The bodyparser should run before this middleware.\n// Adds info to the request:\n// req.config - the Config for this app\n// req.auth - the Auth for this request\nexport function handleParseHeaders(req, res, next) {\n  var mount = getMountForRequest(req);\n\n  let context = {};\n  if (req.get('X-Parse-Cloud-Context') != null) {\n    try {\n      context = JSON.parse(req.get('X-Parse-Cloud-Context'));\n      if (Object.prototype.toString.call(context) !== '[object Object]') {\n        throw 'Context is not an object';\n      }\n    } catch (e) {\n      return malformedContext(req, res);\n    }\n  }\n  var info = {\n    appId: req.get('X-Parse-Application-Id'),\n    sessionToken: req.get('X-Parse-Session-Token'),\n    masterKey: req.get('X-Parse-Master-Key'),\n    installationId: req.get('X-Parse-Installation-Id'),\n    clientKey: req.get('X-Parse-Client-Key'),\n    javascriptKey: req.get('X-Parse-Javascript-Key'),\n    dotNetKey: req.get('X-Parse-Windows-Key'),\n    restAPIKey: req.get('X-Parse-REST-API-Key'),\n    clientVersion: req.get('X-Parse-Client-Version'),\n    context: context,\n  };\n\n  var basicAuth = httpAuth(req);\n\n  if (basicAuth) {\n    var basicAuthAppId = basicAuth.appId;\n    if (AppCache.get(basicAuthAppId)) {\n      info.appId = basicAuthAppId;\n      info.masterKey = basicAuth.masterKey || info.masterKey;\n      info.javascriptKey = basicAuth.javascriptKey || info.javascriptKey;\n    }\n  }\n\n  if (req.body) {\n    // Unity SDK sends a _noBody key which needs to be removed.\n    // Unclear at this point if action needs to be taken.\n    delete req.body._noBody;\n  }\n\n  var fileViaJSON = false;\n\n  if (!info.appId || !AppCache.get(info.appId)) {\n    // See if we can find the app id on the body.\n    if (req.body instanceof Buffer) {\n      // The only chance to find the app id is if this is a file\n      // upload that actually is a JSON body. So try to parse it.\n      // https://github.com/parse-community/parse-server/issues/6589\n      // It is also possible that the client is trying to upload a file but forgot\n      // to provide x-parse-app-id in header and parse a binary file will fail\n      try {\n        req.body = JSON.parse(req.body);\n      } catch (e) {\n        return invalidRequest(req, res);\n      }\n      fileViaJSON = true;\n    }\n\n    if (req.body) {\n      delete req.body._RevocableSession;\n    }\n\n    if (\n      req.body &&\n      req.body._ApplicationId &&\n      AppCache.get(req.body._ApplicationId) &&\n      (!info.masterKey || AppCache.get(req.body._ApplicationId).masterKey === info.masterKey)\n    ) {\n      info.appId = req.body._ApplicationId;\n      info.javascriptKey = req.body._JavaScriptKey || '';\n      delete req.body._ApplicationId;\n      delete req.body._JavaScriptKey;\n      // TODO: test that the REST API formats generated by the other\n      // SDKs are handled ok\n      if (req.body._ClientVersion) {\n        info.clientVersion = req.body._ClientVersion;\n        delete req.body._ClientVersion;\n      }\n      if (req.body._InstallationId) {\n        info.installationId = req.body._InstallationId;\n        delete req.body._InstallationId;\n      }\n      if (req.body._SessionToken) {\n        info.sessionToken = req.body._SessionToken;\n        delete req.body._SessionToken;\n      }\n      if (req.body._MasterKey) {\n        info.masterKey = req.body._MasterKey;\n        delete req.body._MasterKey;\n      }\n      if (req.body._context) {\n        if (req.body._context instanceof Object) {\n          info.context = req.body._context;\n        } else {\n          try {\n            info.context = JSON.parse(req.body._context);\n            if (Object.prototype.toString.call(info.context) !== '[object Object]') {\n              throw 'Context is not an object';\n            }\n          } catch (e) {\n            return malformedContext(req, res);\n          }\n        }\n        delete req.body._context;\n      }\n      if (req.body._ContentType) {\n        req.headers['content-type'] = req.body._ContentType;\n        delete req.body._ContentType;\n      }\n    } else {\n      return invalidRequest(req, res);\n    }\n  }\n\n  if (info.sessionToken && typeof info.sessionToken !== 'string') {\n    info.sessionToken = info.sessionToken.toString();\n  }\n\n  if (info.clientVersion) {\n    info.clientSDK = ClientSDK.fromString(info.clientVersion);\n  }\n\n  if (fileViaJSON) {\n    req.fileData = req.body.fileData;\n    // We need to repopulate req.body with a buffer\n    var base64 = req.body.base64;\n    req.body = Buffer.from(base64, 'base64');\n  }\n\n  const clientIp = getClientIp(req);\n\n  info.app = AppCache.get(info.appId);\n  req.config = Config.get(info.appId, mount);\n  req.config.headers = req.headers || {};\n  req.config.ip = clientIp;\n  req.info = info;\n\n  if (\n    info.masterKey &&\n    req.config.masterKeyIps &&\n    req.config.masterKeyIps.length !== 0 &&\n    req.config.masterKeyIps.indexOf(clientIp) === -1\n  ) {\n    return invalidRequest(req, res);\n  }\n\n  var isMaster = info.masterKey === req.config.masterKey;\n\n  if (isMaster) {\n    req.auth = new auth.Auth({\n      config: req.config,\n      installationId: info.installationId,\n      isMaster: true,\n    });\n    next();\n    return;\n  }\n\n  var isReadOnlyMaster = info.masterKey === req.config.readOnlyMasterKey;\n  if (\n    typeof req.config.readOnlyMasterKey != 'undefined' &&\n    req.config.readOnlyMasterKey &&\n    isReadOnlyMaster\n  ) {\n    req.auth = new auth.Auth({\n      config: req.config,\n      installationId: info.installationId,\n      isMaster: true,\n      isReadOnly: true,\n    });\n    next();\n    return;\n  }\n\n  // Client keys are not required in parse-server, but if any have been configured in the server, validate them\n  //  to preserve original behavior.\n  const keys = ['clientKey', 'javascriptKey', 'dotNetKey', 'restAPIKey'];\n  const oneKeyConfigured = keys.some(function (key) {\n    return req.config[key] !== undefined;\n  });\n  const oneKeyMatches = keys.some(function (key) {\n    return req.config[key] !== undefined && info[key] === req.config[key];\n  });\n\n  if (oneKeyConfigured && !oneKeyMatches) {\n    return invalidRequest(req, res);\n  }\n\n  if (req.url == '/login') {\n    delete info.sessionToken;\n  }\n\n  if (req.userFromJWT) {\n    req.auth = new auth.Auth({\n      config: req.config,\n      installationId: info.installationId,\n      isMaster: false,\n      user: req.userFromJWT,\n    });\n    next();\n    return;\n  }\n\n  if (!info.sessionToken) {\n    req.auth = new auth.Auth({\n      config: req.config,\n      installationId: info.installationId,\n      isMaster: false,\n    });\n    next();\n    return;\n  }\n\n  return Promise.resolve()\n    .then(() => {\n      // handle the upgradeToRevocableSession path on it's own\n      if (\n        info.sessionToken &&\n        req.url === '/upgradeToRevocableSession' &&\n        info.sessionToken.indexOf('r:') != 0\n      ) {\n        return auth.getAuthForLegacySessionToken({\n          config: req.config,\n          installationId: info.installationId,\n          sessionToken: info.sessionToken,\n        });\n      } else {\n        return auth.getAuthForSessionToken({\n          config: req.config,\n          installationId: info.installationId,\n          sessionToken: info.sessionToken,\n        });\n      }\n    })\n    .then(auth => {\n      if (auth) {\n        req.auth = auth;\n        next();\n      }\n    })\n    .catch(error => {\n      if (error instanceof Parse.Error) {\n        next(error);\n        return;\n      } else {\n        // TODO: Determine the correct error scenario.\n        req.config.loggerController.error('error getting auth for sessionToken', error);\n        throw new Parse.Error(Parse.Error.UNKNOWN_ERROR, error);\n      }\n    });\n}\n\nfunction getClientIp(req) {\n  if (req.headers['x-forwarded-for']) {\n    // try to get from x-forwared-for if it set (behind reverse proxy)\n    return req.headers['x-forwarded-for'].split(',')[0];\n  } else if (req.connection && req.connection.remoteAddress) {\n    // no proxy, try getting from connection.remoteAddress\n    return req.connection.remoteAddress;\n  } else if (req.socket) {\n    // try to get it from req.socket\n    return req.socket.remoteAddress;\n  } else if (req.connection && req.connection.socket) {\n    // try to get it form the connection.socket\n    return req.connection.socket.remoteAddress;\n  } else {\n    // if non above, fallback.\n    return req.ip;\n  }\n}\n\nfunction httpAuth(req) {\n  if (!(req.req || req).headers.authorization) return;\n\n  var header = (req.req || req).headers.authorization;\n  var appId, masterKey, javascriptKey;\n\n  // parse header\n  var authPrefix = 'basic ';\n\n  var match = header.toLowerCase().indexOf(authPrefix);\n\n  if (match == 0) {\n    var encodedAuth = header.substring(authPrefix.length, header.length);\n    var credentials = decodeBase64(encodedAuth).split(':');\n\n    if (credentials.length == 2) {\n      appId = credentials[0];\n      var key = credentials[1];\n\n      var jsKeyPrefix = 'javascript-key=';\n\n      var matchKey = key.indexOf(jsKeyPrefix);\n      if (matchKey == 0) {\n        javascriptKey = key.substring(jsKeyPrefix.length, key.length);\n      } else {\n        masterKey = key;\n      }\n    }\n  }\n\n  return { appId: appId, masterKey: masterKey, javascriptKey: javascriptKey };\n}\n\nfunction decodeBase64(str) {\n  return Buffer.from(str, 'base64').toString();\n}\n\nexport function allowCrossDomain(appId) {\n  return (req, res, next) => {\n    const config = Config.get(appId, getMountForRequest(req));\n    let allowHeaders = DEFAULT_ALLOWED_HEADERS;\n    if (config && config.allowHeaders) {\n      allowHeaders += `, ${config.allowHeaders.join(', ')}`;\n    }\n    const allowOrigin = (config && config.allowOrigin) || '*';\n    res.header('Access-Control-Allow-Origin', allowOrigin);\n    res.header('Access-Control-Allow-Methods', 'GET,PUT,POST,DELETE,OPTIONS');\n    res.header('Access-Control-Allow-Headers', allowHeaders);\n    res.header('Access-Control-Expose-Headers', 'X-Parse-Job-Status-Id, X-Parse-Push-Status-Id');\n    // intercept OPTIONS method\n    if ('OPTIONS' == req.method) {\n      res.sendStatus(200);\n    } else {\n      next();\n    }\n  };\n}\n\nexport function allowMethodOverride(req, res, next) {\n  if (req.method === 'POST' && req.body._method) {\n    req.originalMethod = req.method;\n    req.method = req.body._method;\n    delete req.body._method;\n  }\n  next();\n}\n\nexport function handleParseErrors(err, req, res, next) {\n  const log = (req.config && req.config.loggerController) || defaultLogger;\n  if (err instanceof Parse.Error) {\n    if (req.config && req.config.enableExpressErrorHandler) {\n      return next(err);\n    }\n    let httpStatus;\n    // TODO: fill out this mapping\n    switch (err.code) {\n      case Parse.Error.INTERNAL_SERVER_ERROR:\n        httpStatus = 500;\n        break;\n      case Parse.Error.OBJECT_NOT_FOUND:\n        httpStatus = 404;\n        break;\n      default:\n        httpStatus = 400;\n    }\n    res.status(httpStatus);\n    res.json({ code: err.code, error: err.message });\n    log.error('Parse error: ', err);\n  } else if (err.status && err.message) {\n    res.status(err.status);\n    res.json({ error: err.message });\n    if (!(process && process.env.TESTING)) {\n      next(err);\n    }\n  } else {\n    log.error('Uncaught internal server error.', err, err.stack);\n    res.status(500);\n    res.json({\n      code: Parse.Error.INTERNAL_SERVER_ERROR,\n      message: 'Internal server error.',\n    });\n    if (!(process && process.env.TESTING)) {\n      next(err);\n    }\n  }\n}\n\nexport function enforceMasterKeyAccess(req, res, next) {\n  if (!req.auth.isMaster) {\n    res.status(403);\n    res.end('{\"error\":\"unauthorized: master key is required\"}');\n    return;\n  }\n  next();\n}\n\nexport function promiseEnforceMasterKeyAccess(request) {\n  if (!request.auth.isMaster) {\n    const error = new Error();\n    error.status = 403;\n    error.message = 'unauthorized: master key is required';\n    throw error;\n  }\n  return Promise.resolve();\n}\n\n/**\n * Deduplicates a request to ensure idempotency. Duplicates are determined by the request ID\n * in the request header. If a request has no request ID, it is executed anyway.\n * @param {*} req The request to evaluate.\n * @returns Promise<{}>\n */\nexport function promiseEnsureIdempotency(req) {\n  // Enable feature only for MongoDB\n  if (!(req.config.database.adapter instanceof MongoStorageAdapter)) {\n    return Promise.resolve();\n  }\n  // Get parameters\n  const config = req.config;\n  const requestId = ((req || {}).headers || {})['x-parse-request-id'];\n  const { paths, ttl } = config.idempotencyOptions;\n  if (!requestId || !config.idempotencyOptions) {\n    return Promise.resolve();\n  }\n  // Request path may contain trailing slashes, depending on the original request, so remove\n  // leading and trailing slashes to make it easier to specify paths in the configuration\n  const reqPath = req.path.replace(/^\\/|\\/$/, '');\n  // Determine whether idempotency is enabled for current request path\n  let match = false;\n  for (const path of paths) {\n    // Assume one wants a path to always match from the beginning to prevent any mistakes\n    const regex = new RegExp(path.charAt(0) === '^' ? path : '^' + path);\n    if (reqPath.match(regex)) {\n      match = true;\n      break;\n    }\n  }\n  if (!match) {\n    return Promise.resolve();\n  }\n  // Try to store request\n  const expiryDate = new Date(new Date().setSeconds(new Date().getSeconds() + ttl));\n  return rest\n    .create(config, auth.master(config), '_Idempotency', {\n      reqId: requestId,\n      expire: Parse._encode(expiryDate),\n    })\n    .catch(e => {\n      if (e.code == Parse.Error.DUPLICATE_VALUE) {\n        throw new Parse.Error(Parse.Error.DUPLICATE_REQUEST, 'Duplicate request');\n      }\n      throw e;\n    });\n}\n\nfunction invalidRequest(req, res) {\n  res.status(403);\n  res.end('{\"error\":\"unauthorized\"}');\n}\n\nfunction malformedContext(req, res) {\n  res.status(400);\n  res.json({ code: Parse.Error.INVALID_JSON, error: 'Invalid object for context.' });\n}\n"]}