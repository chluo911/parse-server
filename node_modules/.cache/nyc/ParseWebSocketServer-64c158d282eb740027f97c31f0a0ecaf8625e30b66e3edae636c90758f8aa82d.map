{"version":3,"sources":["../../src/LiveQuery/ParseWebSocketServer.js"],"names":["ParseWebSocketServer","constructor","server","onConnect","config","wss","wssAdapter","WSAdapter","onListen","logger","info","onConnection","ws","on","error","message","ParseWebSocket","pingIntervalId","setInterval","readyState","OPEN","ping","clearInterval","websocketTimeout","onError","start","close","events","EventEmitter","onmessage","request","emit","data","onclose","send"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;;;AAEO,MAAMA,oBAAN,CAA2B;AAGhCC,EAAAA,WAAW,CAACC,MAAD,EAAcC,SAAd,EAAmCC,MAAnC,EAA2C;AACpDA,IAAAA,MAAM,CAACF,MAAP,GAAgBA,MAAhB;AACA,UAAMG,GAAG,GAAG,gCAAYD,MAAM,CAACE,UAAnB,EAA+BC,oBAA/B,EAA0CH,MAA1C,CAAZ;;AACAC,IAAAA,GAAG,CAACG,QAAJ,GAAe,MAAM;AACnBC,sBAAOC,IAAP,CAAY,wCAAZ;AACD,KAFD;;AAGAL,IAAAA,GAAG,CAACM,YAAJ,GAAmBC,EAAE,IAAI;AACvBA,MAAAA,EAAE,CAACC,EAAH,CAAM,OAAN,EAAeC,KAAK,IAAI;AACtBL,wBAAOK,KAAP,CAAaA,KAAK,CAACC,OAAnB;;AACAN,wBAAOK,KAAP,CAAa,mBAAQF,EAAR,EAAY,KAAZ,CAAb;AACD,OAHD;AAIAT,MAAAA,SAAS,CAAC,IAAIa,cAAJ,CAAmBJ,EAAnB,CAAD,CAAT,CALuB,CAMvB;;AACA,YAAMK,cAAc,GAAGC,WAAW,CAAC,MAAM;AACvC,YAAIN,EAAE,CAACO,UAAH,IAAiBP,EAAE,CAACQ,IAAxB,EAA8B;AAC5BR,UAAAA,EAAE,CAACS,IAAH;AACD,SAFD,MAEO;AACLC,UAAAA,aAAa,CAACL,cAAD,CAAb;AACD;AACF,OANiC,EAM/Bb,MAAM,CAACmB,gBAAP,IAA2B,KAAK,IAND,CAAlC;AAOD,KAdD;;AAeAlB,IAAAA,GAAG,CAACmB,OAAJ,GAAcV,KAAK,IAAI;AACrBL,sBAAOK,KAAP,CAAaA,KAAb;AACD,KAFD;;AAGAT,IAAAA,GAAG,CAACoB,KAAJ;AACA,SAAKvB,MAAL,GAAcG,GAAd;AACD;;AAEDqB,EAAAA,KAAK,GAAG;AACN,QAAI,KAAKxB,MAAL,IAAe,KAAKA,MAAL,CAAYwB,KAA/B,EAAsC;AACpC,WAAKxB,MAAL,CAAYwB,KAAZ;AACD;AACF;;AAnC+B;;;;AAsC3B,MAAMV,cAAN,SAA6BW,gBAAOC,YAApC,CAAiD;AAGtD3B,EAAAA,WAAW,CAACW,EAAD,EAAU;AACnB;;AACAA,IAAAA,EAAE,CAACiB,SAAH,GAAeC,OAAO,IACpB,KAAKC,IAAL,CAAU,SAAV,EAAqBD,OAAO,IAAIA,OAAO,CAACE,IAAnB,GAA0BF,OAAO,CAACE,IAAlC,GAAyCF,OAA9D,CADF;;AAEAlB,IAAAA,EAAE,CAACqB,OAAH,GAAa,MAAM,KAAKF,IAAL,CAAU,YAAV,CAAnB;;AACA,SAAKnB,EAAL,GAAUA,EAAV;AACD;;AAEDsB,EAAAA,IAAI,CAACnB,OAAD,EAAqB;AACvB,SAAKH,EAAL,CAAQsB,IAAR,CAAanB,OAAb;AACD;;AAbqD","sourcesContent":["import { loadAdapter } from '../Adapters/AdapterLoader';\nimport { WSAdapter } from '../Adapters/WebSocketServer/WSAdapter';\nimport logger from '../logger';\nimport events from 'events';\nimport { inspect } from 'util';\n\nexport class ParseWebSocketServer {\n  server: Object;\n\n  constructor(server: any, onConnect: Function, config) {\n    config.server = server;\n    const wss = loadAdapter(config.wssAdapter, WSAdapter, config);\n    wss.onListen = () => {\n      logger.info('Parse LiveQuery Server started running');\n    };\n    wss.onConnection = ws => {\n      ws.on('error', error => {\n        logger.error(error.message);\n        logger.error(inspect(ws, false));\n      });\n      onConnect(new ParseWebSocket(ws));\n      // Send ping to client periodically\n      const pingIntervalId = setInterval(() => {\n        if (ws.readyState == ws.OPEN) {\n          ws.ping();\n        } else {\n          clearInterval(pingIntervalId);\n        }\n      }, config.websocketTimeout || 10 * 1000);\n    };\n    wss.onError = error => {\n      logger.error(error);\n    };\n    wss.start();\n    this.server = wss;\n  }\n\n  close() {\n    if (this.server && this.server.close) {\n      this.server.close();\n    }\n  }\n}\n\nexport class ParseWebSocket extends events.EventEmitter {\n  ws: any;\n\n  constructor(ws: any) {\n    super();\n    ws.onmessage = request =>\n      this.emit('message', request && request.data ? request.data : request);\n    ws.onclose = () => this.emit('disconnect');\n    this.ws = ws;\n  }\n\n  send(message: any): void {\n    this.ws.send(message);\n  }\n}\n"]}