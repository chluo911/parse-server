{"version":3,"sources":["../../src/Routers/AggregateRouter.js"],"names":["AggregateRouter","ClassesRouter","handleFind","req","body","Object","assign","JSONFromQuery","query","options","distinct","String","hint","explain","readPreference","pipeline","getPipeline","where","JSON","parse","rest","find","config","auth","className","info","clientSDK","context","then","response","result","results","UsersRouter","removeHiddenProperties","Array","isArray","keys","map","key","stage","length","Error","join","transformStage","stageName","prototype","hasOwnProperty","call","Deprecator","logRuntimeDeprecation","usage","solution","_id","objectId","Parse","INVALID_QUERY","mountRoutes","route","middleware","promiseEnforceMasterKeyAccess"],"mappings":"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","sourcesContent":["import ClassesRouter from './ClassesRouter';\nimport rest from '../rest';\nimport * as middleware from '../middlewares';\nimport Parse from 'parse/node';\nimport UsersRouter from './UsersRouter';\nimport Deprecator from '../Deprecator/Deprecator';\n\nexport class AggregateRouter extends ClassesRouter {\n  handleFind(req) {\n    const body = Object.assign(req.body, ClassesRouter.JSONFromQuery(req.query));\n    const options = {};\n    if (body.distinct) {\n      options.distinct = String(body.distinct);\n    }\n    if (body.hint) {\n      options.hint = body.hint;\n      delete body.hint;\n    }\n    if (body.explain) {\n      options.explain = body.explain;\n      delete body.explain;\n    }\n    if (body.readPreference) {\n      options.readPreference = body.readPreference;\n      delete body.readPreference;\n    }\n    options.pipeline = AggregateRouter.getPipeline(body);\n    if (typeof body.where === 'string') {\n      body.where = JSON.parse(body.where);\n    }\n    return rest\n      .find(\n        req.config,\n        req.auth,\n        this.className(req),\n        body.where,\n        options,\n        req.info.clientSDK,\n        req.info.context\n      )\n      .then(response => {\n        for (const result of response.results) {\n          if (typeof result === 'object') {\n            UsersRouter.removeHiddenProperties(result);\n          }\n        }\n        return { response };\n      });\n  }\n\n  /* Builds a pipeline from the body. Originally the body could be passed as a single object,\n   * and now we support many options\n   *\n   * Array\n   *\n   * body: [{\n   *   group: { objectId: '$name' },\n   * }]\n   *\n   * Object\n   *\n   * body: {\n   *   group: { objectId: '$name' },\n   * }\n   *\n   *\n   * Pipeline Operator with an Array or an Object\n   *\n   * body: {\n   *   pipeline: {\n   *     group: { objectId: '$name' },\n   *   }\n   * }\n   *\n   */\n  static getPipeline(body) {\n    let pipeline = body.pipeline || body;\n    if (!Array.isArray(pipeline)) {\n      pipeline = Object.keys(pipeline).map(key => {\n        return { [key]: pipeline[key] };\n      });\n    }\n\n    return pipeline.map(stage => {\n      const keys = Object.keys(stage);\n      if (keys.length != 1) {\n        throw new Error(`Pipeline stages should only have one key found ${keys.join(', ')}`);\n      }\n      return AggregateRouter.transformStage(keys[0], stage);\n    });\n  }\n\n  static transformStage(stageName, stage) {\n    if (stageName === 'group') {\n      if (Object.prototype.hasOwnProperty.call(stage[stageName], 'objectId')) {\n        Deprecator.logRuntimeDeprecation({\n          usage: 'The use of objectId in aggregation stage $group',\n          solution: 'Use _id instead.',\n        });\n        stage[stageName]._id = stage[stageName].objectId;\n        delete stage[stageName].objectId;\n      }\n      if (!Object.prototype.hasOwnProperty.call(stage[stageName], '_id')) {\n        throw new Parse.Error(\n          Parse.Error.INVALID_QUERY,\n          `Invalid parameter for query: group. Missing key _id`\n        );\n      }\n    }\n\n    if (stageName[0] !== '$') {\n      Deprecator.logRuntimeDeprecation({\n        usage: \"Using aggregation stages without a leading '$'\",\n        solution: `Try $${stageName} instead.`,\n      });\n    }\n    const key = stageName[0] === '$' ? stageName : `$${stageName}`;\n    return { [key]: stage[stageName] };\n  }\n\n  mountRoutes() {\n    this.route('GET', '/aggregate/:className', middleware.promiseEnforceMasterKeyAccess, req => {\n      return this.handleFind(req);\n    });\n  }\n}\n\nexport default AggregateRouter;\n"]}