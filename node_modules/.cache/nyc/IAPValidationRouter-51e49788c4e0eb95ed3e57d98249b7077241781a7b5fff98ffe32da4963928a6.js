"use strict";function cov_tq1wiin2x(){var path="/parse-server/lib/Routers/IAPValidationRouter.js";var hash="a5bdd79ae7e9ffc2c46e096059356505a7dc8844";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"/parse-server/lib/Routers/IAPValidationRouter.js",statementMap:{"0":{start:{line:3,column:0},end:{line:5,column:3}},"1":{start:{line:6,column:0},end:{line:6,column:37}},"2":{start:{line:8,column:21},end:{line:8,column:72}},"3":{start:{line:10,column:12},end:{line:10,column:57}},"4":{start:{line:12,column:39},end:{line:12,column:93}},"5":{start:{line:14,column:16},end:{line:14,column:37}},"6":{start:{line:16,column:13},end:{line:16,column:31}},"7":{start:{line:19,column:24},end:{line:19,column:72}},"8":{start:{line:20,column:27},end:{line:20,column:71}},"9":{start:{line:21,column:25},end:{line:30,column:1}},"10":{start:{line:33,column:2},end:{line:33,column:28}},"11":{start:{line:34,column:20},end:{line:34,column:64}},"12":{start:{line:35,column:2},end:{line:38,column:4}},"13":{start:{line:42,column:2},end:{line:61,column:5}},"14":{start:{line:52,column:17},end:{line:52,column:34}},"15":{start:{line:54,column:4},end:{line:57,column:5}},"16":{start:{line:56,column:6},end:{line:56,column:13}},"17":{start:{line:60,column:4},end:{line:60,column:15}},"18":{start:{line:65,column:2},end:{line:79,column:5}},"19":{start:{line:68,column:21},end:{line:68,column:35}},"20":{start:{line:70,column:4},end:{line:73,column:5}},"21":{start:{line:72,column:6},end:{line:72,column:95}},"22":{start:{line:75,column:19},end:{line:75,column:39}},"23":{start:{line:76,column:4},end:{line:78,column:7}},"24":{start:{line:84,column:18},end:{line:84,column:34}},"25":{start:{line:85,column:30},end:{line:85,column:56}},"26":{start:{line:87,column:4},end:{line:90,column:5}},"27":{start:{line:89,column:6},end:{line:89,column:110}},"28":{start:{line:94,column:4},end:{line:98,column:5}},"29":{start:{line:95,column:6},end:{line:97,column:7}},"30":{start:{line:96,column:8},end:{line:96,column:33}},"31":{start:{line:100,column:4},end:{line:102,column:5}},"32":{start:{line:101,column:6},end:{line:101,column:65}},"33":{start:{line:105,column:6},end:{line:105,column:65}},"34":{start:{line:109,column:6},end:{line:111,column:9}},"35":{start:{line:114,column:4},end:{line:126,column:7}},"36":{start:{line:115,column:6},end:{line:115,column:31}},"37":{start:{line:117,column:6},end:{line:123,column:7}},"38":{start:{line:118,column:8},end:{line:122,column:11}},"39":{start:{line:119,column:10},end:{line:119,column:35}},"40":{start:{line:121,column:10},end:{line:121,column:38}},"41":{start:{line:125,column:6},end:{line:125,column:34}},"42":{start:{line:130,column:4},end:{line:130,column:65}},"43":{start:{line:135,column:0},end:{line:135,column:50}}},fnMap:{"0":{name:"_interopRequireDefault",decl:{start:{line:12,column:9},end:{line:12,column:31}},loc:{start:{line:12,column:37},end:{line:12,column:95}},line:12},"1":{name:"appStoreError",decl:{start:{line:32,column:9},end:{line:32,column:22}},loc:{start:{line:32,column:31},end:{line:39,column:1}},line:32},"2":{name:"validateWithAppStore",decl:{start:{line:41,column:9},end:{line:41,column:29}},loc:{start:{line:41,column:44},end:{line:62,column:1}},line:41},"3":{name:"(anonymous_3)",decl:{start:{line:51,column:10},end:{line:51,column:11}},loc:{start:{line:51,column:26},end:{line:61,column:3}},line:51},"4":{name:"getFileForProductIdentifier",decl:{start:{line:64,column:9},end:{line:64,column:36}},loc:{start:{line:64,column:61},end:{line:80,column:1}},line:64},"5":{name:"(anonymous_5)",decl:{start:{line:67,column:59},end:{line:67,column:60}},loc:{start:{line:67,column:77},end:{line:79,column:3}},line:67},"6":{name:"(anonymous_6)",decl:{start:{line:83,column:2},end:{line:83,column:3}},loc:{start:{line:83,column:21},end:{line:127,column:3}},line:83},"7":{name:"successCallback",decl:{start:{line:104,column:13},end:{line:104,column:28}},loc:{start:{line:104,column:31},end:{line:106,column:5}},line:104},"8":{name:"errorCallback",decl:{start:{line:108,column:13},end:{line:108,column:26}},loc:{start:{line:108,column:34},end:{line:112,column:5}},line:108},"9":{name:"(anonymous_9)",decl:{start:{line:114,column:66},end:{line:114,column:67}},loc:{start:{line:114,column:72},end:{line:116,column:5}},line:114},"10":{name:"(anonymous_10)",decl:{start:{line:116,column:7},end:{line:116,column:8}},loc:{start:{line:116,column:16},end:{line:126,column:5}},line:116},"11":{name:"(anonymous_11)",decl:{start:{line:118,column:67},end:{line:118,column:68}},loc:{start:{line:118,column:73},end:{line:120,column:9}},line:118},"12":{name:"(anonymous_12)",decl:{start:{line:120,column:11},end:{line:120,column:12}},loc:{start:{line:120,column:20},end:{line:122,column:9}},line:120},"13":{name:"(anonymous_13)",decl:{start:{line:129,column:2},end:{line:129,column:3}},loc:{start:{line:129,column:16},end:{line:131,column:3}},line:129}},branchMap:{"0":{loc:{start:{line:12,column:46},end:{line:12,column:92}},type:"cond-expr",locations:[{start:{line:12,column:70},end:{line:12,column:73}},{start:{line:12,column:76},end:{line:12,column:92}}],line:12},"1":{loc:{start:{line:12,column:46},end:{line:12,column:67}},type:"binary-expr",locations:[{start:{line:12,column:46},end:{line:12,column:49}},{start:{line:12,column:53},end:{line:12,column:67}}],line:12},"2":{loc:{start:{line:34,column:20},end:{line:34,column:64}},type:"binary-expr",locations:[{start:{line:34,column:20},end:{line:34,column:44}},{start:{line:34,column:48},end:{line:34,column:64}}],line:34},"3":{loc:{start:{line:54,column:4},end:{line:57,column:5}},type:"if",locations:[{start:{line:54,column:4},end:{line:57,column:5}},{start:{line:54,column:4},end:{line:57,column:5}}],line:54},"4":{loc:{start:{line:54,column:8},end:{line:54,column:33}},type:"binary-expr",locations:[{start:{line:54,column:8},end:{line:54,column:12}},{start:{line:54,column:16},end:{line:54,column:33}}],line:54},"5":{loc:{start:{line:70,column:4},end:{line:73,column:5}},type:"if",locations:[{start:{line:70,column:4},end:{line:73,column:5}},{start:{line:70,column:4},end:{line:73,column:5}}],line:70},"6":{loc:{start:{line:70,column:8},end:{line:70,column:41}},type:"binary-expr",locations:[{start:{line:70,column:8},end:{line:70,column:17}},{start:{line:70,column:21},end:{line:70,column:41}}],line:70},"7":{loc:{start:{line:87,column:4},end:{line:90,column:5}},type:"if",locations:[{start:{line:87,column:4},end:{line:90,column:5}},{start:{line:87,column:4},end:{line:90,column:5}}],line:87},"8":{loc:{start:{line:87,column:8},end:{line:87,column:38}},type:"binary-expr",locations:[{start:{line:87,column:8},end:{line:87,column:16}},{start:{line:87,column:20},end:{line:87,column:38}}],line:87},"9":{loc:{start:{line:94,column:4},end:{line:98,column:5}},type:"if",locations:[{start:{line:94,column:4},end:{line:98,column:5}},{start:{line:94,column:4},end:{line:98,column:5}}],line:94},"10":{loc:{start:{line:95,column:6},end:{line:97,column:7}},type:"if",locations:[{start:{line:95,column:6},end:{line:97,column:7}},{start:{line:95,column:6},end:{line:97,column:7}}],line:95},"11":{loc:{start:{line:100,column:4},end:{line:102,column:5}},type:"if",locations:[{start:{line:100,column:4},end:{line:102,column:5}},{start:{line:100,column:4},end:{line:102,column:5}}],line:100},"12":{loc:{start:{line:100,column:8},end:{line:100,column:71}},type:"binary-expr",locations:[{start:{line:100,column:8},end:{line:100,column:34}},{start:{line:100,column:38},end:{line:100,column:71}}],line:100},"13":{loc:{start:{line:117,column:6},end:{line:123,column:7}},type:"if",locations:[{start:{line:117,column:6},end:{line:123,column:7}},{start:{line:117,column:6},end:{line:123,column:7}}],line:117}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0},b:{"0":[0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0],"7":[0,0],"8":[0,0],"9":[0,0],"10":[0,0],"11":[0,0],"12":[0,0],"13":[0,0]},inputSourceMap:{version:3,sources:["../../src/Routers/IAPValidationRouter.js"],names:["request","require","rest","IAP_SANDBOX_URL","IAP_PRODUCTION_URL","APP_STORE_ERRORS","appStoreError","status","parseInt","errorString","error","validateWithAppStore","url","receipt","method","body","headers","then","httpResponse","data","getFileForProductIdentifier","productIdentifier","req","find","config","auth","undefined","info","clientSDK","context","result","products","results","length","Parse","Error","OBJECT_NOT_FOUND","download","Promise","resolve","response","IAPValidationRouter","PromiseRouter","handleRequest","INVALID_JSON","base64","process","env","TESTING","bypassAppStoreValidation","successCallback","errorCallback","mountRoutes","route"],mappings:"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",sourcesContent:["import PromiseRouter from '../PromiseRouter';\nconst request = require('../request');\nconst rest = require('../rest');\nimport Parse from 'parse/node';\n\n// TODO move validation logic in IAPValidationController\nconst IAP_SANDBOX_URL = 'https://sandbox.itunes.apple.com/verifyReceipt';\nconst IAP_PRODUCTION_URL = 'https://buy.itunes.apple.com/verifyReceipt';\n\nconst APP_STORE_ERRORS = {\n  21000: 'The App Store could not read the JSON object you provided.',\n  21002: 'The data in the receipt-data property was malformed or missing.',\n  21003: 'The receipt could not be authenticated.',\n  21004: 'The shared secret you provided does not match the shared secret on file for your account.',\n  21005: 'The receipt server is not currently available.',\n  21006: 'This receipt is valid but the subscription has expired.',\n  21007: 'This receipt is from the test environment, but it was sent to the production environment for verification. Send it to the test environment instead.',\n  21008: 'This receipt is from the production environment, but it was sent to the test environment for verification. Send it to the production environment instead.',\n};\n\nfunction appStoreError(status) {\n  status = parseInt(status);\n  var errorString = APP_STORE_ERRORS[status] || 'unknown error.';\n  return { status: status, error: errorString };\n}\n\nfunction validateWithAppStore(url, receipt) {\n  return request({\n    url: url,\n    method: 'POST',\n    body: { 'receipt-data': receipt },\n    headers: {\n      'Content-Type': 'application/json',\n    },\n  }).then(httpResponse => {\n    const body = httpResponse.data;\n    if (body && body.status === 0) {\n      // No need to pass anything, status is OK\n      return;\n    }\n    // receipt is from test and should go to test\n    throw body;\n  });\n}\n\nfunction getFileForProductIdentifier(productIdentifier, req) {\n  return rest\n    .find(\n      req.config,\n      req.auth,\n      '_Product',\n      { productIdentifier: productIdentifier },\n      undefined,\n      req.info.clientSDK,\n      req.info.context\n    )\n    .then(function (result) {\n      const products = result.results;\n      if (!products || products.length != 1) {\n        // Error not found or too many\n        throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Object not found.');\n      }\n\n      var download = products[0].download;\n      return Promise.resolve({ response: download });\n    });\n}\n\nexport class IAPValidationRouter extends PromiseRouter {\n  handleRequest(req) {\n    let receipt = req.body.receipt;\n    const productIdentifier = req.body.productIdentifier;\n\n    if (!receipt || !productIdentifier) {\n      // TODO: Error, malformed request\n      throw new Parse.Error(Parse.Error.INVALID_JSON, 'missing receipt or productIdentifier');\n    }\n\n    // Transform the object if there\n    // otherwise assume it's in Base64 already\n    if (typeof receipt == 'object') {\n      if (receipt['__type'] == 'Bytes') {\n        receipt = receipt.base64;\n      }\n    }\n\n    if (process.env.TESTING == '1' && req.body.bypassAppStoreValidation) {\n      return getFileForProductIdentifier(productIdentifier, req);\n    }\n\n    function successCallback() {\n      return getFileForProductIdentifier(productIdentifier, req);\n    }\n\n    function errorCallback(error) {\n      return Promise.resolve({ response: appStoreError(error.status) });\n    }\n\n    return validateWithAppStore(IAP_PRODUCTION_URL, receipt).then(\n      () => {\n        return successCallback();\n      },\n      error => {\n        if (error.status == 21007) {\n          return validateWithAppStore(IAP_SANDBOX_URL, receipt).then(\n            () => {\n              return successCallback();\n            },\n            error => {\n              return errorCallback(error);\n            }\n          );\n        }\n\n        return errorCallback(error);\n      }\n    );\n  }\n\n  mountRoutes() {\n    this.route('POST', '/validate_purchase', this.handleRequest);\n  }\n}\n"]},_coverageSchema:"1a1c01bbd47fc00a2c39e90264f33305004495a9",hash:"a5bdd79ae7e9ffc2c46e096059356505a7dc8844"};var coverage=global[gcv]||(global[gcv]={});if(!coverage[path]||coverage[path].hash!==hash){coverage[path]=coverageData;}var actualCoverage=coverage[path];{// @ts-ignore
cov_tq1wiin2x=function(){return actualCoverage;};}return actualCoverage;}cov_tq1wiin2x();cov_tq1wiin2x().s[0]++;Object.defineProperty(exports,"__esModule",{value:true});cov_tq1wiin2x().s[1]++;exports.IAPValidationRouter=void 0;var _PromiseRouter=(cov_tq1wiin2x().s[2]++,_interopRequireDefault(require("../PromiseRouter")));var _node=(cov_tq1wiin2x().s[3]++,_interopRequireDefault(require("parse/node")));function _interopRequireDefault(obj){cov_tq1wiin2x().f[0]++;cov_tq1wiin2x().s[4]++;return(cov_tq1wiin2x().b[1][0]++,obj)&&(cov_tq1wiin2x().b[1][1]++,obj.__esModule)?(cov_tq1wiin2x().b[0][0]++,obj):(cov_tq1wiin2x().b[0][1]++,{default:obj});}const request=(cov_tq1wiin2x().s[5]++,require('../request'));const rest=(cov_tq1wiin2x().s[6]++,require('../rest'));// TODO move validation logic in IAPValidationController
const IAP_SANDBOX_URL=(cov_tq1wiin2x().s[7]++,'https://sandbox.itunes.apple.com/verifyReceipt');const IAP_PRODUCTION_URL=(cov_tq1wiin2x().s[8]++,'https://buy.itunes.apple.com/verifyReceipt');const APP_STORE_ERRORS=(cov_tq1wiin2x().s[9]++,{21000:'The App Store could not read the JSON object you provided.',21002:'The data in the receipt-data property was malformed or missing.',21003:'The receipt could not be authenticated.',21004:'The shared secret you provided does not match the shared secret on file for your account.',21005:'The receipt server is not currently available.',21006:'This receipt is valid but the subscription has expired.',21007:'This receipt is from the test environment, but it was sent to the production environment for verification. Send it to the test environment instead.',21008:'This receipt is from the production environment, but it was sent to the test environment for verification. Send it to the production environment instead.'});function appStoreError(status){cov_tq1wiin2x().f[1]++;cov_tq1wiin2x().s[10]++;status=parseInt(status);var errorString=(cov_tq1wiin2x().s[11]++,(cov_tq1wiin2x().b[2][0]++,APP_STORE_ERRORS[status])||(cov_tq1wiin2x().b[2][1]++,'unknown error.'));cov_tq1wiin2x().s[12]++;return{status:status,error:errorString};}function validateWithAppStore(url,receipt){cov_tq1wiin2x().f[2]++;cov_tq1wiin2x().s[13]++;return request({url:url,method:'POST',body:{'receipt-data':receipt},headers:{'Content-Type':'application/json'}}).then(httpResponse=>{cov_tq1wiin2x().f[3]++;const body=(cov_tq1wiin2x().s[14]++,httpResponse.data);cov_tq1wiin2x().s[15]++;if((cov_tq1wiin2x().b[4][0]++,body)&&(cov_tq1wiin2x().b[4][1]++,body.status===0)){cov_tq1wiin2x().b[3][0]++;cov_tq1wiin2x().s[16]++;// No need to pass anything, status is OK
return;}else{cov_tq1wiin2x().b[3][1]++;}// receipt is from test and should go to test
cov_tq1wiin2x().s[17]++;throw body;});}function getFileForProductIdentifier(productIdentifier,req){cov_tq1wiin2x().f[4]++;cov_tq1wiin2x().s[18]++;return rest.find(req.config,req.auth,'_Product',{productIdentifier:productIdentifier},undefined,req.info.clientSDK,req.info.context).then(function(result){cov_tq1wiin2x().f[5]++;const products=(cov_tq1wiin2x().s[19]++,result.results);cov_tq1wiin2x().s[20]++;if((cov_tq1wiin2x().b[6][0]++,!products)||(cov_tq1wiin2x().b[6][1]++,products.length!=1)){cov_tq1wiin2x().b[5][0]++;cov_tq1wiin2x().s[21]++;// Error not found or too many
throw new _node.default.Error(_node.default.Error.OBJECT_NOT_FOUND,'Object not found.');}else{cov_tq1wiin2x().b[5][1]++;}var download=(cov_tq1wiin2x().s[22]++,products[0].download);cov_tq1wiin2x().s[23]++;return Promise.resolve({response:download});});}class IAPValidationRouter extends(_PromiseRouter.default){handleRequest(req){cov_tq1wiin2x().f[6]++;let receipt=(cov_tq1wiin2x().s[24]++,req.body.receipt);const productIdentifier=(cov_tq1wiin2x().s[25]++,req.body.productIdentifier);cov_tq1wiin2x().s[26]++;if((cov_tq1wiin2x().b[8][0]++,!receipt)||(cov_tq1wiin2x().b[8][1]++,!productIdentifier)){cov_tq1wiin2x().b[7][0]++;cov_tq1wiin2x().s[27]++;// TODO: Error, malformed request
throw new _node.default.Error(_node.default.Error.INVALID_JSON,'missing receipt or productIdentifier');}else{cov_tq1wiin2x().b[7][1]++;}// Transform the object if there
// otherwise assume it's in Base64 already
cov_tq1wiin2x().s[28]++;if(typeof receipt=='object'){cov_tq1wiin2x().b[9][0]++;cov_tq1wiin2x().s[29]++;if(receipt['__type']=='Bytes'){cov_tq1wiin2x().b[10][0]++;cov_tq1wiin2x().s[30]++;receipt=receipt.base64;}else{cov_tq1wiin2x().b[10][1]++;}}else{cov_tq1wiin2x().b[9][1]++;}cov_tq1wiin2x().s[31]++;if((cov_tq1wiin2x().b[12][0]++,process.env.TESTING=='1')&&(cov_tq1wiin2x().b[12][1]++,req.body.bypassAppStoreValidation)){cov_tq1wiin2x().b[11][0]++;cov_tq1wiin2x().s[32]++;return getFileForProductIdentifier(productIdentifier,req);}else{cov_tq1wiin2x().b[11][1]++;}function successCallback(){cov_tq1wiin2x().f[7]++;cov_tq1wiin2x().s[33]++;return getFileForProductIdentifier(productIdentifier,req);}function errorCallback(error){cov_tq1wiin2x().f[8]++;cov_tq1wiin2x().s[34]++;return Promise.resolve({response:appStoreError(error.status)});}cov_tq1wiin2x().s[35]++;return validateWithAppStore(IAP_PRODUCTION_URL,receipt).then(()=>{cov_tq1wiin2x().f[9]++;cov_tq1wiin2x().s[36]++;return successCallback();},error=>{cov_tq1wiin2x().f[10]++;cov_tq1wiin2x().s[37]++;if(error.status==21007){cov_tq1wiin2x().b[13][0]++;cov_tq1wiin2x().s[38]++;return validateWithAppStore(IAP_SANDBOX_URL,receipt).then(()=>{cov_tq1wiin2x().f[11]++;cov_tq1wiin2x().s[39]++;return successCallback();},error=>{cov_tq1wiin2x().f[12]++;cov_tq1wiin2x().s[40]++;return errorCallback(error);});}else{cov_tq1wiin2x().b[13][1]++;}cov_tq1wiin2x().s[41]++;return errorCallback(error);});}mountRoutes(){cov_tq1wiin2x().f[13]++;cov_tq1wiin2x().s[42]++;this.route('POST','/validate_purchase',this.handleRequest);}}cov_tq1wiin2x().s[43]++;exports.IAPValidationRouter=IAPValidationRouter;//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0lBUFZhbGlkYXRpb25Sb3V0ZXIuanMiXSwibmFtZXMiOlsicmVxdWVzdCIsInJlcXVpcmUiLCJyZXN0IiwiSUFQX1NBTkRCT1hfVVJMIiwiSUFQX1BST0RVQ1RJT05fVVJMIiwiQVBQX1NUT1JFX0VSUk9SUyIsImFwcFN0b3JlRXJyb3IiLCJzdGF0dXMiLCJwYXJzZUludCIsImVycm9yU3RyaW5nIiwiZXJyb3IiLCJ2YWxpZGF0ZVdpdGhBcHBTdG9yZSIsInVybCIsInJlY2VpcHQiLCJtZXRob2QiLCJib2R5IiwiaGVhZGVycyIsInRoZW4iLCJodHRwUmVzcG9uc2UiLCJkYXRhIiwiZ2V0RmlsZUZvclByb2R1Y3RJZGVudGlmaWVyIiwicHJvZHVjdElkZW50aWZpZXIiLCJyZXEiLCJmaW5kIiwiY29uZmlnIiwiYXV0aCIsInVuZGVmaW5lZCIsImluZm8iLCJjbGllbnRTREsiLCJjb250ZXh0IiwicmVzdWx0IiwicHJvZHVjdHMiLCJyZXN1bHRzIiwibGVuZ3RoIiwiUGFyc2UiLCJFcnJvciIsIk9CSkVDVF9OT1RfRk9VTkQiLCJkb3dubG9hZCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVzcG9uc2UiLCJJQVBWYWxpZGF0aW9uUm91dGVyIiwiUHJvbWlzZVJvdXRlciIsImhhbmRsZVJlcXVlc3QiLCJJTlZBTElEX0pTT04iLCJiYXNlNjQiLCJwcm9jZXNzIiwiZW52IiwiVEVTVElORyIsImJ5cGFzc0FwcFN0b3JlVmFsaWRhdGlvbiIsInN1Y2Nlc3NDYWxsYmFjayIsImVycm9yQ2FsbGJhY2siLCJtb3VudFJvdXRlcyIsInJvdXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBR0E7Ozs7QUFGQSxNQUFNQSxPQUFPLEdBQUdDLE9BQU8sQ0FBQyxZQUFELENBQXZCOztBQUNBLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLFNBQUQsQ0FBcEI7O0FBR0E7QUFDQSxNQUFNRSxlQUFlLEdBQUcsZ0RBQXhCO0FBQ0EsTUFBTUMsa0JBQWtCLEdBQUcsNENBQTNCO0FBRUEsTUFBTUMsZ0JBQWdCLEdBQUc7QUFDdkIsU0FBTyw0REFEZ0I7QUFFdkIsU0FBTyxpRUFGZ0I7QUFHdkIsU0FBTyx5Q0FIZ0I7QUFJdkIsU0FBTywyRkFKZ0I7QUFLdkIsU0FBTyxnREFMZ0I7QUFNdkIsU0FBTyx5REFOZ0I7QUFPdkIsU0FBTyxxSkFQZ0I7QUFRdkIsU0FBTztBQVJnQixDQUF6Qjs7QUFXQSxTQUFTQyxhQUFULENBQXVCQyxNQUF2QixFQUErQjtBQUM3QkEsRUFBQUEsTUFBTSxHQUFHQyxRQUFRLENBQUNELE1BQUQsQ0FBakI7QUFDQSxNQUFJRSxXQUFXLEdBQUdKLGdCQUFnQixDQUFDRSxNQUFELENBQWhCLElBQTRCLGdCQUE5QztBQUNBLFNBQU87QUFBRUEsSUFBQUEsTUFBTSxFQUFFQSxNQUFWO0FBQWtCRyxJQUFBQSxLQUFLLEVBQUVEO0FBQXpCLEdBQVA7QUFDRDs7QUFFRCxTQUFTRSxvQkFBVCxDQUE4QkMsR0FBOUIsRUFBbUNDLE9BQW5DLEVBQTRDO0FBQzFDLFNBQU9iLE9BQU8sQ0FBQztBQUNiWSxJQUFBQSxHQUFHLEVBQUVBLEdBRFE7QUFFYkUsSUFBQUEsTUFBTSxFQUFFLE1BRks7QUFHYkMsSUFBQUEsSUFBSSxFQUFFO0FBQUUsc0JBQWdCRjtBQUFsQixLQUhPO0FBSWJHLElBQUFBLE9BQU8sRUFBRTtBQUNQLHNCQUFnQjtBQURUO0FBSkksR0FBRCxDQUFQLENBT0pDLElBUEksQ0FPQ0MsWUFBWSxJQUFJO0FBQ3RCLFVBQU1ILElBQUksR0FBR0csWUFBWSxDQUFDQyxJQUExQjs7QUFDQSxRQUFJSixJQUFJLElBQUlBLElBQUksQ0FBQ1IsTUFBTCxLQUFnQixDQUE1QixFQUErQjtBQUM3QjtBQUNBO0FBQ0QsS0FMcUIsQ0FNdEI7OztBQUNBLFVBQU1RLElBQU47QUFDRCxHQWZNLENBQVA7QUFnQkQ7O0FBRUQsU0FBU0ssMkJBQVQsQ0FBcUNDLGlCQUFyQyxFQUF3REMsR0FBeEQsRUFBNkQ7QUFDM0QsU0FBT3BCLElBQUksQ0FDUnFCLElBREksQ0FFSEQsR0FBRyxDQUFDRSxNQUZELEVBR0hGLEdBQUcsQ0FBQ0csSUFIRCxFQUlILFVBSkcsRUFLSDtBQUFFSixJQUFBQSxpQkFBaUIsRUFBRUE7QUFBckIsR0FMRyxFQU1ISyxTQU5HLEVBT0hKLEdBQUcsQ0FBQ0ssSUFBSixDQUFTQyxTQVBOLEVBUUhOLEdBQUcsQ0FBQ0ssSUFBSixDQUFTRSxPQVJOLEVBVUpaLElBVkksQ0FVQyxVQUFVYSxNQUFWLEVBQWtCO0FBQ3RCLFVBQU1DLFFBQVEsR0FBR0QsTUFBTSxDQUFDRSxPQUF4Qjs7QUFDQSxRQUFJLENBQUNELFFBQUQsSUFBYUEsUUFBUSxDQUFDRSxNQUFULElBQW1CLENBQXBDLEVBQXVDO0FBQ3JDO0FBQ0EsWUFBTSxJQUFJQyxjQUFNQyxLQUFWLENBQWdCRCxjQUFNQyxLQUFOLENBQVlDLGdCQUE1QixFQUE4QyxtQkFBOUMsQ0FBTjtBQUNEOztBQUVELFFBQUlDLFFBQVEsR0FBR04sUUFBUSxDQUFDLENBQUQsQ0FBUixDQUFZTSxRQUEzQjtBQUNBLFdBQU9DLE9BQU8sQ0FBQ0MsT0FBUixDQUFnQjtBQUFFQyxNQUFBQSxRQUFRLEVBQUVIO0FBQVosS0FBaEIsQ0FBUDtBQUNELEdBbkJJLENBQVA7QUFvQkQ7O0FBRU0sTUFBTUksbUJBQU4sU0FBa0NDLHNCQUFsQyxDQUFnRDtBQUNyREMsRUFBQUEsYUFBYSxDQUFDckIsR0FBRCxFQUFNO0FBQ2pCLFFBQUlULE9BQU8sR0FBR1MsR0FBRyxDQUFDUCxJQUFKLENBQVNGLE9BQXZCO0FBQ0EsVUFBTVEsaUJBQWlCLEdBQUdDLEdBQUcsQ0FBQ1AsSUFBSixDQUFTTSxpQkFBbkM7O0FBRUEsUUFBSSxDQUFDUixPQUFELElBQVksQ0FBQ1EsaUJBQWpCLEVBQW9DO0FBQ2xDO0FBQ0EsWUFBTSxJQUFJYSxjQUFNQyxLQUFWLENBQWdCRCxjQUFNQyxLQUFOLENBQVlTLFlBQTVCLEVBQTBDLHNDQUExQyxDQUFOO0FBQ0QsS0FQZ0IsQ0FTakI7QUFDQTs7O0FBQ0EsUUFBSSxPQUFPL0IsT0FBUCxJQUFrQixRQUF0QixFQUFnQztBQUM5QixVQUFJQSxPQUFPLENBQUMsUUFBRCxDQUFQLElBQXFCLE9BQXpCLEVBQWtDO0FBQ2hDQSxRQUFBQSxPQUFPLEdBQUdBLE9BQU8sQ0FBQ2dDLE1BQWxCO0FBQ0Q7QUFDRjs7QUFFRCxRQUFJQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsT0FBWixJQUF1QixHQUF2QixJQUE4QjFCLEdBQUcsQ0FBQ1AsSUFBSixDQUFTa0Msd0JBQTNDLEVBQXFFO0FBQ25FLGFBQU83QiwyQkFBMkIsQ0FBQ0MsaUJBQUQsRUFBb0JDLEdBQXBCLENBQWxDO0FBQ0Q7O0FBRUQsYUFBUzRCLGVBQVQsR0FBMkI7QUFDekIsYUFBTzlCLDJCQUEyQixDQUFDQyxpQkFBRCxFQUFvQkMsR0FBcEIsQ0FBbEM7QUFDRDs7QUFFRCxhQUFTNkIsYUFBVCxDQUF1QnpDLEtBQXZCLEVBQThCO0FBQzVCLGFBQU80QixPQUFPLENBQUNDLE9BQVIsQ0FBZ0I7QUFBRUMsUUFBQUEsUUFBUSxFQUFFbEMsYUFBYSxDQUFDSSxLQUFLLENBQUNILE1BQVA7QUFBekIsT0FBaEIsQ0FBUDtBQUNEOztBQUVELFdBQU9JLG9CQUFvQixDQUFDUCxrQkFBRCxFQUFxQlMsT0FBckIsQ0FBcEIsQ0FBa0RJLElBQWxELENBQ0wsTUFBTTtBQUNKLGFBQU9pQyxlQUFlLEVBQXRCO0FBQ0QsS0FISSxFQUlMeEMsS0FBSyxJQUFJO0FBQ1AsVUFBSUEsS0FBSyxDQUFDSCxNQUFOLElBQWdCLEtBQXBCLEVBQTJCO0FBQ3pCLGVBQU9JLG9CQUFvQixDQUFDUixlQUFELEVBQWtCVSxPQUFsQixDQUFwQixDQUErQ0ksSUFBL0MsQ0FDTCxNQUFNO0FBQ0osaUJBQU9pQyxlQUFlLEVBQXRCO0FBQ0QsU0FISSxFQUlMeEMsS0FBSyxJQUFJO0FBQ1AsaUJBQU95QyxhQUFhLENBQUN6QyxLQUFELENBQXBCO0FBQ0QsU0FOSSxDQUFQO0FBUUQ7O0FBRUQsYUFBT3lDLGFBQWEsQ0FBQ3pDLEtBQUQsQ0FBcEI7QUFDRCxLQWpCSSxDQUFQO0FBbUJEOztBQUVEMEMsRUFBQUEsV0FBVyxHQUFHO0FBQ1osU0FBS0MsS0FBTCxDQUFXLE1BQVgsRUFBbUIsb0JBQW5CLEVBQXlDLEtBQUtWLGFBQTlDO0FBQ0Q7O0FBckRvRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQcm9taXNlUm91dGVyIGZyb20gJy4uL1Byb21pc2VSb3V0ZXInO1xuY29uc3QgcmVxdWVzdCA9IHJlcXVpcmUoJy4uL3JlcXVlc3QnKTtcbmNvbnN0IHJlc3QgPSByZXF1aXJlKCcuLi9yZXN0Jyk7XG5pbXBvcnQgUGFyc2UgZnJvbSAncGFyc2Uvbm9kZSc7XG5cbi8vIFRPRE8gbW92ZSB2YWxpZGF0aW9uIGxvZ2ljIGluIElBUFZhbGlkYXRpb25Db250cm9sbGVyXG5jb25zdCBJQVBfU0FOREJPWF9VUkwgPSAnaHR0cHM6Ly9zYW5kYm94Lml0dW5lcy5hcHBsZS5jb20vdmVyaWZ5UmVjZWlwdCc7XG5jb25zdCBJQVBfUFJPRFVDVElPTl9VUkwgPSAnaHR0cHM6Ly9idXkuaXR1bmVzLmFwcGxlLmNvbS92ZXJpZnlSZWNlaXB0JztcblxuY29uc3QgQVBQX1NUT1JFX0VSUk9SUyA9IHtcbiAgMjEwMDA6ICdUaGUgQXBwIFN0b3JlIGNvdWxkIG5vdCByZWFkIHRoZSBKU09OIG9iamVjdCB5b3UgcHJvdmlkZWQuJyxcbiAgMjEwMDI6ICdUaGUgZGF0YSBpbiB0aGUgcmVjZWlwdC1kYXRhIHByb3BlcnR5IHdhcyBtYWxmb3JtZWQgb3IgbWlzc2luZy4nLFxuICAyMTAwMzogJ1RoZSByZWNlaXB0IGNvdWxkIG5vdCBiZSBhdXRoZW50aWNhdGVkLicsXG4gIDIxMDA0OiAnVGhlIHNoYXJlZCBzZWNyZXQgeW91IHByb3ZpZGVkIGRvZXMgbm90IG1hdGNoIHRoZSBzaGFyZWQgc2VjcmV0IG9uIGZpbGUgZm9yIHlvdXIgYWNjb3VudC4nLFxuICAyMTAwNTogJ1RoZSByZWNlaXB0IHNlcnZlciBpcyBub3QgY3VycmVudGx5IGF2YWlsYWJsZS4nLFxuICAyMTAwNjogJ1RoaXMgcmVjZWlwdCBpcyB2YWxpZCBidXQgdGhlIHN1YnNjcmlwdGlvbiBoYXMgZXhwaXJlZC4nLFxuICAyMTAwNzogJ1RoaXMgcmVjZWlwdCBpcyBmcm9tIHRoZSB0ZXN0IGVudmlyb25tZW50LCBidXQgaXQgd2FzIHNlbnQgdG8gdGhlIHByb2R1Y3Rpb24gZW52aXJvbm1lbnQgZm9yIHZlcmlmaWNhdGlvbi4gU2VuZCBpdCB0byB0aGUgdGVzdCBlbnZpcm9ubWVudCBpbnN0ZWFkLicsXG4gIDIxMDA4OiAnVGhpcyByZWNlaXB0IGlzIGZyb20gdGhlIHByb2R1Y3Rpb24gZW52aXJvbm1lbnQsIGJ1dCBpdCB3YXMgc2VudCB0byB0aGUgdGVzdCBlbnZpcm9ubWVudCBmb3IgdmVyaWZpY2F0aW9uLiBTZW5kIGl0IHRvIHRoZSBwcm9kdWN0aW9uIGVudmlyb25tZW50IGluc3RlYWQuJyxcbn07XG5cbmZ1bmN0aW9uIGFwcFN0b3JlRXJyb3Ioc3RhdHVzKSB7XG4gIHN0YXR1cyA9IHBhcnNlSW50KHN0YXR1cyk7XG4gIHZhciBlcnJvclN0cmluZyA9IEFQUF9TVE9SRV9FUlJPUlNbc3RhdHVzXSB8fCAndW5rbm93biBlcnJvci4nO1xuICByZXR1cm4geyBzdGF0dXM6IHN0YXR1cywgZXJyb3I6IGVycm9yU3RyaW5nIH07XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlV2l0aEFwcFN0b3JlKHVybCwgcmVjZWlwdCkge1xuICByZXR1cm4gcmVxdWVzdCh7XG4gICAgdXJsOiB1cmwsXG4gICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgYm9keTogeyAncmVjZWlwdC1kYXRhJzogcmVjZWlwdCB9LFxuICAgIGhlYWRlcnM6IHtcbiAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgfSxcbiAgfSkudGhlbihodHRwUmVzcG9uc2UgPT4ge1xuICAgIGNvbnN0IGJvZHkgPSBodHRwUmVzcG9uc2UuZGF0YTtcbiAgICBpZiAoYm9keSAmJiBib2R5LnN0YXR1cyA9PT0gMCkge1xuICAgICAgLy8gTm8gbmVlZCB0byBwYXNzIGFueXRoaW5nLCBzdGF0dXMgaXMgT0tcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgLy8gcmVjZWlwdCBpcyBmcm9tIHRlc3QgYW5kIHNob3VsZCBnbyB0byB0ZXN0XG4gICAgdGhyb3cgYm9keTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGdldEZpbGVGb3JQcm9kdWN0SWRlbnRpZmllcihwcm9kdWN0SWRlbnRpZmllciwgcmVxKSB7XG4gIHJldHVybiByZXN0XG4gICAgLmZpbmQoXG4gICAgICByZXEuY29uZmlnLFxuICAgICAgcmVxLmF1dGgsXG4gICAgICAnX1Byb2R1Y3QnLFxuICAgICAgeyBwcm9kdWN0SWRlbnRpZmllcjogcHJvZHVjdElkZW50aWZpZXIgfSxcbiAgICAgIHVuZGVmaW5lZCxcbiAgICAgIHJlcS5pbmZvLmNsaWVudFNESyxcbiAgICAgIHJlcS5pbmZvLmNvbnRleHRcbiAgICApXG4gICAgLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgICAgY29uc3QgcHJvZHVjdHMgPSByZXN1bHQucmVzdWx0cztcbiAgICAgIGlmICghcHJvZHVjdHMgfHwgcHJvZHVjdHMubGVuZ3RoICE9IDEpIHtcbiAgICAgICAgLy8gRXJyb3Igbm90IGZvdW5kIG9yIHRvbyBtYW55XG4gICAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5PQkpFQ1RfTk9UX0ZPVU5ELCAnT2JqZWN0IG5vdCBmb3VuZC4nKTtcbiAgICAgIH1cblxuICAgICAgdmFyIGRvd25sb2FkID0gcHJvZHVjdHNbMF0uZG93bmxvYWQ7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgcmVzcG9uc2U6IGRvd25sb2FkIH0pO1xuICAgIH0pO1xufVxuXG5leHBvcnQgY2xhc3MgSUFQVmFsaWRhdGlvblJvdXRlciBleHRlbmRzIFByb21pc2VSb3V0ZXIge1xuICBoYW5kbGVSZXF1ZXN0KHJlcSkge1xuICAgIGxldCByZWNlaXB0ID0gcmVxLmJvZHkucmVjZWlwdDtcbiAgICBjb25zdCBwcm9kdWN0SWRlbnRpZmllciA9IHJlcS5ib2R5LnByb2R1Y3RJZGVudGlmaWVyO1xuXG4gICAgaWYgKCFyZWNlaXB0IHx8ICFwcm9kdWN0SWRlbnRpZmllcikge1xuICAgICAgLy8gVE9ETzogRXJyb3IsIG1hbGZvcm1lZCByZXF1ZXN0XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuSU5WQUxJRF9KU09OLCAnbWlzc2luZyByZWNlaXB0IG9yIHByb2R1Y3RJZGVudGlmaWVyJyk7XG4gICAgfVxuXG4gICAgLy8gVHJhbnNmb3JtIHRoZSBvYmplY3QgaWYgdGhlcmVcbiAgICAvLyBvdGhlcndpc2UgYXNzdW1lIGl0J3MgaW4gQmFzZTY0IGFscmVhZHlcbiAgICBpZiAodHlwZW9mIHJlY2VpcHQgPT0gJ29iamVjdCcpIHtcbiAgICAgIGlmIChyZWNlaXB0WydfX3R5cGUnXSA9PSAnQnl0ZXMnKSB7XG4gICAgICAgIHJlY2VpcHQgPSByZWNlaXB0LmJhc2U2NDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAocHJvY2Vzcy5lbnYuVEVTVElORyA9PSAnMScgJiYgcmVxLmJvZHkuYnlwYXNzQXBwU3RvcmVWYWxpZGF0aW9uKSB7XG4gICAgICByZXR1cm4gZ2V0RmlsZUZvclByb2R1Y3RJZGVudGlmaWVyKHByb2R1Y3RJZGVudGlmaWVyLCByZXEpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHN1Y2Nlc3NDYWxsYmFjaygpIHtcbiAgICAgIHJldHVybiBnZXRGaWxlRm9yUHJvZHVjdElkZW50aWZpZXIocHJvZHVjdElkZW50aWZpZXIsIHJlcSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZXJyb3JDYWxsYmFjayhlcnJvcikge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHJlc3BvbnNlOiBhcHBTdG9yZUVycm9yKGVycm9yLnN0YXR1cykgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHZhbGlkYXRlV2l0aEFwcFN0b3JlKElBUF9QUk9EVUNUSU9OX1VSTCwgcmVjZWlwdCkudGhlbihcbiAgICAgICgpID0+IHtcbiAgICAgICAgcmV0dXJuIHN1Y2Nlc3NDYWxsYmFjaygpO1xuICAgICAgfSxcbiAgICAgIGVycm9yID0+IHtcbiAgICAgICAgaWYgKGVycm9yLnN0YXR1cyA9PSAyMTAwNykge1xuICAgICAgICAgIHJldHVybiB2YWxpZGF0ZVdpdGhBcHBTdG9yZShJQVBfU0FOREJPWF9VUkwsIHJlY2VpcHQpLnRoZW4oXG4gICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiBzdWNjZXNzQ2FsbGJhY2soKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlcnJvciA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiBlcnJvckNhbGxiYWNrKGVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGVycm9yQ2FsbGJhY2soZXJyb3IpO1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBtb3VudFJvdXRlcygpIHtcbiAgICB0aGlzLnJvdXRlKCdQT1NUJywgJy92YWxpZGF0ZV9wdXJjaGFzZScsIHRoaXMuaGFuZGxlUmVxdWVzdCk7XG4gIH1cbn1cbiJdfQ==
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0lBUFZhbGlkYXRpb25Sb3V0ZXIuanMiXSwibmFtZXMiOlsicmVxdWVzdCIsInJlcXVpcmUiLCJyZXN0IiwiSUFQX1NBTkRCT1hfVVJMIiwiSUFQX1BST0RVQ1RJT05fVVJMIiwiQVBQX1NUT1JFX0VSUk9SUyIsInN0YXR1cyIsInBhcnNlSW50IiwiZXJyb3JTdHJpbmciLCJlcnJvciIsInVybCIsIm1ldGhvZCIsImJvZHkiLCJyZWNlaXB0IiwiaGVhZGVycyIsImh0dHBSZXNwb25zZSIsInJlcSIsInByb2R1Y3RJZGVudGlmaWVyIiwicHJvZHVjdHMiLCJyZXN1bHQiLCJQYXJzZSIsImRvd25sb2FkIiwicmVzcG9uc2UiLCJQcm9taXNlUm91dGVyIiwiaGFuZGxlUmVxdWVzdCIsInByb2Nlc3MiLCJnZXRGaWxlRm9yUHJvZHVjdElkZW50aWZpZXIiLCJhcHBTdG9yZUVycm9yIiwic3VjY2Vzc0NhbGxiYWNrIiwiZXJyb3JDYWxsYmFjayIsIm1vdW50Um91dGVzIl0sIm1hcHBpbmdzIjoibTRmQUVVO21PQUZWLEdBQUEsQ0FBQSxjQUFBLHlCQUFBLHNCQUFBLENBQUEsT0FBQSxDQUFBLGtCQUFBLENBQUEsQ0FBQSxDQUFBLENBR0EsR0FBQSxDQUFBLEtBQUEseUJBQUEsc0JBQUEsQ0FBQSxPQUFBLENBQUEsWUFBQSxDQUFBLENBQUEsQ0FBQSxDLGdQQUZBLEtBQU1BLENBQUFBLE9BQU8seUJBQUdDLE9BQU8sQ0FBdkIsWUFBdUIsQ0FBVixDQUFiLENBQ0EsS0FBTUMsQ0FBQUEsSUFBSSx5QkFBR0QsT0FBTyxDQUFwQixTQUFvQixDQUFWLENBQVYsQ0FHQTtBQUNBLEtBQU1FLENBQUFBLGVBQWUseUJBQXJCLGdEQUFxQixDQUFyQixDQUNBLEtBQU1DLENBQUFBLGtCQUFrQix5QkFBeEIsNENBQXdCLENBQXhCLENBRUEsS0FBTUMsQ0FBQUEsZ0JBQWdCLHlCQUFHLENBQ3ZCLE1BRHVCLDREQUFBLENBRXZCLE1BRnVCLGlFQUFB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QixDQUFwQixDQUFBLElBQUEsQ0FDTCxJQUFNLGlEQUNKLE1BQU9tQixDQUFBQSxlQUFQLEVBQUEsQ0FGRyxDQUFBLENBSUxuQixLQUFLLEVBQUksaURBQ1AsTUFBT29CLENBQUFBLGFBQWEsQ0FBcEIsS0FBb0IsQ0FBcEIsQ0FMSixDQUFPLENBQVAsQ0FRRCxDQVRELGlDQURPLHdCQVlQLE1BQU9BLENBQUFBLGFBQWEsQ0FBcEIsS0FBb0IsQ0FBcEIsQ0FoQkosQ0FBTyxDQUFQLENBbUJELENBRURDLFdBQVcsRUFBRyxpREFDWixLQUFBLEtBQUEsQ0FBQSxNQUFBLENBQUEsb0JBQUEsQ0FBeUMsS0FBekMsYUFBQSxFQUNELENBckRvRCxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb21pc2VSb3V0ZXIgZnJvbSAnLi4vUHJvbWlzZVJvdXRlcic7XG5jb25zdCByZXF1ZXN0ID0gcmVxdWlyZSgnLi4vcmVxdWVzdCcpO1xuY29uc3QgcmVzdCA9IHJlcXVpcmUoJy4uL3Jlc3QnKTtcbmltcG9ydCBQYXJzZSBmcm9tICdwYXJzZS9ub2RlJztcblxuLy8gVE9ETyBtb3ZlIHZhbGlkYXRpb24gbG9naWMgaW4gSUFQVmFsaWRhdGlvbkNvbnRyb2xsZXJcbmNvbnN0IElBUF9TQU5EQk9YX1VSTCA9ICdodHRwczovL3NhbmRib3guaXR1bmVzLmFwcGxlLmNvbS92ZXJpZnlSZWNlaXB0JztcbmNvbnN0IElBUF9QUk9EVUNUSU9OX1VSTCA9ICdodHRwczovL2J1eS5pdHVuZXMuYXBwbGUuY29tL3ZlcmlmeVJlY2VpcHQnO1xuXG5jb25zdCBBUFBfU1RPUkVfRVJST1JTID0ge1xuICAyMTAwMDogJ1RoZSBBcHAgU3RvcmUgY291bGQgbm90IHJlYWQgdGhlIEpTT04gb2JqZWN0IHlvdSBwcm92aWRlZC4nLFxuICAyMTAwMjogJ1RoZSBkYXRhIGluIHRoZSByZWNlaXB0LWRhdGEgcHJvcGVydHkgd2FzIG1hbGZvcm1lZCBvciBtaXNzaW5nLicsXG4gIDIxMDAzOiAnVGhlIHJlY2VpcHQgY291bGQgbm90IGJlIGF1dGhlbnRpY2F0ZWQuJyxcbiAgMjEwMDQ6ICdUaGUgc2hhcmVkIHNlY3JldCB5b3UgcHJvdmlkZWQgZG9lcyBub3QgbWF0Y2ggdGhlIHNoYXJlZCBzZWNyZXQgb24gZmlsZSBmb3IgeW91ciBhY2NvdW50LicsXG4gIDIxMDA1OiAnVGhlIHJlY2VpcHQgc2VydmVyIGlzIG5vdCBjdXJyZW50bHkgYXZhaWxhYmxlLicsXG4gIDIxMDA2OiAnVGhpcyByZWNlaXB0IGlzIHZhbGlkIGJ1dCB0aGUgc3Vic2NyaXB0aW9uIGhhcyBleHBpcmVkLicsXG4gIDIxMDA3OiAnVGhpcyByZWNlaXB0IGlzIGZyb20gdGhlIHRlc3QgZW52aXJvbm1lbnQsIGJ1dCBpdCB3YXMgc2VudCB0byB0aGUgcHJvZHVjdGlvbiBlbnZpcm9ubWVudCBmb3IgdmVyaWZpY2F0aW9uLiBTZW5kIGl0IHRvIHRoZSB0ZXN0IGVudmlyb25tZW50IGluc3RlYWQuJyxcbiAgMjEwMDg6ICdUaGlzIHJlY2VpcHQgaXMgZnJvbSB0aGUgcHJvZHVjdGlvbiBlbnZpcm9ubWVudCwgYnV0IGl0IHdhcyBzZW50IHRvIHRoZSB0ZXN0IGVudmlyb25tZW50IGZvciB2ZXJpZmljYXRpb24uIFNlbmQgaXQgdG8gdGhlIHByb2R1Y3Rpb24gZW52aXJvbm1lbnQgaW5zdGVhZC4nLFxufTtcblxuZnVuY3Rpb24gYXBwU3RvcmVFcnJvcihzdGF0dXMpIHtcbiAgc3RhdHVzID0gcGFyc2VJbnQoc3RhdHVzKTtcbiAgdmFyIGVycm9yU3RyaW5nID0gQVBQX1NUT1JFX0VSUk9SU1tzdGF0dXNdIHx8ICd1bmtub3duIGVycm9yLic7XG4gIHJldHVybiB7IHN0YXR1czogc3RhdHVzLCBlcnJvcjogZXJyb3JTdHJpbmcgfTtcbn1cblxuZnVuY3Rpb24gdmFsaWRhdGVXaXRoQXBwU3RvcmUodXJsLCByZWNlaXB0KSB7XG4gIHJldHVybiByZXF1ZXN0KHtcbiAgICB1cmw6IHVybCxcbiAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICBib2R5OiB7ICdyZWNlaXB0LWRhdGEnOiByZWNlaXB0IH0sXG4gICAgaGVhZGVyczoge1xuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICB9LFxuICB9KS50aGVuKGh0dHBSZXNwb25zZSA9PiB7XG4gICAgY29uc3QgYm9keSA9IGh0dHBSZXNwb25zZS5kYXRhO1xuICAgIGlmIChib2R5ICYmIGJvZHkuc3RhdHVzID09PSAwKSB7XG4gICAgICAvLyBObyBuZWVkIHRvIHBhc3MgYW55dGhpbmcsIHN0YXR1cyBpcyBPS1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyByZWNlaXB0IGlzIGZyb20gdGVzdCBhbmQgc2hvdWxkIGdvIHRvIHRlc3RcbiAgICB0aHJvdyBib2R5O1xuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2V0RmlsZUZvclByb2R1Y3RJZGVudGlmaWVyKHByb2R1Y3RJZGVudGlmaWVyLCByZXEpIHtcbiAgcmV0dXJuIHJlc3RcbiAgICAuZmluZChcbiAgICAgIHJlcS5jb25maWcsXG4gICAgICByZXEuYXV0aCxcbiAgICAgICdfUHJvZHVjdCcsXG4gICAgICB7IHByb2R1Y3RJZGVudGlmaWVyOiBwcm9kdWN0SWRlbnRpZmllciB9LFxuICAgICAgdW5kZWZpbmVkLFxuICAgICAgcmVxLmluZm8uY2xpZW50U0RLLFxuICAgICAgcmVxLmluZm8uY29udGV4dFxuICAgIClcbiAgICAudGhlbihmdW5jdGlvbiAocmVzdWx0KSB7XG4gICAgICBjb25zdCBwcm9kdWN0cyA9IHJlc3VsdC5yZXN1bHRzO1xuICAgICAgaWYgKCFwcm9kdWN0cyB8fCBwcm9kdWN0cy5sZW5ndGggIT0gMSkge1xuICAgICAgICAvLyBFcnJvciBub3QgZm91bmQgb3IgdG9vIG1hbnlcbiAgICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLk9CSkVDVF9OT1RfRk9VTkQsICdPYmplY3Qgbm90IGZvdW5kLicpO1xuICAgICAgfVxuXG4gICAgICB2YXIgZG93bmxvYWQgPSBwcm9kdWN0c1swXS5kb3dubG9hZDtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyByZXNwb25zZTogZG93bmxvYWQgfSk7XG4gICAgfSk7XG59XG5cbmV4cG9ydCBjbGFzcyBJQVBWYWxpZGF0aW9uUm91dGVyIGV4dGVuZHMgUHJvbWlzZVJvdXRlciB7XG4gIGhhbmRsZVJlcXVlc3QocmVxKSB7XG4gICAgbGV0IHJlY2VpcHQgPSByZXEuYm9keS5yZWNlaXB0O1xuICAgIGNvbnN0IHByb2R1Y3RJZGVudGlmaWVyID0gcmVxLmJvZHkucHJvZHVjdElkZW50aWZpZXI7XG5cbiAgICBpZiAoIXJlY2VpcHQgfHwgIXByb2R1Y3RJZGVudGlmaWVyKSB7XG4gICAgICAvLyBUT0RPOiBFcnJvciwgbWFsZm9ybWVkIHJlcXVlc3RcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5JTlZBTElEX0pTT04sICdtaXNzaW5nIHJlY2VpcHQgb3IgcHJvZHVjdElkZW50aWZpZXInKTtcbiAgICB9XG5cbiAgICAvLyBUcmFuc2Zvcm0gdGhlIG9iamVjdCBpZiB0aGVyZVxuICAgIC8vIG90aGVyd2lzZSBhc3N1bWUgaXQncyBpbiBCYXNlNjQgYWxyZWFkeVxuICAgIGlmICh0eXBlb2YgcmVjZWlwdCA9PSAnb2JqZWN0Jykge1xuICAgICAgaWYgKHJlY2VpcHRbJ19fdHlwZSddID09ICdCeXRlcycpIHtcbiAgICAgICAgcmVjZWlwdCA9IHJlY2VpcHQuYmFzZTY0O1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChwcm9jZXNzLmVudi5URVNUSU5HID09ICcxJyAmJiByZXEuYm9keS5ieXBhc3NBcHBTdG9yZVZhbGlkYXRpb24pIHtcbiAgICAgIHJldHVybiBnZXRGaWxlRm9yUHJvZHVjdElkZW50aWZpZXIocHJvZHVjdElkZW50aWZpZXIsIHJlcSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gc3VjY2Vzc0NhbGxiYWNrKCkge1xuICAgICAgcmV0dXJuIGdldEZpbGVGb3JQcm9kdWN0SWRlbnRpZmllcihwcm9kdWN0SWRlbnRpZmllciwgcmVxKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBlcnJvckNhbGxiYWNrKGVycm9yKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgcmVzcG9uc2U6IGFwcFN0b3JlRXJyb3IoZXJyb3Iuc3RhdHVzKSB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdmFsaWRhdGVXaXRoQXBwU3RvcmUoSUFQX1BST0RVQ1RJT05fVVJMLCByZWNlaXB0KS50aGVuKFxuICAgICAgKCkgPT4ge1xuICAgICAgICByZXR1cm4gc3VjY2Vzc0NhbGxiYWNrKCk7XG4gICAgICB9LFxuICAgICAgZXJyb3IgPT4ge1xuICAgICAgICBpZiAoZXJyb3Iuc3RhdHVzID09IDIxMDA3KSB7XG4gICAgICAgICAgcmV0dXJuIHZhbGlkYXRlV2l0aEFwcFN0b3JlKElBUF9TQU5EQk9YX1VSTCwgcmVjZWlwdCkudGhlbihcbiAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIHN1Y2Nlc3NDYWxsYmFjaygpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIGVycm9yQ2FsbGJhY2soZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZXJyb3JDYWxsYmFjayhlcnJvcik7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIG1vdW50Um91dGVzKCkge1xuICAgIHRoaXMucm91dGUoJ1BPU1QnLCAnL3ZhbGlkYXRlX3B1cmNoYXNlJywgdGhpcy5oYW5kbGVSZXF1ZXN0KTtcbiAgfVxufVxuIl19