"use strict";function cov_1g58kes9fv(){var path="/parse-server/lib/Adapters/Cache/RedisCacheAdapter.js";var hash="ca393e2613c9e6c6145d500c17f54e9c2e59e167";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"/parse-server/lib/Adapters/Cache/RedisCacheAdapter.js",statementMap:{"0":{start:{line:3,column:0},end:{line:5,column:3}},"1":{start:{line:6,column:0},end:{line:6,column:53}},"2":{start:{line:8,column:13},end:{line:8,column:53}},"3":{start:{line:10,column:14},end:{line:10,column:61}},"4":{start:{line:12,column:23},end:{line:12,column:55}},"5":{start:{line:14,column:39},end:{line:14,column:93}},"6":{start:{line:16,column:26},end:{line:16,column:35}},"7":{start:{line:18,column:21},end:{line:18,column:35}},"8":{start:{line:21,column:18},end:{line:21,column:91}},"9":{start:{line:23,column:2},end:{line:23,column:56}},"10":{start:{line:26,column:19},end:{line:26,column:60}},"11":{start:{line:26,column:26},end:{line:26,column:60}},"12":{start:{line:30,column:4},end:{line:30,column:57}},"13":{start:{line:31,column:4},end:{line:31,column:56}},"14":{start:{line:32,column:4},end:{line:32,column:56}},"15":{start:{line:36,column:4},end:{line:38,column:5}},"16":{start:{line:37,column:6},end:{line:37,column:31}},"17":{start:{line:40,column:4},end:{line:50,column:7}},"18":{start:{line:41,column:6},end:{line:49,column:9}},"19":{start:{line:42,column:8},end:{line:46,column:9}},"20":{start:{line:43,column:10},end:{line:45,column:13}},"21":{start:{line:48,column:8},end:{line:48,column:18}},"22":{start:{line:54,column:4},end:{line:56,column:7}},"23":{start:{line:57,column:4},end:{line:70,column:8}},"24":{start:{line:57,column:41},end:{line:70,column:6}},"25":{start:{line:58,column:6},end:{line:69,column:9}},"26":{start:{line:59,column:8},end:{line:62,column:11}},"27":{start:{line:64,column:8},end:{line:66,column:9}},"28":{start:{line:65,column:10},end:{line:65,column:31}},"29":{start:{line:68,column:8},end:{line:68,column:33}},"30":{start:{line:74,column:4},end:{line:74,column:34}},"31":{start:{line:75,column:4},end:{line:79,column:7}},"32":{start:{line:81,column:4},end:{line:84,column:5}},"33":{start:{line:83,column:6},end:{line:83,column:62}},"34":{start:{line:83,column:43},end:{line:83,column:60}},"35":{start:{line:86,column:4},end:{line:92,column:5}},"36":{start:{line:87,column:6},end:{line:91,column:10}},"37":{start:{line:87,column:43},end:{line:91,column:8}},"38":{start:{line:88,column:8},end:{line:90,column:11}},"39":{start:{line:89,column:10},end:{line:89,column:20}},"40":{start:{line:94,column:4},end:{line:96,column:5}},"41":{start:{line:95,column:6},end:{line:95,column:21}},"42":{start:{line:98,column:4},end:{line:102,column:8}},"43":{start:{line:98,column:41},end:{line:102,column:6}},"44":{start:{line:99,column:6},end:{line:101,column:9}},"45":{start:{line:100,column:8},end:{line:100,column:18}},"46":{start:{line:106,column:4},end:{line:108,column:7}},"47":{start:{line:109,column:4},end:{line:113,column:8}},"48":{start:{line:109,column:41},end:{line:113,column:6}},"49":{start:{line:110,column:6},end:{line:112,column:9}},"50":{start:{line:111,column:8},end:{line:111,column:18}},"51":{start:{line:117,column:4},end:{line:117,column:19}},"52":{start:{line:118,column:4},end:{line:122,column:8}},"53":{start:{line:118,column:50},end:{line:122,column:6}},"54":{start:{line:119,column:6},end:{line:121,column:9}},"55":{start:{line:120,column:8},end:{line:120,column:18}},"56":{start:{line:127,column:4},end:{line:135,column:7}},"57":{start:{line:128,column:6},end:{line:134,column:9}},"58":{start:{line:129,column:8},end:{line:133,column:9}},"59":{start:{line:130,column:10},end:{line:130,column:22}},"60":{start:{line:132,column:10},end:{line:132,column:24}},"61":{start:{line:140,column:0},end:{line:140,column:46}},"62":{start:{line:141,column:15},end:{line:141,column:32}},"63":{start:{line:142,column:0},end:{line:142,column:27}}},fnMap:{"0":{name:"_interopRequireDefault",decl:{start:{line:14,column:9},end:{line:14,column:31}},loc:{start:{line:14,column:37},end:{line:14,column:95}},line:14},"1":{name:"debug",decl:{start:{line:20,column:9},end:{line:20,column:14}},loc:{start:{line:20,column:24},end:{line:24,column:1}},line:20},"2":{name:"(anonymous_2)",decl:{start:{line:26,column:19},end:{line:26,column:20}},loc:{start:{line:26,column:26},end:{line:26,column:60}},line:26},"3":{name:"(anonymous_3)",decl:{start:{line:29,column:2},end:{line:29,column:3}},loc:{start:{line:29,column:49},end:{line:33,column:3}},line:29},"4":{name:"(anonymous_4)",decl:{start:{line:35,column:2},end:{line:35,column:3}},loc:{start:{line:35,column:19},end:{line:51,column:3}},line:35},"5":{name:"(anonymous_5)",decl:{start:{line:40,column:23},end:{line:40,column:24}},loc:{start:{line:40,column:34},end:{line:50,column:5}},line:40},"6":{name:"(anonymous_6)",decl:{start:{line:41,column:23},end:{line:41,column:24}},loc:{start:{line:41,column:30},end:{line:49,column:7}},line:41},"7":{name:"(anonymous_7)",decl:{start:{line:53,column:2},end:{line:53,column:3}},loc:{start:{line:53,column:11},end:{line:71,column:3}},line:53},"8":{name:"(anonymous_8)",decl:{start:{line:57,column:35},end:{line:57,column:36}},loc:{start:{line:57,column:41},end:{line:70,column:6}},line:57},"9":{name:"(anonymous_9)",decl:{start:{line:57,column:53},end:{line:57,column:54}},loc:{start:{line:57,column:64},end:{line:70,column:5}},line:57},"10":{name:"(anonymous_10)",decl:{start:{line:58,column:27},end:{line:58,column:28}},loc:{start:{line:58,column:47},end:{line:69,column:7}},line:58},"11":{name:"(anonymous_11)",decl:{start:{line:73,column:2},end:{line:73,column:3}},loc:{start:{line:73,column:34},end:{line:103,column:3}},line:73},"12":{name:"(anonymous_12)",decl:{start:{line:83,column:37},end:{line:83,column:38}},loc:{start:{line:83,column:43},end:{line:83,column:60}},line:83},"13":{name:"(anonymous_13)",decl:{start:{line:87,column:37},end:{line:87,column:38}},loc:{start:{line:87,column:43},end:{line:91,column:8}},line:87},"14":{name:"(anonymous_14)",decl:{start:{line:87,column:55},end:{line:87,column:56}},loc:{start:{line:87,column:66},end:{line:91,column:7}},line:87},"15":{name:"(anonymous_15)",decl:{start:{line:88,column:36},end:{line:88,column:37}},loc:{start:{line:88,column:48},end:{line:90,column:9}},line:88},"16":{name:"(anonymous_16)",decl:{start:{line:98,column:35},end:{line:98,column:36}},loc:{start:{line:98,column:41},end:{line:102,column:6}},line:98},"17":{name:"(anonymous_17)",decl:{start:{line:98,column:53},end:{line:98,column:54}},loc:{start:{line:98,column:64},end:{line:102,column:5}},line:98},"18":{name:"(anonymous_18)",decl:{start:{line:99,column:42},end:{line:99,column:43}},loc:{start:{line:99,column:54},end:{line:101,column:7}},line:99},"19":{name:"(anonymous_19)",decl:{start:{line:105,column:2},end:{line:105,column:3}},loc:{start:{line:105,column:11},end:{line:114,column:3}},line:105},"20":{name:"(anonymous_20)",decl:{start:{line:109,column:35},end:{line:109,column:36}},loc:{start:{line:109,column:41},end:{line:113,column:6}},line:109},"21":{name:"(anonymous_21)",decl:{start:{line:109,column:53},end:{line:109,column:54}},loc:{start:{line:109,column:64},end:{line:113,column:5}},line:109},"22":{name:"(anonymous_22)",decl:{start:{line:110,column:27},end:{line:110,column:28}},loc:{start:{line:110,column:39},end:{line:112,column:7}},line:110},"23":{name:"(anonymous_23)",decl:{start:{line:116,column:2},end:{line:116,column:3}},loc:{start:{line:116,column:10},end:{line:123,column:3}},line:116},"24":{name:"(anonymous_24)",decl:{start:{line:118,column:44},end:{line:118,column:45}},loc:{start:{line:118,column:50},end:{line:122,column:6}},line:118},"25":{name:"(anonymous_25)",decl:{start:{line:118,column:62},end:{line:118,column:63}},loc:{start:{line:118,column:73},end:{line:122,column:5}},line:118},"26":{name:"(anonymous_26)",decl:{start:{line:119,column:26},end:{line:119,column:27}},loc:{start:{line:119,column:38},end:{line:121,column:7}},line:119},"27":{name:"(anonymous_27)",decl:{start:{line:126,column:2},end:{line:126,column:3}},loc:{start:{line:126,column:21},end:{line:136,column:3}},line:126},"28":{name:"(anonymous_28)",decl:{start:{line:127,column:23},end:{line:127,column:24}},loc:{start:{line:127,column:44},end:{line:135,column:5}},line:127},"29":{name:"(anonymous_29)",decl:{start:{line:128,column:28},end:{line:128,column:29}},loc:{start:{line:128,column:43},end:{line:134,column:7}},line:128}},branchMap:{"0":{loc:{start:{line:14,column:46},end:{line:14,column:92}},type:"cond-expr",locations:[{start:{line:14,column:70},end:{line:14,column:73}},{start:{line:14,column:76},end:{line:14,column:92}}],line:14},"1":{loc:{start:{line:14,column:46},end:{line:14,column:67}},type:"binary-expr",locations:[{start:{line:14,column:46},end:{line:14,column:49}},{start:{line:14,column:53},end:{line:14,column:67}}],line:14},"2":{loc:{start:{line:26,column:26},end:{line:26,column:60}},type:"binary-expr",locations:[{start:{line:26,column:26},end:{line:26,column:49}},{start:{line:26,column:53},end:{line:26,column:60}}],line:26},"3":{loc:{start:{line:29,column:24},end:{line:29,column:47}},type:"default-arg",locations:[{start:{line:29,column:30},end:{line:29,column:47}}],line:29},"4":{loc:{start:{line:30,column:15},end:{line:30,column:56}},type:"cond-expr",locations:[{start:{line:30,column:33},end:{line:30,column:36}},{start:{line:30,column:39},end:{line:30,column:56}}],line:30},"5":{loc:{start:{line:36,column:4},end:{line:38,column:5}},type:"if",locations:[{start:{line:36,column:4},end:{line:38,column:5}},{start:{line:36,column:4},end:{line:38,column:5}}],line:36},"6":{loc:{start:{line:42,column:8},end:{line:46,column:9}},type:"if",locations:[{start:{line:42,column:8},end:{line:46,column:9}},{start:{line:42,column:8},end:{line:46,column:9}}],line:42},"7":{loc:{start:{line:64,column:8},end:{line:66,column:9}},type:"if",locations:[{start:{line:64,column:8},end:{line:66,column:9}},{start:{line:64,column:8},end:{line:66,column:9}}],line:64},"8":{loc:{start:{line:73,column:18},end:{line:73,column:32}},type:"default-arg",locations:[{start:{line:73,column:24},end:{line:73,column:32}}],line:73},"9":{loc:{start:{line:81,column:4},end:{line:84,column:5}},type:"if",locations:[{start:{line:81,column:4},end:{line:84,column:5}},{start:{line:81,column:4},end:{line:84,column:5}}],line:81},"10":{loc:{start:{line:86,column:4},end:{line:92,column:5}},type:"if",locations:[{start:{line:86,column:4},end:{line:92,column:5}},{start:{line:86,column:4},end:{line:92,column:5}}],line:86},"11":{loc:{start:{line:94,column:4},end:{line:96,column:5}},type:"if",locations:[{start:{line:94,column:4},end:{line:96,column:5}},{start:{line:94,column:4},end:{line:96,column:5}}],line:94},"12":{loc:{start:{line:129,column:8},end:{line:133,column:9}},type:"if",locations:[{start:{line:129,column:8},end:{line:133,column:9}},{start:{line:129,column:8},end:{line:133,column:9}}],line:129}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0,"49":0,"50":0,"51":0,"52":0,"53":0,"54":0,"55":0,"56":0,"57":0,"58":0,"59":0,"60":0,"61":0,"62":0,"63":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0},b:{"0":[0,0],"1":[0,0],"2":[0,0],"3":[0],"4":[0,0],"5":[0,0],"6":[0,0],"7":[0,0],"8":[0],"9":[0,0],"10":[0,0],"11":[0,0],"12":[0,0]},inputSourceMap:{version:3,sources:["../../../src/Adapters/Cache/RedisCacheAdapter.js"],names:["DEFAULT_REDIS_TTL","FLUSH_DB_KEY","debug","args","message","arguments","concat","slice","length","logger","apply","isValidTTL","ttl","RedisCacheAdapter","constructor","redisCtx","client","redis","createClient","queue","KeyPromiseQueue","handleShutdown","Promise","resolve","quit","err","error","get","key","enqueue","res","JSON","parse","put","value","stringify","Infinity","set","psetex","del","clear","flushdb","getAllKeys","reject","keys"],mappings:"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",sourcesContent:["import redis from 'redis';\nimport logger from '../../logger';\nimport { KeyPromiseQueue } from '../../KeyPromiseQueue';\n\nconst DEFAULT_REDIS_TTL = 30 * 1000; // 30 seconds in milliseconds\nconst FLUSH_DB_KEY = '__flush_db__';\n\nfunction debug(...args: any) {\n  const message = ['RedisCacheAdapter: ' + arguments[0]].concat(args.slice(1, args.length));\n  logger.debug.apply(logger, message);\n}\n\nconst isValidTTL = ttl => typeof ttl === 'number' && ttl > 0;\n\nexport class RedisCacheAdapter {\n  constructor(redisCtx, ttl = DEFAULT_REDIS_TTL) {\n    this.ttl = isValidTTL(ttl) ? ttl : DEFAULT_REDIS_TTL;\n    this.client = redis.createClient(redisCtx);\n    this.queue = new KeyPromiseQueue();\n  }\n\n  handleShutdown() {\n    if (!this.client) {\n      return Promise.resolve();\n    }\n    return new Promise(resolve => {\n      this.client.quit(err => {\n        if (err) {\n          logger.error('RedisCacheAdapter error on shutdown', { error: err });\n        }\n        resolve();\n      });\n    });\n  }\n\n  get(key) {\n    debug('get', { key });\n    return this.queue.enqueue(\n      key,\n      () =>\n        new Promise(resolve => {\n          this.client.get(key, function (err, res) {\n            debug('-> get', { key, res });\n            if (!res) {\n              return resolve(null);\n            }\n            resolve(JSON.parse(res));\n          });\n        })\n    );\n  }\n\n  put(key, value, ttl = this.ttl) {\n    value = JSON.stringify(value);\n    debug('put', { key, value, ttl });\n\n    if (ttl === 0) {\n      // ttl of zero is a logical no-op, but redis cannot set expire time of zero\n      return this.queue.enqueue(key, () => Promise.resolve());\n    }\n\n    if (ttl === Infinity) {\n      return this.queue.enqueue(\n        key,\n        () =>\n          new Promise(resolve => {\n            this.client.set(key, value, function () {\n              resolve();\n            });\n          })\n      );\n    }\n\n    if (!isValidTTL(ttl)) {\n      ttl = this.ttl;\n    }\n\n    return this.queue.enqueue(\n      key,\n      () =>\n        new Promise(resolve => {\n          this.client.psetex(key, ttl, value, function () {\n            resolve();\n          });\n        })\n    );\n  }\n\n  del(key) {\n    debug('del', { key });\n    return this.queue.enqueue(\n      key,\n      () =>\n        new Promise(resolve => {\n          this.client.del(key, function () {\n            resolve();\n          });\n        })\n    );\n  }\n\n  clear() {\n    debug('clear');\n    return this.queue.enqueue(\n      FLUSH_DB_KEY,\n      () =>\n        new Promise(resolve => {\n          this.client.flushdb(function () {\n            resolve();\n          });\n        })\n    );\n  }\n\n  // Used for testing\n  async getAllKeys() {\n    return new Promise((resolve, reject) => {\n      this.client.keys('*', (err, keys) => {\n        if (err) {\n          reject(err);\n        } else {\n          resolve(keys);\n        }\n      });\n    });\n  }\n}\n\nexport default RedisCacheAdapter;\n"]},_coverageSchema:"1a1c01bbd47fc00a2c39e90264f33305004495a9",hash:"ca393e2613c9e6c6145d500c17f54e9c2e59e167"};var coverage=global[gcv]||(global[gcv]={});if(!coverage[path]||coverage[path].hash!==hash){coverage[path]=coverageData;}var actualCoverage=coverage[path];{// @ts-ignore
cov_1g58kes9fv=function(){return actualCoverage;};}return actualCoverage;}cov_1g58kes9fv();cov_1g58kes9fv().s[0]++;Object.defineProperty(exports,"__esModule",{value:true});cov_1g58kes9fv().s[1]++;exports.default=exports.RedisCacheAdapter=void 0;var _redis=(cov_1g58kes9fv().s[2]++,_interopRequireDefault(require("redis")));var _logger=(cov_1g58kes9fv().s[3]++,_interopRequireDefault(require("../../logger")));var _KeyPromiseQueue=(cov_1g58kes9fv().s[4]++,require("../../KeyPromiseQueue"));function _interopRequireDefault(obj){cov_1g58kes9fv().f[0]++;cov_1g58kes9fv().s[5]++;return(cov_1g58kes9fv().b[1][0]++,obj)&&(cov_1g58kes9fv().b[1][1]++,obj.__esModule)?(cov_1g58kes9fv().b[0][0]++,obj):(cov_1g58kes9fv().b[0][1]++,{default:obj});}const DEFAULT_REDIS_TTL=(cov_1g58kes9fv().s[6]++,30*1000);// 30 seconds in milliseconds
const FLUSH_DB_KEY=(cov_1g58kes9fv().s[7]++,'__flush_db__');function debug(...args){cov_1g58kes9fv().f[1]++;const message=(cov_1g58kes9fv().s[8]++,['RedisCacheAdapter: '+arguments[0]].concat(args.slice(1,args.length)));cov_1g58kes9fv().s[9]++;_logger.default.debug.apply(_logger.default,message);}cov_1g58kes9fv().s[10]++;const isValidTTL=ttl=>{cov_1g58kes9fv().f[2]++;cov_1g58kes9fv().s[11]++;return(cov_1g58kes9fv().b[2][0]++,typeof ttl==='number')&&(cov_1g58kes9fv().b[2][1]++,ttl>0);};class RedisCacheAdapter{constructor(redisCtx,ttl=(cov_1g58kes9fv().b[3][0]++,DEFAULT_REDIS_TTL)){cov_1g58kes9fv().f[3]++;cov_1g58kes9fv().s[12]++;this.ttl=isValidTTL(ttl)?(cov_1g58kes9fv().b[4][0]++,ttl):(cov_1g58kes9fv().b[4][1]++,DEFAULT_REDIS_TTL);cov_1g58kes9fv().s[13]++;this.client=_redis.default.createClient(redisCtx);cov_1g58kes9fv().s[14]++;this.queue=new _KeyPromiseQueue.KeyPromiseQueue();}handleShutdown(){cov_1g58kes9fv().f[4]++;cov_1g58kes9fv().s[15]++;if(!this.client){cov_1g58kes9fv().b[5][0]++;cov_1g58kes9fv().s[16]++;return Promise.resolve();}else{cov_1g58kes9fv().b[5][1]++;}cov_1g58kes9fv().s[17]++;return new Promise(resolve=>{cov_1g58kes9fv().f[5]++;cov_1g58kes9fv().s[18]++;this.client.quit(err=>{cov_1g58kes9fv().f[6]++;cov_1g58kes9fv().s[19]++;if(err){cov_1g58kes9fv().b[6][0]++;cov_1g58kes9fv().s[20]++;_logger.default.error('RedisCacheAdapter error on shutdown',{error:err});}else{cov_1g58kes9fv().b[6][1]++;}cov_1g58kes9fv().s[21]++;resolve();});});}get(key){cov_1g58kes9fv().f[7]++;cov_1g58kes9fv().s[22]++;debug('get',{key});cov_1g58kes9fv().s[23]++;return this.queue.enqueue(key,()=>{cov_1g58kes9fv().f[8]++;cov_1g58kes9fv().s[24]++;return new Promise(resolve=>{cov_1g58kes9fv().f[9]++;cov_1g58kes9fv().s[25]++;this.client.get(key,function(err,res){cov_1g58kes9fv().f[10]++;cov_1g58kes9fv().s[26]++;debug('-> get',{key,res});cov_1g58kes9fv().s[27]++;if(!res){cov_1g58kes9fv().b[7][0]++;cov_1g58kes9fv().s[28]++;return resolve(null);}else{cov_1g58kes9fv().b[7][1]++;}cov_1g58kes9fv().s[29]++;resolve(JSON.parse(res));});});});}put(key,value,ttl=(cov_1g58kes9fv().b[8][0]++,this.ttl)){cov_1g58kes9fv().f[11]++;cov_1g58kes9fv().s[30]++;value=JSON.stringify(value);cov_1g58kes9fv().s[31]++;debug('put',{key,value,ttl});cov_1g58kes9fv().s[32]++;if(ttl===0){cov_1g58kes9fv().b[9][0]++;cov_1g58kes9fv().s[33]++;// ttl of zero is a logical no-op, but redis cannot set expire time of zero
return this.queue.enqueue(key,()=>{cov_1g58kes9fv().f[12]++;cov_1g58kes9fv().s[34]++;return Promise.resolve();});}else{cov_1g58kes9fv().b[9][1]++;}cov_1g58kes9fv().s[35]++;if(ttl===Infinity){cov_1g58kes9fv().b[10][0]++;cov_1g58kes9fv().s[36]++;return this.queue.enqueue(key,()=>{cov_1g58kes9fv().f[13]++;cov_1g58kes9fv().s[37]++;return new Promise(resolve=>{cov_1g58kes9fv().f[14]++;cov_1g58kes9fv().s[38]++;this.client.set(key,value,function(){cov_1g58kes9fv().f[15]++;cov_1g58kes9fv().s[39]++;resolve();});});});}else{cov_1g58kes9fv().b[10][1]++;}cov_1g58kes9fv().s[40]++;if(!isValidTTL(ttl)){cov_1g58kes9fv().b[11][0]++;cov_1g58kes9fv().s[41]++;ttl=this.ttl;}else{cov_1g58kes9fv().b[11][1]++;}cov_1g58kes9fv().s[42]++;return this.queue.enqueue(key,()=>{cov_1g58kes9fv().f[16]++;cov_1g58kes9fv().s[43]++;return new Promise(resolve=>{cov_1g58kes9fv().f[17]++;cov_1g58kes9fv().s[44]++;this.client.psetex(key,ttl,value,function(){cov_1g58kes9fv().f[18]++;cov_1g58kes9fv().s[45]++;resolve();});});});}del(key){cov_1g58kes9fv().f[19]++;cov_1g58kes9fv().s[46]++;debug('del',{key});cov_1g58kes9fv().s[47]++;return this.queue.enqueue(key,()=>{cov_1g58kes9fv().f[20]++;cov_1g58kes9fv().s[48]++;return new Promise(resolve=>{cov_1g58kes9fv().f[21]++;cov_1g58kes9fv().s[49]++;this.client.del(key,function(){cov_1g58kes9fv().f[22]++;cov_1g58kes9fv().s[50]++;resolve();});});});}clear(){cov_1g58kes9fv().f[23]++;cov_1g58kes9fv().s[51]++;debug('clear');cov_1g58kes9fv().s[52]++;return this.queue.enqueue(FLUSH_DB_KEY,()=>{cov_1g58kes9fv().f[24]++;cov_1g58kes9fv().s[53]++;return new Promise(resolve=>{cov_1g58kes9fv().f[25]++;cov_1g58kes9fv().s[54]++;this.client.flushdb(function(){cov_1g58kes9fv().f[26]++;cov_1g58kes9fv().s[55]++;resolve();});});});}// Used for testing
async getAllKeys(){cov_1g58kes9fv().f[27]++;cov_1g58kes9fv().s[56]++;return new Promise((resolve,reject)=>{cov_1g58kes9fv().f[28]++;cov_1g58kes9fv().s[57]++;this.client.keys('*',(err,keys)=>{cov_1g58kes9fv().f[29]++;cov_1g58kes9fv().s[58]++;if(err){cov_1g58kes9fv().b[12][0]++;cov_1g58kes9fv().s[59]++;reject(err);}else{cov_1g58kes9fv().b[12][1]++;cov_1g58kes9fv().s[60]++;resolve(keys);}});});}}cov_1g58kes9fv().s[61]++;exports.RedisCacheAdapter=RedisCacheAdapter;var _default=(cov_1g58kes9fv().s[62]++,RedisCacheAdapter);cov_1g58kes9fv().s[63]++;exports.default=_default;//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9BZGFwdGVycy9DYWNoZS9SZWRpc0NhY2hlQWRhcHRlci5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1JFRElTX1RUTCIsIkZMVVNIX0RCX0tFWSIsImRlYnVnIiwiYXJncyIsIm1lc3NhZ2UiLCJhcmd1bWVudHMiLCJjb25jYXQiLCJzbGljZSIsImxlbmd0aCIsImxvZ2dlciIsImFwcGx5IiwiaXNWYWxpZFRUTCIsInR0bCIsIlJlZGlzQ2FjaGVBZGFwdGVyIiwiY29uc3RydWN0b3IiLCJyZWRpc0N0eCIsImNsaWVudCIsInJlZGlzIiwiY3JlYXRlQ2xpZW50IiwicXVldWUiLCJLZXlQcm9taXNlUXVldWUiLCJoYW5kbGVTaHV0ZG93biIsIlByb21pc2UiLCJyZXNvbHZlIiwicXVpdCIsImVyciIsImVycm9yIiwiZ2V0Iiwia2V5IiwiZW5xdWV1ZSIsInJlcyIsIkpTT04iLCJwYXJzZSIsInB1dCIsInZhbHVlIiwic3RyaW5naWZ5IiwiSW5maW5pdHkiLCJzZXQiLCJwc2V0ZXgiLCJkZWwiLCJjbGVhciIsImZsdXNoZGIiLCJnZXRBbGxLZXlzIiwicmVqZWN0Iiwia2V5cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOzs7O0FBRUEsTUFBTUEsaUJBQWlCLEdBQUcsS0FBSyxJQUEvQixDLENBQXFDOztBQUNyQyxNQUFNQyxZQUFZLEdBQUcsY0FBckI7O0FBRUEsU0FBU0MsS0FBVCxDQUFlLEdBQUdDLElBQWxCLEVBQTZCO0FBQzNCLFFBQU1DLE9BQU8sR0FBRyxDQUFDLHdCQUF3QkMsU0FBUyxDQUFDLENBQUQsQ0FBbEMsRUFBdUNDLE1BQXZDLENBQThDSCxJQUFJLENBQUNJLEtBQUwsQ0FBVyxDQUFYLEVBQWNKLElBQUksQ0FBQ0ssTUFBbkIsQ0FBOUMsQ0FBaEI7O0FBQ0FDLGtCQUFPUCxLQUFQLENBQWFRLEtBQWIsQ0FBbUJELGVBQW5CLEVBQTJCTCxPQUEzQjtBQUNEOztBQUVELE1BQU1PLFVBQVUsR0FBR0MsR0FBRyxJQUFJLE9BQU9BLEdBQVAsS0FBZSxRQUFmLElBQTJCQSxHQUFHLEdBQUcsQ0FBM0Q7O0FBRU8sTUFBTUMsaUJBQU4sQ0FBd0I7QUFDN0JDLEVBQUFBLFdBQVcsQ0FBQ0MsUUFBRCxFQUFXSCxHQUFHLEdBQUdaLGlCQUFqQixFQUFvQztBQUM3QyxTQUFLWSxHQUFMLEdBQVdELFVBQVUsQ0FBQ0MsR0FBRCxDQUFWLEdBQWtCQSxHQUFsQixHQUF3QlosaUJBQW5DO0FBQ0EsU0FBS2dCLE1BQUwsR0FBY0MsZUFBTUMsWUFBTixDQUFtQkgsUUFBbkIsQ0FBZDtBQUNBLFNBQUtJLEtBQUwsR0FBYSxJQUFJQyxnQ0FBSixFQUFiO0FBQ0Q7O0FBRURDLEVBQUFBLGNBQWMsR0FBRztBQUNmLFFBQUksQ0FBQyxLQUFLTCxNQUFWLEVBQWtCO0FBQ2hCLGFBQU9NLE9BQU8sQ0FBQ0MsT0FBUixFQUFQO0FBQ0Q7O0FBQ0QsV0FBTyxJQUFJRCxPQUFKLENBQVlDLE9BQU8sSUFBSTtBQUM1QixXQUFLUCxNQUFMLENBQVlRLElBQVosQ0FBaUJDLEdBQUcsSUFBSTtBQUN0QixZQUFJQSxHQUFKLEVBQVM7QUFDUGhCLDBCQUFPaUIsS0FBUCxDQUFhLHFDQUFiLEVBQW9EO0FBQUVBLFlBQUFBLEtBQUssRUFBRUQ7QUFBVCxXQUFwRDtBQUNEOztBQUNERixRQUFBQSxPQUFPO0FBQ1IsT0FMRDtBQU1ELEtBUE0sQ0FBUDtBQVFEOztBQUVESSxFQUFBQSxHQUFHLENBQUNDLEdBQUQsRUFBTTtBQUNQMUIsSUFBQUEsS0FBSyxDQUFDLEtBQUQsRUFBUTtBQUFFMEIsTUFBQUE7QUFBRixLQUFSLENBQUw7QUFDQSxXQUFPLEtBQUtULEtBQUwsQ0FBV1UsT0FBWCxDQUNMRCxHQURLLEVBRUwsTUFDRSxJQUFJTixPQUFKLENBQVlDLE9BQU8sSUFBSTtBQUNyQixXQUFLUCxNQUFMLENBQVlXLEdBQVosQ0FBZ0JDLEdBQWhCLEVBQXFCLFVBQVVILEdBQVYsRUFBZUssR0FBZixFQUFvQjtBQUN2QzVCLFFBQUFBLEtBQUssQ0FBQyxRQUFELEVBQVc7QUFBRTBCLFVBQUFBLEdBQUY7QUFBT0UsVUFBQUE7QUFBUCxTQUFYLENBQUw7O0FBQ0EsWUFBSSxDQUFDQSxHQUFMLEVBQVU7QUFDUixpQkFBT1AsT0FBTyxDQUFDLElBQUQsQ0FBZDtBQUNEOztBQUNEQSxRQUFBQSxPQUFPLENBQUNRLElBQUksQ0FBQ0MsS0FBTCxDQUFXRixHQUFYLENBQUQsQ0FBUDtBQUNELE9BTkQ7QUFPRCxLQVJELENBSEcsQ0FBUDtBQWFEOztBQUVERyxFQUFBQSxHQUFHLENBQUNMLEdBQUQsRUFBTU0sS0FBTixFQUFhdEIsR0FBRyxHQUFHLEtBQUtBLEdBQXhCLEVBQTZCO0FBQzlCc0IsSUFBQUEsS0FBSyxHQUFHSCxJQUFJLENBQUNJLFNBQUwsQ0FBZUQsS0FBZixDQUFSO0FBQ0FoQyxJQUFBQSxLQUFLLENBQUMsS0FBRCxFQUFRO0FBQUUwQixNQUFBQSxHQUFGO0FBQU9NLE1BQUFBLEtBQVA7QUFBY3RCLE1BQUFBO0FBQWQsS0FBUixDQUFMOztBQUVBLFFBQUlBLEdBQUcsS0FBSyxDQUFaLEVBQWU7QUFDYjtBQUNBLGFBQU8sS0FBS08sS0FBTCxDQUFXVSxPQUFYLENBQW1CRCxHQUFuQixFQUF3QixNQUFNTixPQUFPLENBQUNDLE9BQVIsRUFBOUIsQ0FBUDtBQUNEOztBQUVELFFBQUlYLEdBQUcsS0FBS3dCLFFBQVosRUFBc0I7QUFDcEIsYUFBTyxLQUFLakIsS0FBTCxDQUFXVSxPQUFYLENBQ0xELEdBREssRUFFTCxNQUNFLElBQUlOLE9BQUosQ0FBWUMsT0FBTyxJQUFJO0FBQ3JCLGFBQUtQLE1BQUwsQ0FBWXFCLEdBQVosQ0FBZ0JULEdBQWhCLEVBQXFCTSxLQUFyQixFQUE0QixZQUFZO0FBQ3RDWCxVQUFBQSxPQUFPO0FBQ1IsU0FGRDtBQUdELE9BSkQsQ0FIRyxDQUFQO0FBU0Q7O0FBRUQsUUFBSSxDQUFDWixVQUFVLENBQUNDLEdBQUQsQ0FBZixFQUFzQjtBQUNwQkEsTUFBQUEsR0FBRyxHQUFHLEtBQUtBLEdBQVg7QUFDRDs7QUFFRCxXQUFPLEtBQUtPLEtBQUwsQ0FBV1UsT0FBWCxDQUNMRCxHQURLLEVBRUwsTUFDRSxJQUFJTixPQUFKLENBQVlDLE9BQU8sSUFBSTtBQUNyQixXQUFLUCxNQUFMLENBQVlzQixNQUFaLENBQW1CVixHQUFuQixFQUF3QmhCLEdBQXhCLEVBQTZCc0IsS0FBN0IsRUFBb0MsWUFBWTtBQUM5Q1gsUUFBQUEsT0FBTztBQUNSLE9BRkQ7QUFHRCxLQUpELENBSEcsQ0FBUDtBQVNEOztBQUVEZ0IsRUFBQUEsR0FBRyxDQUFDWCxHQUFELEVBQU07QUFDUDFCLElBQUFBLEtBQUssQ0FBQyxLQUFELEVBQVE7QUFBRTBCLE1BQUFBO0FBQUYsS0FBUixDQUFMO0FBQ0EsV0FBTyxLQUFLVCxLQUFMLENBQVdVLE9BQVgsQ0FDTEQsR0FESyxFQUVMLE1BQ0UsSUFBSU4sT0FBSixDQUFZQyxPQUFPLElBQUk7QUFDckIsV0FBS1AsTUFBTCxDQUFZdUIsR0FBWixDQUFnQlgsR0FBaEIsRUFBcUIsWUFBWTtBQUMvQkwsUUFBQUEsT0FBTztBQUNSLE9BRkQ7QUFHRCxLQUpELENBSEcsQ0FBUDtBQVNEOztBQUVEaUIsRUFBQUEsS0FBSyxHQUFHO0FBQ050QyxJQUFBQSxLQUFLLENBQUMsT0FBRCxDQUFMO0FBQ0EsV0FBTyxLQUFLaUIsS0FBTCxDQUFXVSxPQUFYLENBQ0w1QixZQURLLEVBRUwsTUFDRSxJQUFJcUIsT0FBSixDQUFZQyxPQUFPLElBQUk7QUFDckIsV0FBS1AsTUFBTCxDQUFZeUIsT0FBWixDQUFvQixZQUFZO0FBQzlCbEIsUUFBQUEsT0FBTztBQUNSLE9BRkQ7QUFHRCxLQUpELENBSEcsQ0FBUDtBQVNELEdBbEc0QixDQW9HN0I7OztBQUNnQixRQUFWbUIsVUFBVSxHQUFHO0FBQ2pCLFdBQU8sSUFBSXBCLE9BQUosQ0FBWSxDQUFDQyxPQUFELEVBQVVvQixNQUFWLEtBQXFCO0FBQ3RDLFdBQUszQixNQUFMLENBQVk0QixJQUFaLENBQWlCLEdBQWpCLEVBQXNCLENBQUNuQixHQUFELEVBQU1tQixJQUFOLEtBQWU7QUFDbkMsWUFBSW5CLEdBQUosRUFBUztBQUNQa0IsVUFBQUEsTUFBTSxDQUFDbEIsR0FBRCxDQUFOO0FBQ0QsU0FGRCxNQUVPO0FBQ0xGLFVBQUFBLE9BQU8sQ0FBQ3FCLElBQUQsQ0FBUDtBQUNEO0FBQ0YsT0FORDtBQU9ELEtBUk0sQ0FBUDtBQVNEOztBQS9HNEI7OztlQWtIaEIvQixpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZWRpcyBmcm9tICdyZWRpcyc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4uLy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBLZXlQcm9taXNlUXVldWUgfSBmcm9tICcuLi8uLi9LZXlQcm9taXNlUXVldWUnO1xuXG5jb25zdCBERUZBVUxUX1JFRElTX1RUTCA9IDMwICogMTAwMDsgLy8gMzAgc2Vjb25kcyBpbiBtaWxsaXNlY29uZHNcbmNvbnN0IEZMVVNIX0RCX0tFWSA9ICdfX2ZsdXNoX2RiX18nO1xuXG5mdW5jdGlvbiBkZWJ1ZyguLi5hcmdzOiBhbnkpIHtcbiAgY29uc3QgbWVzc2FnZSA9IFsnUmVkaXNDYWNoZUFkYXB0ZXI6ICcgKyBhcmd1bWVudHNbMF1dLmNvbmNhdChhcmdzLnNsaWNlKDEsIGFyZ3MubGVuZ3RoKSk7XG4gIGxvZ2dlci5kZWJ1Zy5hcHBseShsb2dnZXIsIG1lc3NhZ2UpO1xufVxuXG5jb25zdCBpc1ZhbGlkVFRMID0gdHRsID0+IHR5cGVvZiB0dGwgPT09ICdudW1iZXInICYmIHR0bCA+IDA7XG5cbmV4cG9ydCBjbGFzcyBSZWRpc0NhY2hlQWRhcHRlciB7XG4gIGNvbnN0cnVjdG9yKHJlZGlzQ3R4LCB0dGwgPSBERUZBVUxUX1JFRElTX1RUTCkge1xuICAgIHRoaXMudHRsID0gaXNWYWxpZFRUTCh0dGwpID8gdHRsIDogREVGQVVMVF9SRURJU19UVEw7XG4gICAgdGhpcy5jbGllbnQgPSByZWRpcy5jcmVhdGVDbGllbnQocmVkaXNDdHgpO1xuICAgIHRoaXMucXVldWUgPSBuZXcgS2V5UHJvbWlzZVF1ZXVlKCk7XG4gIH1cblxuICBoYW5kbGVTaHV0ZG93bigpIHtcbiAgICBpZiAoIXRoaXMuY2xpZW50KSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgIHRoaXMuY2xpZW50LnF1aXQoZXJyID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIGxvZ2dlci5lcnJvcignUmVkaXNDYWNoZUFkYXB0ZXIgZXJyb3Igb24gc2h1dGRvd24nLCB7IGVycm9yOiBlcnIgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBnZXQoa2V5KSB7XG4gICAgZGVidWcoJ2dldCcsIHsga2V5IH0pO1xuICAgIHJldHVybiB0aGlzLnF1ZXVlLmVucXVldWUoXG4gICAgICBrZXksXG4gICAgICAoKSA9PlxuICAgICAgICBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgICB0aGlzLmNsaWVudC5nZXQoa2V5LCBmdW5jdGlvbiAoZXJyLCByZXMpIHtcbiAgICAgICAgICAgIGRlYnVnKCctPiBnZXQnLCB7IGtleSwgcmVzIH0pO1xuICAgICAgICAgICAgaWYgKCFyZXMpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUobnVsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXNvbHZlKEpTT04ucGFyc2UocmVzKSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHB1dChrZXksIHZhbHVlLCB0dGwgPSB0aGlzLnR0bCkge1xuICAgIHZhbHVlID0gSlNPTi5zdHJpbmdpZnkodmFsdWUpO1xuICAgIGRlYnVnKCdwdXQnLCB7IGtleSwgdmFsdWUsIHR0bCB9KTtcblxuICAgIGlmICh0dGwgPT09IDApIHtcbiAgICAgIC8vIHR0bCBvZiB6ZXJvIGlzIGEgbG9naWNhbCBuby1vcCwgYnV0IHJlZGlzIGNhbm5vdCBzZXQgZXhwaXJlIHRpbWUgb2YgemVyb1xuICAgICAgcmV0dXJuIHRoaXMucXVldWUuZW5xdWV1ZShrZXksICgpID0+IFByb21pc2UucmVzb2x2ZSgpKTtcbiAgICB9XG5cbiAgICBpZiAodHRsID09PSBJbmZpbml0eSkge1xuICAgICAgcmV0dXJuIHRoaXMucXVldWUuZW5xdWV1ZShcbiAgICAgICAga2V5LFxuICAgICAgICAoKSA9PlxuICAgICAgICAgIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgICAgdGhpcy5jbGllbnQuc2V0KGtleSwgdmFsdWUsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKCFpc1ZhbGlkVFRMKHR0bCkpIHtcbiAgICAgIHR0bCA9IHRoaXMudHRsO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnF1ZXVlLmVucXVldWUoXG4gICAgICBrZXksXG4gICAgICAoKSA9PlxuICAgICAgICBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgICB0aGlzLmNsaWVudC5wc2V0ZXgoa2V5LCB0dGwsIHZhbHVlLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIGRlbChrZXkpIHtcbiAgICBkZWJ1ZygnZGVsJywgeyBrZXkgfSk7XG4gICAgcmV0dXJuIHRoaXMucXVldWUuZW5xdWV1ZShcbiAgICAgIGtleSxcbiAgICAgICgpID0+XG4gICAgICAgIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgIHRoaXMuY2xpZW50LmRlbChrZXksIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgY2xlYXIoKSB7XG4gICAgZGVidWcoJ2NsZWFyJyk7XG4gICAgcmV0dXJuIHRoaXMucXVldWUuZW5xdWV1ZShcbiAgICAgIEZMVVNIX0RCX0tFWSxcbiAgICAgICgpID0+XG4gICAgICAgIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgIHRoaXMuY2xpZW50LmZsdXNoZGIoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgICk7XG4gIH1cblxuICAvLyBVc2VkIGZvciB0ZXN0aW5nXG4gIGFzeW5jIGdldEFsbEtleXMoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuY2xpZW50LmtleXMoJyonLCAoZXJyLCBrZXlzKSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXNvbHZlKGtleXMpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBSZWRpc0NhY2hlQWRhcHRlcjtcbiJdfQ==
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9BZGFwdGVycy9DYWNoZS9SZWRpc0NhY2hlQWRhcHRlci5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1JFRElTX1RUTCIsIkZMVVNIX0RCX0tFWSIsIm1lc3NhZ2UiLCJhcmd1bWVudHMiLCJhcmdzIiwibG9nZ2VyIiwiaXNWYWxpZFRUTCIsInR0bCIsImNvbnN0cnVjdG9yIiwicmVkaXMiLCJLZXlQcm9taXNlUXVldWUiLCJoYW5kbGVTaHV0ZG93biIsIlByb21pc2UiLCJyZXNvbHZlIiwiZXJyIiwiZXJyb3IiLCJnZXQiLCJkZWJ1ZyIsImtleSIsInJlcyIsIkpTT04iLCJwdXQiLCJ2YWx1ZSIsImRlbCIsImNsZWFyIiwiZ2V0QWxsS2V5cyIsInJlamVjdCIsIlJlZGlzQ2FjaGVBZGFwdGVyIl0sIm1hcHBpbmdzIjoidzBrQkFJTUE7cVBBSk4sR0FBQSxDQUFBLE1BQUEsMEJBQUEsc0JBQUEsQ0FBQSxPQUFBLENBQUEsT0FBQSxDQUFBLENBQUEsQ0FBQSxDQUNBLEdBQUEsQ0FBQSxPQUFBLDBCQUFBLHNCQUFBLENBQUEsT0FBQSxDQUFBLGNBQUEsQ0FBQSxDQUFBLENBQUEsQ0FDQSxHQUFBLENBQUEsZ0JBQUEsMEJBQUEsT0FBQSxDQUFBLHVCQUFBLENBQUEsQ0FBQSxDLHNQQUVBLEtBQU1BLENBQUFBLGlCQUFpQiwwQkFBRyxHQUExQixJQUF1QixDQUF2QixDQUFxQztBQUNyQyxLQUFNQyxDQUFBQSxZQUFZLDBCQUFsQixjQUFrQixDQUFsQixDQUVBLFFBQUEsQ0FBQSxLQUFBLENBQWUsR0FBZixJQUFBLENBQTZCLHlCQUMzQixLQUFNQyxDQUFBQSxPQUFPLDBCQUFHLENBQUMsc0JBQXdCQyxTQUFTLENBQWxDLENBQWtDLENBQWxDLEVBQUEsTUFBQSxDQUE4Q0MsSUFBSSxDQUFKQSxLQUFBQSxDQUFBQSxDQUFBQSxDQUFjQSxJQUFJLENBQWhGLE1BQThEQSxDQUE5QyxDQUFILENBQWIsQ0FEMkIsd0JBRTNCQyxPQUFBQSxDQUFBQSxP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QW9HN0I7QUFDZ0IsS0FBVlksQ0FBQUEsVUFBVSxFQUFHLG1EQUNqQixNQUFPLElBQUEsQ0FBQSxPQUFBLENBQVksQ0FBQSxPQUFBLENBQUEsTUFBQSxHQUFxQixtREFDdEMsS0FBQSxNQUFBLENBQUEsSUFBQSxDQUFBLEdBQUEsQ0FBc0IsQ0FBQSxHQUFBLENBQUEsSUFBQSxHQUFlLG1EQUNuQyxHQUFBLEdBQUEsQ0FBUyxzREFDUEMsTUFBTSxDQUFOQSxHQUFNLENBQU5BLENBREYsQ0FBQSxJQUVPLHNEQUNMYixPQUFPLENBQVBBLElBQU8sQ0FBUEEsQ0FDRCxDQUxILENBQUEsRUFERixDQUFPLENBQVAsQ0FTRCxDQS9HNEIsQyw0R0FrSGhCYyxpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZWRpcyBmcm9tICdyZWRpcyc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4uLy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBLZXlQcm9taXNlUXVldWUgfSBmcm9tICcuLi8uLi9LZXlQcm9taXNlUXVldWUnO1xuXG5jb25zdCBERUZBVUxUX1JFRElTX1RUTCA9IDMwICogMTAwMDsgLy8gMzAgc2Vjb25kcyBpbiBtaWxsaXNlY29uZHNcbmNvbnN0IEZMVVNIX0RCX0tFWSA9ICdfX2ZsdXNoX2RiX18nO1xuXG5mdW5jdGlvbiBkZWJ1ZyguLi5hcmdzOiBhbnkpIHtcbiAgY29uc3QgbWVzc2FnZSA9IFsnUmVkaXNDYWNoZUFkYXB0ZXI6ICcgKyBhcmd1bWVudHNbMF1dLmNvbmNhdChhcmdzLnNsaWNlKDEsIGFyZ3MubGVuZ3RoKSk7XG4gIGxvZ2dlci5kZWJ1Zy5hcHBseShsb2dnZXIsIG1lc3NhZ2UpO1xufVxuXG5jb25zdCBpc1ZhbGlkVFRMID0gdHRsID0+IHR5cGVvZiB0dGwgPT09ICdudW1iZXInICYmIHR0bCA+IDA7XG5cbmV4cG9ydCBjbGFzcyBSZWRpc0NhY2hlQWRhcHRlciB7XG4gIGNvbnN0cnVjdG9yKHJlZGlzQ3R4LCB0dGwgPSBERUZBVUxUX1JFRElTX1RUTCkge1xuICAgIHRoaXMudHRsID0gaXNWYWxpZFRUTCh0dGwpID8gdHRsIDogREVGQVVMVF9SRURJU19UVEw7XG4gICAgdGhpcy5jbGllbnQgPSByZWRpcy5jcmVhdGVDbGllbnQocmVkaXNDdHgpO1xuICAgIHRoaXMucXVldWUgPSBuZXcgS2V5UHJvbWlzZVF1ZXVlKCk7XG4gIH1cblxuICBoYW5kbGVTaHV0ZG93bigpIHtcbiAgICBpZiAoIXRoaXMuY2xpZW50KSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgIHRoaXMuY2xpZW50LnF1aXQoZXJyID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIGxvZ2dlci5lcnJvcignUmVkaXNDYWNoZUFkYXB0ZXIgZXJyb3Igb24gc2h1dGRvd24nLCB7IGVycm9yOiBlcnIgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBnZXQoa2V5KSB7XG4gICAgZGVidWcoJ2dldCcsIHsga2V5IH0pO1xuICAgIHJldHVybiB0aGlzLnF1ZXVlLmVucXVldWUoXG4gICAgICBrZXksXG4gICAgICAoKSA9PlxuICAgICAgICBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgICB0aGlzLmNsaWVudC5nZXQoa2V5LCBmdW5jdGlvbiAoZXJyLCByZXMpIHtcbiAgICAgICAgICAgIGRlYnVnKCctPiBnZXQnLCB7IGtleSwgcmVzIH0pO1xuICAgICAgICAgICAgaWYgKCFyZXMpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUobnVsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXNvbHZlKEpTT04ucGFyc2UocmVzKSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHB1dChrZXksIHZhbHVlLCB0dGwgPSB0aGlzLnR0bCkge1xuICAgIHZhbHVlID0gSlNPTi5zdHJpbmdpZnkodmFsdWUpO1xuICAgIGRlYnVnKCdwdXQnLCB7IGtleSwgdmFsdWUsIHR0bCB9KTtcblxuICAgIGlmICh0dGwgPT09IDApIHtcbiAgICAgIC8vIHR0bCBvZiB6ZXJvIGlzIGEgbG9naWNhbCBuby1vcCwgYnV0IHJlZGlzIGNhbm5vdCBzZXQgZXhwaXJlIHRpbWUgb2YgemVyb1xuICAgICAgcmV0dXJuIHRoaXMucXVldWUuZW5xdWV1ZShrZXksICgpID0+IFByb21pc2UucmVzb2x2ZSgpKTtcbiAgICB9XG5cbiAgICBpZiAodHRsID09PSBJbmZpbml0eSkge1xuICAgICAgcmV0dXJuIHRoaXMucXVldWUuZW5xdWV1ZShcbiAgICAgICAga2V5LFxuICAgICAgICAoKSA9PlxuICAgICAgICAgIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgICAgdGhpcy5jbGllbnQuc2V0KGtleSwgdmFsdWUsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKCFpc1ZhbGlkVFRMKHR0bCkpIHtcbiAgICAgIHR0bCA9IHRoaXMudHRsO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnF1ZXVlLmVucXVldWUoXG4gICAgICBrZXksXG4gICAgICAoKSA9PlxuICAgICAgICBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgICB0aGlzLmNsaWVudC5wc2V0ZXgoa2V5LCB0dGwsIHZhbHVlLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIGRlbChrZXkpIHtcbiAgICBkZWJ1ZygnZGVsJywgeyBrZXkgfSk7XG4gICAgcmV0dXJuIHRoaXMucXVldWUuZW5xdWV1ZShcbiAgICAgIGtleSxcbiAgICAgICgpID0+XG4gICAgICAgIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgIHRoaXMuY2xpZW50LmRlbChrZXksIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgY2xlYXIoKSB7XG4gICAgZGVidWcoJ2NsZWFyJyk7XG4gICAgcmV0dXJuIHRoaXMucXVldWUuZW5xdWV1ZShcbiAgICAgIEZMVVNIX0RCX0tFWSxcbiAgICAgICgpID0+XG4gICAgICAgIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgIHRoaXMuY2xpZW50LmZsdXNoZGIoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgICk7XG4gIH1cblxuICAvLyBVc2VkIGZvciB0ZXN0aW5nXG4gIGFzeW5jIGdldEFsbEtleXMoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuY2xpZW50LmtleXMoJyonLCAoZXJyLCBrZXlzKSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXNvbHZlKGtleXMpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBSZWRpc0NhY2hlQWRhcHRlcjtcbiJdfQ==